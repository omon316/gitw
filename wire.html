<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST IN THE WIRES 112.5 (Privacy Edition)</title>
    <style>
        :root { --bg: #0b0c0e; --card: #15171a; --text: #e4e6eb; --text-dim: #9aa0a6; --accent: #2d88ff; --danger: #f02849; --success: #00e676; --warn: #fbc02d; --border: #2f3031; }
        body { background:var(--bg); color:var(--text); font-family:'Segoe UI', monospace; margin:0; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
        
        header { background:var(--card); height:50px; padding:0 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #333; z-index:10; }
        .brand { font-size:18px; font-weight:bold; letter-spacing:2px; text-transform: uppercase; } 
        .brand span { color:var(--accent); }

        .workspace { display:flex; flex:1; overflow:hidden; }
        .sidebar { width:260px; background:#111; border-right:1px solid #333; display:flex; flex-direction:column; padding:10px 0; overflow-y:auto; }
        .main { flex:1; padding:30px; overflow-y:auto; display:none; }
        .main.active { display:block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        .nav-btn { background:transparent; border:none; color:var(--text-dim); text-align:left; padding:12px 20px; cursor:pointer; font-size:14px; border-left:3px solid transparent; width:100%; box-sizing:border-box; }
        .nav-btn:hover { background:#1f1f1f; color:var(--text); }
        .nav-btn.active { background:rgba(45, 136, 255, 0.1); color:var(--accent); border-left-color:var(--accent); }
        .nav-sep { flex:1; } .nav-bottom { border-top:1px solid #333; margin-top:10px; padding-top:10px; }

        .card { background:var(--card); padding:20px; border-radius:6px; margin-bottom:20px; border:1px solid #333; position: relative; }
        .card h3 { margin:0 0 10px 0; font-size:16px; color:var(--text); border-bottom:1px solid #333; padding-bottom:10px; }
        .expl { font-size: 11px; color: #888; margin-bottom: 15px; line-height: 1.5; border-left: 3px solid #444; padding-left: 10px; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 0 4px 4px 0; }
        .db-hint { font-size: 11px; color: var(--accent); margin-bottom: 10px; padding: 8px; background: rgba(45, 136, 255, 0.1); border-radius: 4px; border: 1px solid rgba(45, 136, 255, 0.3); }

        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
        
        button { background:#1a4d8c; color:white; border:1px solid var(--accent); padding:6px 12px; cursor:pointer; border-radius:3px; font-size:12px; }
        button:hover { background:var(--accent); }
        button.danger { border-color:var(--danger); color:var(--danger); background:transparent; }
        button.danger:hover { background:var(--danger); color:white; }
        button.success { border-color:var(--success); color:var(--success); background:transparent; }
        button.success:hover { background:var(--success); color:black; }
        button.small { padding:2px 6px; font-size:10px; }
        button.grey { background:#333; border-color:#555; color:#ccc; }
        
        input, select, textarea { background:black; border:1px solid #444; color:white; padding:8px; width:100%; box-sizing:border-box; border-radius:3px; font-family:inherit; margin-bottom:5px; }
        input:focus { border-color:var(--accent); outline:none; }
        
        .gen-row { display:flex; gap:10px; align-items:center; background:#1a1a1a; padding:8px; border-radius:4px; margin-bottom:5px; }
        input[type=range] { height:4px; -webkit-appearance:none; background:#444; border-radius:2px; padding:0; margin:0; width:100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:12px; height:12px; background:var(--accent); border-radius:50%; cursor:pointer; }
        
        .help-text { font-size:9px; color:#888; display:flex; justify-content:space-between; margin-bottom:2px; margin-top:5px; }
        .slider-desc { font-size:10px; color:#666; margin-top:-2px; margin-bottom:12px; display:block; line-height:1.3; font-style: italic; }

        .data-table { width:100%; border-collapse:collapse; font-size:12px; }
        .data-table th { text-align:left; padding:10px; background:#222; position:sticky; top:0; cursor: pointer; user-select: none; }
        .data-table th:hover { background:#333; color:var(--accent); }
        .data-table td { padding:8px 10px; border-bottom:1px solid #333; }
        .data-table tr:hover { background:#222; cursor:pointer; }
        .sort-icon { font-size: 10px; margin-left: 5px; color: var(--accent); }
        
        .pie-wrapper { display:flex; align-items:center; gap:30px; }
        .pie-legend { display:flex; flex-direction:column; gap:5px; font-size:12px; }
        .legend-item { display:flex; align-items:center; gap:8px; }
        .dot { width:10px; height:10px; border-radius:50%; }
        
        .stat-list { font-size:13px; }
        .stat-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #222; }
        .stat-val { font-weight:bold; color:var(--accent); }
        .stat-risk { color:var(--danger); }

        .stack-bar-container { margin-bottom:10px; }
        .stack-label { font-size:11px; margin-bottom:2px; color:#ccc; }
        .stack-bar { width:100%; height:20px; background:#333; display:flex; border-radius:2px; overflow:hidden; }
        .stack-seg { height:100%; }

        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:none; justify-content:center; align-items:center; }
        #user-detail-modal { z-index: 2000; }
        .modal { background:var(--card); width:800px; max-height:90vh; overflow-y:auto; border:1px solid var(--accent); padding:0; box-shadow:0 0 50px black; }
        .modal-header { background:#111; padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:20px; }
        .post-edit-row { display:flex; gap:10px; margin-bottom:5px; border-bottom:1px solid #333; padding-bottom:5px; align-items: center; }
        .detail-item { background:#222; border-left:3px solid var(--accent); padding:8px; margin-bottom:5px; font-size:11px; display:flex; justify-content:space-between; align-items:flex-start; position: relative; }
        .city-item { background:#1f1f1f; padding:10px; border-radius:4px; margin-bottom:10px; border-left:3px solid var(--accent); }
        .risk-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
        .dot-low { background:var(--success); box-shadow:0 0 5px var(--success); }
        .dot-mid { background:var(--warn); box-shadow:0 0 5px var(--warn); }
        .dot-high { background:var(--danger); box-shadow:0 0 5px var(--danger); }
        .online-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
        .online-dot.online { background:var(--success); box-shadow:0 0 8px var(--success); animation: pulse-online 2s infinite; }
        .online-dot.offline { background:#555; }
        @keyframes pulse-online { 0%, 100% { opacity:1; } 50% { opacity:0.6; } }

        /* Benutzer-Detail-Modal Styles */
        .user-detail-section { background:#111; margin:0; padding:20px; border-bottom:1px solid #333; }
        .user-detail-section h4 { margin:0 0 15px 0; color:var(--accent); font-size:14px; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid #333; padding-bottom:8px; }
        .user-detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .user-detail-item { background:#1a1a1a; padding:10px; border-radius:4px; border-left:3px solid var(--accent); }
        .user-detail-item label { font-size:10px; color:#888; text-transform:uppercase; display:block; margin-bottom:3px; }
        .user-detail-item span { font-size:13px; color:#fff; word-break:break-all; }
        .user-detail-item.password span { font-family:monospace; background:#000; padding:3px 6px; border-radius:3px; color:var(--warn); }
        .activity-log-list { max-height:300px; overflow-y:auto; background:#0a0a0a; border:1px solid #333; border-radius:4px; }
        .activity-log-entry { padding:10px 15px; border-bottom:1px solid #222; font-size:12px; display:flex; gap:15px; align-items:flex-start; }
        .activity-log-entry:hover { background:#151515; }
        .activity-log-time { color:#666; font-family:monospace; min-width:140px; }
        .activity-log-action { color:var(--accent); font-weight:bold; min-width:150px; }
        .activity-log-details { color:#ccc; flex:1; }
        .chat-history-section { background:#0a0a0a; border:1px solid #333; border-radius:4px; margin-top:10px; }
        .chat-history-header { padding:10px 15px; background:#1a1a1a; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; }
        .chat-history-body { padding:10px; max-height:200px; overflow-y:auto; display:none; }
        .chat-history-body.open { display:block; }
        .chat-msg-row { padding:5px 10px; margin:3px 0; border-radius:4px; font-size:12px; }
        .chat-msg-row.sent { background:rgba(45, 136, 255, 0.2); margin-left:20%; text-align:right; }
        .chat-msg-row.received { background:#222; margin-right:20%; }
        .chat-msg-meta { font-size:10px; color:#666; margin-top:2px; }
        .clickable-profile { color:var(--accent); cursor:pointer; text-decoration:underline; transition:all 0.2s; }
        .clickable-profile:hover { color:#fff; background:var(--accent); padding:2px 6px; border-radius:3px; }

        /* Print-Only Header (versteckt im normalen Modus) */
        .print-only-header { display: none; }

        @page {
            margin-top: 100px;
            margin-bottom: 30px;
            @top-right {
                content: "Seite " counter(page) " von " counter(pages);
                font-size: 10px;
                color: #666;
            }
        }

        @media print {
            * { visibility: visible !important; }
            body { background: white !important; margin: 0 !important; padding: 0 !important; }

            /* Print Header - fixiert f√ºr jede Seite */
            .print-only-header {
                display: block !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: #1a1a2e !important;
                color: white !important;
                padding: 15px 20px !important;
                margin: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                z-index: 99999 !important;
            }
            .print-only-header .print-header-top {
                display: flex !important;
                align-items: baseline !important;
                justify-content: space-between !important;
                gap: 15px !important;
                margin-bottom: 10px !important;
            }
            .print-only-header .print-header-left {
                display: flex !important;
                align-items: baseline !important;
                gap: 15px !important;
            }
            .print-only-header .print-page-number {
                font-size: 11px !important;
                color: #ccc !important;
                text-align: right !important;
            }
            .print-only-header .print-logo {
                font-size: 20px !important;
                font-weight: bold !important;
                letter-spacing: 3px !important;
                color: white !important;
            }
            .print-only-header .print-protocol {
                font-size: 11px !important;
                color: #4da6ff !important;
                letter-spacing: 4px !important;
                border: 1px solid #4da6ff !important;
                padding: 2px 8px !important;
            }
            .print-only-header .print-header-info {
                display: flex !important;
                gap: 20px !important;
                font-size: 10px !important;
                color: #ccc !important;
            }
            .print-only-header .print-header-info strong {
                color: #888 !important;
                margin-right: 5px !important;
            }

            /* Platzhalter f√ºr den festen Header */
            .print-header-spacer {
                display: block !important;
                height: 85px !important;
            }

            /* Alles au√üer dem Modal verstecken */
            body > *:not(#user-detail-modal) { display: none !important; }

            #user-detail-modal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                overflow: visible !important;
            }
            #user-detail-modal .modal {
                position: static !important;
                width: 100% !important;
                max-width: 100% !important;
                max-height: none !important;
                height: auto !important;
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                background: white !important;
            }
            #user-detail-modal .modal-body {
                overflow: visible !important;
                max-height: none !important;
                height: auto !important;
                padding: 0 !important;
            }
            #user-detail-modal .modal-header { background: #eee !important; color: #000 !important; }
            #user-detail-modal .modal-header button { display: none !important; }
            #user-detail-modal .modal-header h3 { color: #000 !important; }

            #user-detail-modal .user-detail-section {
                background: #f9f9f9 !important;
                color: #000 !important;
                page-break-inside: avoid;
                border-bottom: 1px solid #ccc !important;
            }
            #user-detail-modal .user-detail-item { background: #fff !important; border-color: #007bff !important; }
            #user-detail-modal .user-detail-item span { color: #000 !important; }
            #user-detail-modal .user-detail-item label { color: #666 !important; }

            #user-detail-modal .activity-log-entry { color: #000 !important; background: #fff !important; border-bottom: 1px solid #eee !important; }
            #user-detail-modal .activity-log-time { color: #333 !important; }
            #user-detail-modal .activity-log-action { color: #007bff !important; }
            #user-detail-modal .activity-log-details { color: #000 !important; }
            #user-detail-modal .activity-log-list {
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
                background: #fff !important;
                border: 1px solid #ccc !important;
            }

            #user-detail-modal .chat-history-body {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            #user-detail-modal .chat-history-header { background: #eee !important; color: #000 !important; }
            #user-detail-modal .chat-history-section { page-break-inside: avoid; border: 1px solid #ccc !important; margin-bottom: 10px !important; }
            #user-detail-modal .chat-msg-row { color: #000 !important; }
            #user-detail-modal .chat-msg-row.sent { background: #e3f2fd !important; }
            #user-detail-modal .chat-msg-row.received { background: #f5f5f5 !important; }
            #user-detail-modal .chat-msg-meta { color: #666 !important; }

            #user-detail-modal h4 { color: #007bff !important; }
            #user-detail-modal .clickable-profile { color: #000 !important; text-decoration: none !important; cursor: default !important; }
            #user-detail-modal .online-dot { display: none !important; }

            /* ALLE Scrollbereiche und H√∂henbegrenzungen aufheben */
            #user-detail-modal div,
            #user-detail-modal section,
            #user-detail-modal ul,
            #user-detail-modal ol {
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
                overflow-y: visible !important;
                overflow-x: visible !important;
            }

            /* Scrollbars komplett verstecken */
            #user-detail-modal ::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
            }
            #user-detail-modal {
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }
        }
        .list-edit { font-family:monospace; font-size:11px; color:#0f0; background:#111; border:1px solid #444; padding:10px; white-space:pre; overflow:auto; opacity:1; }
        
        .tab-btn { padding:5px 15px; background:#222; border:1px solid #444; color:#888; cursor:pointer; }
        .tab-btn.active { background:var(--accent); color:white; border-color:var(--accent); }
        
        .sg-stat-box { background: #1a1a1a; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #333; }
        .sg-stat-num { font-size: 24px; font-weight: bold; color: var(--accent); display: block; }
        .sg-stat-lbl { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .file-status { font-size:10px; color:#888; margin-top:5px; display:flex; align-items:center; gap:10px;}
        .status-ok { color:var(--success); }
        .status-default { color:#aaa; font-style:italic; }
        .akte-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .akte-field label { font-size:10px; color:#888; display:block; margin-bottom:2px; }
        
        .bar-chart-row { display:flex; align-items:center; margin-bottom:6px; font-size:11px; }
        .bar-chart-label { width:90px; color:#aaa; text-align:right; padding-right:10px; }
        .bar-chart-bar-bg { flex:1; background:#222; height:12px; border-radius:2px; overflow:hidden; position:relative; }
        .bar-chart-bar-fill { height:100%; background:var(--accent); transition: width 0.3s; }
        .bar-chart-val { width:40px; padding-left:10px; color:var(--text); font-weight:bold; }
        
        .log-entry { font-size:11px; padding:5px 0; border-bottom:1px solid #222; display:flex; gap:10px; font-family:monospace; }
        .log-time { color:#666; width:100px; }
        .log-type { width:60px; font-weight:bold; }
        .log-msg { flex:1; color:#ccc; }
        .log-type-SYSTEM { color: var(--accent); } .log-type-EDIT { color: var(--warn); } .log-type-POST { color: var(--success); } .log-type-SIM { color: #d500f9; } .log-type-RISK { color: var(--danger); }
        
        #loader { position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:99; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        #error-box { position:fixed; bottom:20px; right:20px; background:#500; border:1px solid red; color:white; padding:15px; z-index:9999; display:none; max-width:300px; font-size:12px; box-shadow:0 0 20px black; }
        
        /* Auto-Complete */
        .ac-wrapper { position: relative; }
        .ac-list { position: absolute; top: 100%; left: 0; width: 100%; background: #222; border: 1px solid #444; max-height: 150px; overflow-y: auto; z-index: 50; display: none; }
        .ac-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #333; font-size: 11px; }
        .ac-item:hover { background: var(--accent); color: white; }

        /* Chat UI */
        .admin-chat-layout { display: flex; height: calc(100vh - 110px); gap: 20px; }
        .admin-chat-list { width: 300px; background: var(--card); border-radius: 6px; border: 1px solid #333; display: flex; flex-direction: column; }
        .admin-chat-viewer { flex: 1; background: var(--card); border-radius: 6px; border: 1px solid #333; display: flex; flex-direction: column; }
        
        .chat-list-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .chat-list-body { overflow-y: auto; flex: 1; }
        
        .convo-item { padding: 12px 15px; border-bottom: 1px solid #333; position: relative; display: flex; align-items: center; gap: 10px; }
        .convo-item:hover { background: #1f1f1f; }
        .convo-item.active { background: rgba(45, 136, 255, 0.1); border-left: 3px solid var(--accent); }
        .convo-item.unread::after { content: ''; position: absolute; right: 10px; top: 15px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; }
        
        .convo-names { font-weight: bold; font-size: 13px; color: var(--text); }
        .convo-sub { font-size: 11px; color: var(--text-dim); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .chat-viewer-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
        .chat-viewer-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-viewer-input { border-top: 1px solid #333; padding: 10px; background: #1a1a1a; }
        
        .chat-msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; position: relative; }
        .chat-msg-in { align-self: flex-start; background: #333; color: #ddd; border-bottom-left-radius: 2px; }
        .chat-msg-out { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
        
        .chat-sender-lbl { font-size: 10px; margin-bottom: 2px; color: #888; }
        .chat-msg-time { font-size: 9px; color: #666; margin-top: 3px; }
        .chat-msg-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .chat-date-separator { text-align: center; margin: 15px 0; position: relative; }
        .chat-date-separator::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; border-top: 1px solid #333; }
        .chat-date-separator span { background: var(--card); padding: 4px 12px; font-size: 10px; color: #888; position: relative; border: 1px solid #333; border-radius: 10px; }

        .reply-context { background: #222; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; font-size: 11px; color: var(--accent); display: flex; align-items: center; gap: 5px; border: 1px solid #333; }

        @keyframes bell-shake {
        }

        /* Wire Login Overlay */
        .wire-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .wire-login-container {
            background: var(--card);
            border-radius: 8px;
            padding: 0;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(45, 136, 255, 0.3);
            border: 1px solid var(--accent);
            overflow: hidden;
        }
        .wire-login-header {
            background: #111;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        .wire-login-header h2 {
            margin: 0;
            color: var(--accent);
            font-size: 18px;
            letter-spacing: 3px;
        }
        .wire-login-tabs {
            display: flex;
            background: #1a1a1a;
        }
        .wire-login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .wire-login-tab:hover {
            background: #222;
        }
        .wire-login-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .wire-login-body {
            padding: 25px;
        }
        .wire-login-form {
            display: none;
        }
        .wire-login-form.active {
            display: block;
        }
        .wire-form-group {
            margin-bottom: 15px;
        }
        .wire-form-group label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }
        .wire-form-input {
            width: 100%;
            padding: 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        .wire-form-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .wire-form-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .wire-form-btn:hover {
            background: #4499ff;
        }
        .wire-form-msg {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
        }
        .wire-form-msg.error { color: var(--danger); }
        .wire-form-msg.success { color: var(--success); }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }
        .settings-container {
            background: var(--card);
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--accent);
            border-radius: 8px;
        }
        .settings-header {
            background: #111;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings-header h3 {
            margin: 0;
            color: var(--accent);
        }
        .settings-body {
            padding: 20px;
        }
        .settings-section {
            margin-bottom: 25px;
        }
        .settings-section h4 {
            color: var(--text);
            margin: 0 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 5px;
            border-left: 3px solid var(--accent);
        }
        .user-list-item.current {
            border-left-color: var(--success);
        }
        .user-list-item .user-info {
            display: flex;
            flex-direction: column;
        }
        .user-list-item .user-name {
            font-weight: bold;
            color: var(--text);
        }
        .user-list-item .user-role {
            font-size: 10px;
            color: #888;
        }
    </style>
</head>
<body>

<!-- Wire Login Overlay -->
<div class="wire-login-overlay" id="wire-login-overlay">
    <div class="wire-login-container">
        <div class="wire-login-header">
            <h2>GHOST IN THE WIRE</h2>
        </div>
        <div class="wire-login-tabs">
            <div class="wire-login-tab active" onclick="switchWireTab('login')">Einloggen</div>
            <div class="wire-login-tab" onclick="switchWireTab('register')">Registrieren</div>
        </div>
        <div class="wire-login-body">
            <!-- Login Form -->
            <div class="wire-login-form active" id="wire-login-form">
                <div class="wire-form-group">
                    <label>Benutzername</label>
                    <input type="text" id="wire-login-user" class="wire-form-input" onkeydown="if(event.key==='Enter') wireLogin()">
                </div>
                <div class="wire-form-group">
                    <label>Passwort</label>
                    <input type="password" id="wire-login-pass" class="wire-form-input" onkeydown="if(event.key==='Enter') wireLogin()">
                </div>
                <button class="wire-form-btn" onclick="wireLogin()">Einloggen</button>
                <div class="wire-form-msg" id="wire-login-msg"></div>
            </div>
            <!-- Register Form -->
            <div class="wire-login-form" id="wire-register-form">
                <div class="wire-form-group">
                    <label>Benutzername</label>
                    <input type="text" id="wire-reg-user" class="wire-form-input">
                </div>
                <div class="wire-form-group">
                    <label>Passwort</label>
                    <input type="password" id="wire-reg-pass" class="wire-form-input">
                </div>
                <div class="wire-form-group">
                    <label>Passwort best√§tigen</label>
                    <input type="password" id="wire-reg-pass2" class="wire-form-input">
                </div>
                <div class="wire-form-group">
                    <label>Registrierungs-Code</label>
                    <input type="password" id="wire-reg-code" class="wire-form-input" placeholder="Vom Administrator erhalten">
                </div>
                <button class="wire-form-btn" onclick="wireRegister()">Registrieren</button>
                <div class="wire-form-msg" id="wire-register-msg"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settings-modal">
    <div class="settings-container">
        <div class="settings-header">
            <h3>‚öôÔ∏è Einstellungen</h3>
            <button class="danger small" onclick="closeSettings()">X</button>
        </div>
        <div class="settings-body">
            <!-- Passwort √§ndern -->
            <div class="settings-section">
                <h4>üîê Passwort √§ndern</h4>
                <div class="wire-form-group">
                    <label>Aktuelles Passwort</label>
                    <input type="password" id="settings-old-pass" class="wire-form-input">
                </div>
                <div class="wire-form-group">
                    <label>Neues Passwort</label>
                    <input type="password" id="settings-new-pass" class="wire-form-input">
                </div>
                <div class="wire-form-group">
                    <label>Neues Passwort best√§tigen</label>
                    <input type="password" id="settings-new-pass2" class="wire-form-input">
                </div>
                <button onclick="changeWirePassword()" style="width:100%;">Passwort √§ndern</button>
                <div class="wire-form-msg" id="settings-pass-msg"></div>
            </div>
            <!-- Benutzerverwaltung -->
            <div class="settings-section">
                <h4>üë• Benutzerverwaltung</h4>
                <div id="wire-user-list"></div>
            </div>
            <!-- Logout -->
            <div class="settings-section">
                <button class="danger" onclick="wireLogout()" style="width:100%;">üö™ Ausloggen</button>
            </div>
        </div>
    </div>
</div>

<div id="loader">
    <h1 style="color:var(--accent); letter-spacing:5px;">GHOST IN THE WIRES</h1>
    <div id="loader-status" style="color:#666; margin-bottom:20px;">Verbinde mit Server...</div>
    <div id="loader-buttons" style="display:none; flex-direction:column; gap:10px; align-items:center;">
        <button onclick="loadDBFromServer()" style="width:200px;">üîÑ Erneut versuchen</button>
        <button class="danger" onclick="document.getElementById('loader').style.display='none'; setView('gen')" style="width:200px;">‚ûï Neue DB erstellen</button>
    </div>
</div>

<div id="error-box" onclick="this.style.display='none'"></div>
<div id="toast-notification" style="position:fixed; top:20px; right:20px; background:var(--card); border:1px solid var(--accent); color:white; padding:12px 20px; border-radius:8px; display:none; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3); font-size:13px; max-width:300px;">
    <div id="toast-text"></div>
</div>

<header>
    <div class="brand">GHOST IN THE <span>WIRE</span> <span style="color:var(--success);">ONLINE</span></div>
        <div id="stat-info" style="color: var(--text-dim); font-size: 11px; margin-left: 20px;"></div>
        <div id="user-display" style="color: var(--accent); font-weight: bold; font-size: 12px;"></div>
        
        <div style="display:flex; align-items:center; gap:10px; margin-left:auto;">
            <span id="wire-user-display" style="color:var(--success); font-size:12px; margin-right:10px;"></span>
            <button onclick="openSettings()" style="background:var(--card); border:1px solid #444; color:var(--text-dim); padding:4px 10px; font-size:11px; cursor:pointer; border-radius:4px;">‚öôÔ∏è</button>
            <button onclick="openBackupModal()" style="background:var(--card); border:1px solid var(--accent); color:var(--accent); padding:4px 10px; font-size:11px; cursor:pointer; border-radius:4px;">üíæ BACKUPS</button>
            <button onclick="saveDB()" style="background:var(--card); border:1px solid #444; color:var(--text-dim); padding:4px 10px; font-size:11px; cursor:pointer; border-radius:4px;">‚¨áÔ∏è EXPORT</button>
            <div style="position: relative;">
                <button id="bell-btn" onclick="toggleNotifications()" style="background:transparent; border:none; color:var(--text-dim); cursor:pointer; position:relative; width:24px; height:24px; padding:0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L12 4"/>
                        <path d="M5 10a7 7 0 0114 0v4l2 2H3l2-2v-4z"/>
                        <path d="M9 18a3 3 0 006 0"/>
                    </svg>
                    <span id="bell-badge" style="position:absolute; top:-2px; right:-2px; background:var(--danger); color:white; border-radius:50%; font-size:9px; font-weight:bold; height:16px; min-width:16px; display:none; align-items:center; justify-content:center;">0</span>
                </button>
                <!-- Notifications Dropdown -->
                <div id="notifications-dropdown" style="display:none; position:absolute; top:35px; right:0; width:350px; background:var(--card); border:1px solid var(--accent); border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.5); z-index:9999;">
                    <div style="padding:12px 15px; border-bottom:1px solid #333; font-weight:bold; color:var(--accent); display:flex; justify-content:space-between; align-items:center;">
                        <span>üîî Neuigkeiten</span>
                        <button onclick="clearNotifications()" class="small grey" style="font-size:10px;">Alle l√∂schen</button>
                    </div>
                    <div id="notifications-list" style="max-height:300px; overflow-y:auto;">
                        <div style="padding:20px; text-align:center; color:#666;">Keine neuen Benachrichtigungen</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="workspace">
    <div class="sidebar">
        <button class="nav-btn active" id="btn-dash" onclick="setView('dash')">üìä √úbersicht</button>
        <button class="nav-btn" id="btn-db" onclick="setView('db')">üë• Datenbank</button>
        <button class="nav-btn" id="btn-social" onclick="setView('social')">üï∏Ô∏è Social Graph</button>
        <button class="nav-btn" id="btn-evt" onclick="setView('evt')">üì¢ Gruppen Beitr√§ge</button>
        <button class="nav-btn" id="btn-noise" onclick="setView('noise')">üì¢ Noise Gen</button>
        <button class="nav-btn" id="btn-chat" onclick="setView('chat')">üí¨ Chat</button>
        <button class="nav-btn" id="btn-log" onclick="setView('log')">üìú System Log</button>
        <button class="nav-btn" id="btn-analysts" onclick="setView('analysts')">üéØ MunsterNET Benutzer</button>
        <div class="nav-sep"></div>
        <div class="nav-bottom"><button class="nav-btn" style="color:var(--success)" onclick="setView('gen')">‚ûï Neue Datenbank</button></div>
    </div>

    <div id="dash" class="main active">
        <div class="grid-3" style="margin-bottom:20px">
            <div class="sg-stat-box"><span id="dash-total" class="sg-stat-num">0</span><span class="sg-stat-lbl">Gesamtbev√∂lkerung</span></div>
            <div class="sg-stat-box"><span id="dash-posts" class="sg-stat-num">0</span><span class="sg-stat-lbl">Tracking-Eintr√§ge</span></div>
            <div class="sg-stat-box"><span id="dash-netname" class="sg-stat-num" style="font-size:16px; line-height:29px;">-</span><span class="sg-stat-lbl">Netzwerk ID</span></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3 style="color:var(--success)">Social Graph Analyse</h3><div id="sg-dash-stats" style="padding:10px 0;">Keine Daten...</div></div>
            <div class="card"><h3>Demografische Struktur (Alter)</h3><div id="dash-age-chart" style="margin-top:10px;"></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>Ethnische Verteilung</h3><div id="pie-eth"></div></div>
            <div class="card"><h3>Sprachkompetenz</h3><div id="pie-lang"></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>Nutzer nach St√§dten</h3><div id="list-city" class="stat-list"></div></div>
            <div class="card"><h3>Die 5 gr√∂√üten Vereine</h3><div id="list-club" class="stat-list"></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>Detail: Ethnien pro Stadt</h3><div id="bar-city-eth"></div><div id="legend-eth" class="legend-row"></div></div>
            <div class="card"><h3>Die 5 wichtigsten Gef√§hrder-Gruppen</h3><div id="list-risk" class="stat-list"></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>Erstellte Detail-Firmen</h3><div id="list-det-comp" class="stat-list"></div></div>
            <div class="card"><h3>Erstellte Detail-Gruppen</h3><div id="list-det-group" class="stat-list"></div></div>
        </div>
    </div>
    
    <div id="noise" class="main">
        <div class="grid-2">
            <!-- Card for Citizen Noise -->
            <div class="card">
                <h3 style="color:var(--success)">üì¢ B√ºrger-Rauschen</h3>
                <div class="expl">Erzeugt zuf√§lliges "Grundrauschen" von normalen B√ºrgern im Netzwerk.</div>
                
                <div style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;">
                        <span>Beteiligung</span>
                        <span id="v-n-p" style="color:var(--accent); font-weight:bold;">50%</span>
                    </div>
                    <input type="range" id="noise-prob" max="100" value="50" oninput="document.getElementById('v-n-p').innerText=this.value+'%'">
                    <div class="slider-desc">Prozentsatz der Bev√∂lkerung, der zuf√§llige Posts erstellt.</div>
                </div>

                <div style="margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;">
                        <span>Anzahl pro B√ºrger</span>
                        <span id="v-n-c" style="color:var(--accent); font-weight:bold;">3</span>
                    </div>
                    <input type="range" id="noise-count" max="10" value="3" oninput="document.getElementById('v-n-c').innerText=this.value">
                    <div class="slider-desc">Maximale Anzahl der Posts pro ausgew√§hltem B√ºrger.</div>
                </div>

                <button class="success" onclick="generateBatchNoise('citizen')" style="width:100%; padding:15px; font-size:14px; color:black; font-weight:bold; margin-top:20px;">üöÄ Rauschen generieren</button>
            </div>

            <!-- Card for Company Buzz -->
            <div class="card">
                <h3 style="color:var(--warn)">üè¢ Firmen-Buzz</h3>
                <div class="expl">Erzeugt zuf√§llige Werbe-Posts und Kundenmeinungen f√ºr Firmen-Profile.</div>

                <div style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;">
                        <span>Anzahl pro Firma</span>
                        <span id="v-bn-c" style="color:var(--warn); font-weight:bold;">2</span>
                    </div>
                    <input type="range" id="biz-noise-count" max="10" value="2" oninput="document.getElementById('v-bn-c').innerText=this.value">
                    <div class="slider-desc">Anzahl der Posts (Werbung oder Fake-Kundenmeinung), die f√ºr jede Firma erstellt werden.</div>
                </div>
                
                <button onclick="generateBatchNoise('company')" style="width:100%; padding:15px; font-size:14px; font-weight:bold; margin-top:20px;">üè¢ Buzz generieren</button>
            </div>
        </div>
    </div>
    
    <div id="log" class="main">
        <div class="card" style="height:100%; display:flex; flex-direction:column; margin:0;">
            <h3>System Protokoll (Log)</h3>
            <div class="expl">Das Logbuch wird persistent in der Datenbank gespeichert. Alle √Ñnderungen werden mit Benutzer und Zeitstempel protokolliert.</div>

            <!-- Filter-Leiste -->
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; align-items:center; background:#1a1a1a; padding:12px; border-radius:4px; border:1px solid #333;">
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:10px; color:#888; text-transform:uppercase;">Modul</label>
                    <select id="log-filter-module" onchange="renderLog()" style="width:180px; padding:6px;">
                        <option value="">Alle Module</option>
                        <option value="db">üë• Datenbank</option>
                        <option value="social">üï∏Ô∏è Social Graph</option>
                        <option value="posts">üì¢ Gruppen Beitr√§ge</option>
                        <option value="noise">üì¢ Noise Gen</option>
                        <option value="chat">üí¨ Chat</option>
                        <option value="system">üìú System Log</option>
                        <option value="analysts">üéØ MunsterNET Benutzer</option>
                    </select>
                </div>
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:10px; color:#888; text-transform:uppercase;">Benutzer</label>
                    <select id="log-filter-user" onchange="renderLog()" style="width:140px; padding:6px;">
                        <option value="">Alle</option>
                    </select>
                </div>
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:10px; color:#888; text-transform:uppercase;">Von</label>
                    <input type="date" id="log-filter-from" onchange="renderLog()" style="padding:5px; width:130px;">
                </div>
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:10px; color:#888; text-transform:uppercase;">Bis</label>
                    <input type="date" id="log-filter-to" onchange="renderLog()" style="padding:5px; width:130px;">
                </div>
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <label style="font-size:10px; color:#888; text-transform:uppercase;">Suche</label>
                    <input type="text" id="log-filter-search" onkeyup="renderLog()" placeholder="Text suchen..." style="padding:6px; width:150px;">
                </div>
                <button onclick="resetLogFilters()" class="small grey" style="margin-top:18px; padding:6px 12px;">Filter zur√ºcksetzen</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div id="log-stats" style="font-size:11px; color:#888;"></div>
                <button onclick="printLog()" style="background:var(--accent); border:1px solid var(--accent); color:white; padding:6px 12px; font-size:11px; cursor:pointer; border-radius:4px;">üñ®Ô∏è Angezeigte Eintr√§ge drucken</button>
            </div>

            <div id="log-container" style="flex:1; overflow-y:auto; background:black; border:1px solid #333; padding:10px; font-family:monospace;">
                <div style="color:#666; text-align:center; margin-top:20px;">Keine Eintr√§ge.</div>
            </div>
            <button class="small grey" style="margin-top:10px;" onclick="resetLog()">üóëÔ∏è Log l√∂schen</button>
        </div>
    </div>

    <div id="analysts" class="main">
        <div class="grid-2">
            <div class="card">
                <h3>üéØ MunsterNET Benutzer</h3>
                <div class="expl">√úbersicht aller MunsterNET Benutzer. Diese Accounts k√∂nnen sich in MunsterNet einloggen.</div>
                <div id="analysts-list" style="max-height:400px; overflow-y:auto;">
                    <div style="color:#666; text-align:center; padding:20px;">Lade MunsterNET Benutzer...</div>
                </div>
                <button onclick="loadAnalysts()" class="small grey" style="margin-top:10px;">‚Üª Aktualisieren</button>
            </div>
            <div class="card">
                <h3>‚ûï Neuen MunsterNET Benutzer anlegen</h3>
                <div class="expl">Erstellt einen neuen Analyst-Account mit eigenem Profil in der Datenbank.</div>
                <div style="margin-top:15px;">
                    <label style="font-size:11px; color:#888;">Benutzername</label>
                    <input type="text" id="new-analyst-name" placeholder="z.B. Analyst01">
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:11px; color:#888;">Passwort</label>
                    <input type="password" id="new-analyst-pass" placeholder="Passwort">
                </div>
                <button onclick="createAnalyst()" class="success" style="width:100%; margin-top:15px; padding:10px;">Analyst erstellen</button>
            </div>
        </div>
    </div>

    <div id="chat" class="main">
        <div class="admin-chat-layout">
            <div class="admin-chat-list">
                <div class="chat-list-header">
                    <span>üí¨ Aktive Chats</span>
                    <div style="display:flex; gap:5px;">
                        <button class="small" onclick="printAllChats()" style="padding:2px 6px; background:var(--accent);">üñ®Ô∏è Alle</button>
                        <button class="small grey" onclick="renderChatList()" style="padding:2px 5px;">‚Üª</button>
                    </div>
                </div>
                <div class="chat-list-body" id="chat-list-container">
                    <!-- Dynamic List -->
                </div>
            </div>
            <div class="admin-chat-viewer">
                <div class="chat-viewer-header" id="chat-view-head">
                    <span style="color:#666;">Kein Chat ausgew√§hlt</span>
                    <button class="small" onclick="printCurrentChat()" style="display:none; padding:2px 6px;" id="print-chat-btn">üñ®Ô∏è Drucken</button>
                </div>
                <div class="chat-viewer-body" id="chat-view-body"></div>
                <div class="chat-viewer-input">
                    <div id="chat-reply-context" class="reply-context" style="display:none;">
                        <span>Antworten als:</span>
                        <b id="reply-as-name">...</b>
                    </div>
                    <input id="chat-input" placeholder="Nachricht..." style="width:100%; background:#222; border:1px solid #444; padding:10px; color:white; border-radius:4px;" onkeydown="if(event.key==='Enter') sendAdminChat()" disabled>
                </div>
            </div>
        </div>
    </div>

    <div id="social" class="main">
        <div class="card">
            <h3>Konfiguration der Sozialstruktur</h3>
            <div class="expl">Hier steuern Sie, wie sich die Bev√∂lkerung vernetzt. Die Einstellungen k√∂nnen gespeichert werden und werden mit der Datenbank geladen.</div>
            <div class="grid-3" style="margin-bottom:20px;">
                <div class="sg-stat-box"><span id="sg-total" class="sg-stat-num">0</span><span class="sg-stat-lbl">Freundschaften</span></div>
                <div class="sg-stat-box"><span id="sg-avg" class="sg-stat-num">0</span><span class="sg-stat-lbl">√ò Freunde/User</span></div>
                <div class="sg-stat-box"><span id="sg-orphans" class="sg-stat-num">0</span><span class="sg-stat-lbl">Isolierte Nutzer</span></div>
            </div>
            <div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;"><span>Vereins-Vernetzung</span><span id="sg-v-club-gen" style="color:var(--accent)">60%</span></div><input type="range" id="sg-sl-club-gen" max="100" value="60" oninput="document.getElementById('sg-v-club-gen').innerText=this.value+'%'"><div class="slider-desc">Wahrscheinlichkeit f√ºr Freundschaften im selben Verein.</div></div>
            <div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;"><span>Detail-Gruppen</span><span id="sg-v-club-det" style="color:var(--accent)">80%</span></div><input type="range" id="sg-sl-club-det" max="100" value="80" oninput="document.getElementById('sg-v-club-det').innerText=this.value+'%'"><div class="slider-desc">Hoher Vernetzungsgrad innerhalb definierter Gruppen (z.B. Stammtisch).</div></div>
            <div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;"><span>Firmen</span><span id="sg-v-comp-det" style="color:var(--accent)">70%</span></div><input type="range" id="sg-sl-comp-det" max="100" value="70" oninput="document.getElementById('sg-v-comp-det').innerText=this.value+'%'"><div class="slider-desc">Wahrscheinlichkeit, dass sich Kollegen kennen.</div></div>
            <div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;"><span>Stadt</span><span id="sg-v-city" style="color:var(--accent)">30%</span></div><input type="range" id="sg-sl-city" max="100" value="30" oninput="document.getElementById('sg-v-city').innerText=this.value+'%'"><div class="slider-desc">Wahrscheinlichkeit f√ºr Freundschaften in der selben Stadt.</div></div>
            
            <div style="border-top:1px solid var(--border); margin: 20px 0;"></div>

            <div style="margin-bottom:20px;"><div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:2px; color:#ccc;"><span>Random Cross-Link</span><input type="number" id="sg-inp-rnd" value="2" style="width:50px; text-align:right;"></div><div class="slider-desc">Zuf√§llige Freundschaften pro Person (Chaos-Faktor).</div></div>
            
            <div style="margin-top:20px;">
                <button style="width:100%; padding:15px;" onclick="saveSocialSettings()">üíæ Einstellungen Speichern</button>
            </div>

            <div style="border-top:1px solid var(--border); margin: 20px 0;"></div>

            <div class="expl" style="margin-bottom:15px;">
                Klicken Sie hier, um den Social Graph basierend auf den oben definierten Regeln neu zu berechnen und zu generieren.
            </div>

            <button class="success" style="width:100%; padding:15px; font-size:14px; font-weight:bold;" onclick="runSocialSimulation()">üï∏Ô∏è VERBINDUNGEN GENERIEREN</button>
        </div>
    </div>

    <div id="db" class="main">
        <div class="card" style="margin-bottom:0">
            <h3>Datenbank Register</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="tab-btn active" onclick="switchDbTab('citizen', this)">B√ºrger</button>
                <button class="tab-btn" onclick="switchDbTab('company_profiles', this)">üè¢ Firmen-Profile (Edit)</button>
                <div style="width:20px"></div>
                <button class="tab-btn" onclick="switchDbTab('groups', this)">Gruppen (Edit)</button>
                <button class="tab-btn" onclick="switchDbTab('firms', this)">Firmen (Edit)</button>
                <button class="tab-btn" onclick="switchDbTab('cities', this)">St√§dte</button>
            </div>
            <div id="db-help-text" class="db-hint"></div>
            <div style="display:flex; gap:10px;" id="db-controls">
                <input placeholder="Suche..." onkeyup="renderDB(this.value)">
                <select id="db-f-city" class="db-city-dd" onchange="renderDB()"><option value="">Alle St√§dte</option></select>
                <select id="db-f-eth" class="db-eth-dd" onchange="renderDB()"><option value="">Alle Ethnien</option></select>
                <select id="db-f-risk" onchange="renderDB()"><option value="">Alle Risiken</option><option value="low">Gr√ºn</option><option value="mid">Gelb</option><option value="high">Rot</option></select>
            </div>
            
            <div id="db-company-profile-tools" style="display:none; background:#222; padding:10px; border-radius:4px; margin-bottom:10px; border-left:3px solid var(--accent);">
                <h4 style="margin:0 0 5px 0; font-size:12px; color:var(--accent);">NEUES FIRMEN-PROFIL ERSTELLEN</h4>
                <div class="expl" style="margin-bottom:8px">Erstellt ein neues Firmen-Profil mit eigenem Auftritt im Netzwerk.</div>
                <div class="grid-2">
                    <input id="new-comp-name" placeholder="Firmenname (z.B. B√§ckerei M√ºller)">
                    <input id="new-comp-job" placeholder="Branche (z.B. B√§ckerei, Handel)">
                </div>
                <div class="grid-2" style="margin-top:5px;">
                    <input id="new-comp-addr" placeholder="Adresse (z.B. Hauptstr. 12)">
                    <input id="new-comp-phone" placeholder="Telefon (optional)">
                </div>
                <div class="grid-2" style="margin-top:5px;">
                    <select id="new-comp-city" class="city-dropdown"></select>
                    <input id="new-comp-info" placeholder="Beschreibung/Info (optional)">
                </div>
                <button class="small" style="width:100%; margin-top:8px; background:var(--success); color:black" onclick="createManualCompany()">+ Firmen-Profil erstellen</button>
            </div>

            <div id="db-group-tools" style="display:none; background:#222; padding:10px; border-radius:4px; margin-bottom:10px;"><h4 style="margin:0 0 5px 0; font-size:12px; color:var(--accent);">NEUE DETAIL-GRUPPE (LIVE)</h4><div class="expl" style="margin-bottom:5px">Weist bestehenden B√ºrgern sofort diese Gruppe zu.</div><div class="grid-2"><input id="db-dg-name" placeholder="Name"><input id="db-dg-count" type="number" placeholder="Anzahl"></div><div class="grid-2" style="margin-top:5px"><select id="db-dg-risk"><option value="low">Gr√ºn</option><option value="mid">Gelb</option><option value="high">Rot</option></select><div style="display:flex;align-items:center;gap:5px"><span style="font-size:10px">Privat %</span><input type="range" id="db-dg-priv" max="100" value="0" style="flex:1"><span id="db-dg-priv-v" style="font-size:10px">0%</span></div></div><div class="grid-2" style="margin-top:5px"><select id="db-dg-city" class="city-dropdown" style="width:100%"></select><select id="db-dg-eth" class="db-eth-dd"></select></div><button class="small" style="width:100%; margin-top:5px; background:var(--success); color:black" onclick="createGroupFromDB()">Gruppe erstellen</button></div>
            <div id="db-firm-tools" style="display:none; background:#222; padding:10px; border-radius:4px; margin-bottom:10px;"><h4 style="margin:0 0 5px 0; font-size:12px; color:var(--accent);">NEUE DETAIL-FIRMA (LIVE)</h4><input id="db-dc-name" placeholder="Firmenname"><input id="db-dc-addr" placeholder="Adresse" style="margin-top:5px"><div class="grid-2" style="margin-top:5px"><input id="db-dc-count" type="number" placeholder="Anzahl Mitarbeiter"><select id="db-dc-city" class="city-dropdown"></select></div><button class="small" style="width:100%; margin-top:5px; background:var(--success); color:black" onclick="createFirmFromDB()">Firma erstellen</button></div>

            <div id="db-city-tools" style="display:none; background:#222; padding:10px; border-radius:4px; margin-bottom:10px; border-left:3px solid #00bcd4;">
                <h4 style="margin:0 0 5px 0; font-size:12px; color:#00bcd4;">NEUE STADT ERSTELLEN</h4>
                <div class="expl" style="margin-bottom:8px">Erstellt eine neue Stadt und optional B√ºrger, die auf bestehende Firmen/Vereine verteilt werden.</div>
                <div class="grid-2">
                    <input id="db-city-name" placeholder="Stadtname (z.B. Hannover)">
                    <input id="db-city-pop" type="number" placeholder="Einwohner (0 = keine)">
                </div>
                <div style="margin-top:8px; background:#1a1a1a; padding:8px; border-radius:4px;">
                    <div style="font-size:10px; color:#00bcd4; margin-bottom:5px; font-weight:bold;">ETHNIEN-VERTEILUNG</div>
                    <div id="db-city-eth-sliders"></div>
                </div>
                <div style="margin-top:8px; font-size:10px; color:#888; background:#1a1a1a; padding:5px; border-radius:3px;">
                    <b>Info:</b> Neue B√ºrger werden auf <b>bestehende</b> Firmen und Vereine aus allen St√§dten verteilt (Pendler-Konzept).
                </div>
                <button class="small" style="width:100%; margin-top:8px; background:var(--success); color:black" onclick="createCityWithCitizens()">+ Stadt erstellen</button>
            </div>

            <div style="text-align:right; font-size:10px; color:#666; margin-top:5px;" id="db-status-line"></div>
        </div>
        <div class="card" style="padding:0; border-top:none;"><table class="data-table"><thead id="db-head"></thead><tbody id="db-body"></tbody></table></div>
    </div>

    <div id="evt" class="main">
        <div style="display:flex; gap:20px; height:100%;">
            <div style="width:300px; display:flex; flex-direction:column; gap:10px;">
                <div class="card" style="margin:0">
                    <h3 style="margin-top:0">Beitrags-Regie</h3>
                    <div class="expl">Erstelle Kampagnen f√ºr bestimmte Zielgruppen.</div>
                    
                    <label>Szenario Name</label>
                    <input id="evt-name" placeholder="z.B. Protestaktion" style="margin-bottom:10px">

                    <div class="db-hint" style="margin-top:5px;">Ziel-Typ</div>
                    <select id="evt-target-type" onchange="toggleEventFilters()">
                        <option value="citizen">B√ºrger</option>
                        <option value="company">Firmen-Profile</option>
                    </select>

                    <div id="citizen-filters" style="margin-top:10px;">
                        <div class="db-hint">Zielgruppe (B√ºrger)</div>
                        <select id="evt-city" class="db-city-dd city-dropdown"><option value="">Alle St√§dte</option></select>
                        <select id="evt-detail-group" class="db-entity-dd" style="margin-top:5px"><option value="">Alle Detail-Gruppen</option></select>
                        <select id="evt-citizen-comp" class="db-entity-dd" style="margin-top:5px"><option value="">Alle Detail-Firmen (Arbeitsplatz)</option></select>
                        <select id="evt-eth" class="db-eth-dd" style="margin-top:5px"><option value="">Alle Ethnien</option></select>
                        <div class="grid-2" style="margin-top:5px">
                            <input type="number" id="evt-age-min" placeholder="Alter Min">
                            <input type="number" id="evt-age-max" placeholder="Alter Max">
                        </div>
                    </div>

                    <div id="company-filters" style="display:none; margin-top:10px;">
                        <div class="db-hint">Zielgruppe (Firmen)</div>
                        <select id="evt-comp-city" class="db-city-dd city-dropdown"><option value="">Alle St√§dte</option></select>
                        
                        <div class="db-hint" style="margin-top:5px;">Firmen-Quelle</div>
                        <select id="evt-comp-source" onchange="updateCompanyTargetList()">
                            <option value="all">Alle Firmen-Profile</option>
                            <option value="detail">Nur Detail-Firmen (aus Gen)</option>
                        </select>

                        <select id="evt-target-comp" class="db-entity-dd" style="margin-top:5px"><option value="">Alle Firmen</option></select>
                    </div>

                    <div class="db-hint" style="margin-top:10px">Content (Eine Variante pro Zeile)</div>
                    <textarea id="evt-texts" class="list-edit" rows="6" placeholder="Nachricht..."></textarea>
                    <div class="grid-2" style="margin-top:10px">
                        <button class="success" onclick="executeEvent()">üì¢ POSTEN</button>
                        <button onclick="saveEventScenario()">üíæ Speichern</button>
                    </div>
                </div>
                <div class="card" style="margin:0; flex:1; display:flex; flex-direction:column;"><h3 style="margin-top:0">Gespeicherte Szenarien</h3><div id="evt-saved-list" style="flex:1; overflow-y:auto; border:1px solid #333; padding:5px;"></div></div>
            </div>
            <div class="card" style="flex:1; margin:0; display:flex; flex-direction:column;"><h3 style="margin-top:0">Live Feed</h3><div id="event-list" style="flex:1; overflow-y:auto; font-size:12px;"></div></div>
        </div>
    </div>

    <div id="gen" class="main">
        <div class="card">
            <h3>1. Basis Einstellungen</h3>
            <div class="grid-2"><div><label style="font-size:10px">NETZWERK NAME</label><input id="gen-netname" value="MunsterNet"></div><div><label style="font-size:10px">POPULATION</label><input type="number" id="gen-pop" value="500" max="2000"><div style="font-size:9px;color:#666;margin-top:2px;">(Max. 2000 f√ºr System-Stabilit√§t)</div></div></div>
            <div style="margin-top:10px;"><label style="font-size:10px; color:var(--warn);">√úBUNGS-NAME (Dateiname)</label><input id="gen-exercise" value="Unbenannt" placeholder="z.B. Operation_Sumpf"><div class="slider-desc">Bestimmt den Dateinamen: [Name]_db[Nr].json</div></div>
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;"><h4 style="font-size:12px; margin-bottom:5px;">Altersverteilung (in %)</h4><div id="age-ctrl"></div></div>
        </div>
        <div class="card">
            <h3>2. Social Graph (Initial)</h3>
            <div class="gen-row"><span style="width:150px;font-size:11px">Freunde (Verein)</span><input type="range" id="gen-fr-club" max="100" value="60"></div><div class="gen-row"><span style="width:150px;font-size:11px">Freunde (Ort)</span><input type="range" id="gen-fr-city" max="100" value="30"></div><div class="gen-row"><span style="width:150px;font-size:11px">Random Freunde</span><input type="number" id="gen-fr-rnd" value="3" style="width:60px"></div>
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                <label style="font-size:11px; display:block; margin-bottom:5px;"><input type="checkbox" id="chk-gen-social" checked> Initiales Netzwerk generieren</label>
            </div>
        </div>
        <div class="grid-2"><div class="card"><h3>3a. St√§dte und Ethnienverteilung</h3><div class="gen-row"><input id="new-city-n" placeholder="Stadtname" style="flex:1"><button class="small" onclick="addCity()">+ Hinzuf√ºgen</button></div><div id="city-list-container"></div></div><div class="card"><h3>3b. Ethnien Definition</h3><div id="eth-def-list"></div><div class="gen-row"><input id="new-eth-n" placeholder="Name" style="width:100px"><button class="small" onclick="addEthDef()">+ Add</button></div></div></div>
        <div class="grid-2">
            <div class="card"><h3>4a. Detail-Gruppen (Konfiguration)</h3><div class="expl">Hier legen Sie Gruppen fest, die beim n√§chsten "Generieren" automatisch erstellt werden.</div><div id="detail-group-list"></div><div style="background:#222; padding:5px; border-radius:4px; border:1px solid #444;"><div class="grid-2"><input id="dg-name" placeholder="Name"><input id="dg-count" type="number" placeholder="Anzahl"></div><div class="grid-2" style="margin-top:5px"><select id="dg-risk"><option value="low">Gr√ºn</option><option value="mid">Gelb</option><option value="high">Rot</option></select><select id="dg-city" class="city-dropdown" style="width:100%"></select></div><div class="grid-2" style="margin-top:5px"><select id="dg-eth" class="eth-dropdown" style="width:100%"></select></div><div style="margin-top:10px;"><div style="display:flex; justify-content:space-between; font-size:10px; color:#aaa; margin-bottom:2px;"><span>Privatsph√§re (0%=√ñffentlich)</span><span id="dg-priv-val" style="color:var(--accent)">0%</span></div><input type="range" id="dg-priv" max="100" value="0" style="width:100%" oninput="document.getElementById('dg-priv-val').innerText=this.value+'%'"></div><button class="small" style="width:100%; margin-top:10px" onclick="addDetailGroup()">Gruppe Konfigurieren</button></div></div>
            <div class="card"><h3>4b. Vereine (Extern)</h3><div class="expl">Import ortsgebundener Entit√§ten. Dateistruktur: <code>Name, Stadt</code> (pro Zeile).</div><div style="display:flex; gap:10px; margin-bottom:5px;"><button class="small" onclick="downloadTemplate('clubs')">‚¨áÔ∏è Vorlage laden</button></div><div style="display:flex; gap:10px; align-items:center"><input type="file" id="f-clubs-up" style="display:none" onchange="handleFileLoad(this, 'clubs')"><button class="small grey" onclick="document.getElementById('f-clubs-up').click()">üìÇ Datei w√§hlen</button><div id="stat-clubs" class="file-status status-default">Standard aktiv</div></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>5a. Detail-Firmen</h3><div id="detail-comp-list"></div><div style="background:#222; padding:5px; border-radius:4px; border:1px solid #444;"><input id="dc-name" placeholder="Firmenname"><input id="dc-addr" placeholder="Adresse" style="margin-top:5px"><div class="grid-2" style="margin-top:5px"><input id="dc-count" type="number" placeholder="Mitarbeiter"><select id="dc-city" class="city-dropdown"></select></div><button class="small" style="width:100%; margin-top:5px" onclick="addDetailComp()">Firma Hinzuf√ºgen</button></div></div>
            <div class="card"><h3>5b. Random Firmen (Extern)</h3><div class="expl">Import ortsgebundener Entit√§ten. Dateistruktur: <code>Name, Stadt, Adresse</code> (pro Zeile).</div><div style="display:flex; gap:10px; margin-bottom:5px;"><button class="small" onclick="downloadTemplate('comps')">‚¨áÔ∏è Vorlage laden</button></div><div style="display:flex; gap:10px; align-items:center"><input type="file" id="f-comps-up" style="display:none" onchange="handleFileLoad(this, 'comps')"><button class="small grey" onclick="document.getElementById('f-comps-up').click()">üìÇ Datei w√§hlen</button><div id="stat-comps" class="file-status status-default">Standard aktiv</div></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><h3>6. Eigene Namensliste (Extern)</h3><div class="expl">Import individueller Identit√§ten. Dateistruktur: <code>Vorname Nachname</code> (pro Zeile).</div><div style="display:flex; gap:10px; margin-bottom:5px;"><button class="small" onclick="downloadTemplate('names')">‚¨áÔ∏è Vorlage laden</button></div><div style="display:flex; gap:10px; align-items:center"><input type="file" id="f-names-up" style="display:none" onchange="handleFileLoad(this, 'names')"><button class="small grey" onclick="document.getElementById('f-names-up').click()">üìÇ Datei w√§hlen</button><div id="stat-names" class="file-status status-default">Standard aktiv</div></div></div>
            <div class="card"><h3>7. Content Engine (Posts)</h3><div class="expl">Import von Nutzerbeitr√§gen. Dateistruktur: <code>Ein Post pro Zeile</code>.</div><div style="display:flex; gap:10px; margin-bottom:5px;"><button class="small" onclick="downloadTemplate('posts')">‚¨áÔ∏è Vorlage laden</button></div><div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;"><input type="file" id="f-posts-up" style="display:none" onchange="handleFileLoad(this, 'posts')"><button class="small grey" onclick="document.getElementById('f-posts-up').click()">üìÇ Datei w√§hlen</button><div id="stat-posts" class="file-status status-default">Standard aktiv</div></div><div class="gen-row"><span style="width:150px;font-size:11px">Max Posts pro Nutzer</span><input type="number" id="gen-max-posts" value="5" style="width:60px" min="1" max="20"></div><div class="gen-row"><span style="width:150px;font-size:11px">Custom Posts Wahrscheinlichkeit</span><input type="range" id="gen-custom-posts-prob" max="100" value="20" oninput="document.getElementById('v-custom-posts-prob').innerText=this.value+'%'"><span id="v-custom-posts-prob" style="width:40px">20%</span></div>
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                <label style="font-size:11px; display:block; margin-bottom:5px;"><input type="checkbox" id="chk-gen-posts" checked> Initiale Posts generieren</label>
            </div>
            </div>
        </div>
        
        <div class="card" style="border-left:3px solid var(--accent)">
            <h3>8. Portr√§t-Matrix (Sprite Sheet)</h3>
            <div class="expl">
                L√§dt ein einzelnes Bild mit vielen Gesichtern und schneidet es automatisch in Einzelprofile.
                Die Bilder werden lokal verarbeitet und direkt in der Datenbank gespeichert (Base64).
            </div>
            <div class="grid-2" style="margin-bottom:10px">
                <div><label style="font-size:10px">Spalten (X)</label><input type="number" id="spr-cols" value="21"></div>
                <div><label style="font-size:10px">Zeilen (Y)</label><input type="number" id="spr-rows" value="14"></div>
            </div>
            <div style="display:flex; gap:10px; align-items:center">
                <input type="file" id="f-sprite-up" style="display:none" onchange="processSpriteSheet(this)" accept="image/*">
                <button onclick="document.getElementById('f-sprite-up').click()">üñºÔ∏è Sprite Sheet laden</button>
                <div id="sprite-status" class="file-status status-default">Keine Bilder geladen</div>
            </div>
        </div>

        <button class="danger" style="width:100%;padding:20px;font-size:16px;margin-top:20px" onclick="runGenerator()">DATENBANK GENERIEREN</button>
    </div>
</div>

<div id="akte-modal" class="modal-overlay"><div class="modal"><div class="modal-header"><h3 id="modal-title">EDITOR</h3><button class="danger small" onclick="document.getElementById('akte-modal').style.display='none'">X</button></div><div class="modal-body" id="akte-content"></div></div></div>

<!-- Backup-Modal -->
<div id="backup-modal" class="modal-overlay" style="z-index:2500;">
    <div class="modal" style="width:600px;">
        <div class="modal-header" style="background:#1a4d1a;">
            <h3 style="color:var(--success);">üíæ BACKUP-VERWALTUNG</h3>
            <button class="danger small" onclick="document.getElementById('backup-modal').style.display='none'">X</button>
        </div>
        <div class="modal-body">
            <!-- Neues Backup erstellen -->
            <div style="background:#1a1a1a; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #333;">
                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:13px;">‚ûï Neues Backup erstellen</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="backup-name-input" placeholder="Name (optional, z.B. √úbung_Szenario1)" style="flex:1;">
                    <button onclick="createBackup()" class="success" style="white-space:nowrap;">üíæ Backup erstellen</button>
                </div>
            </div>

            <!-- Backup-Liste -->
            <div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; color:var(--text); font-size:13px;">üìÇ Gespeicherte Backups</h4>
                    <button onclick="loadBackupList()" class="small grey">‚Üª Aktualisieren</button>
                </div>
                <div id="backup-list" style="max-height:300px; overflow-y:auto; background:#0a0a0a; border:1px solid #333; border-radius:4px;">
                    <div style="padding:20px; text-align:center; color:#666;">Lade Backups...</div>
                </div>
            </div>

            <!-- Import von Datei -->
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid #333;">
                <h4 style="margin:0 0 10px 0; color:#888; font-size:12px;">üìÅ Externe Datei importieren</h4>
                <input type="file" id="backup-file-import" style="display:none" onchange="importBackupFile(this)">
                <button onclick="document.getElementById('backup-file-import').click()" class="grey" style="width:100%;">Datei von Computer laden...</button>
            </div>
        </div>
    </div>
</div>

<!-- Benutzer-Detail-Modal -->
<div id="user-detail-modal" class="modal-overlay">
    <div class="modal" style="width:900px; max-width:95vw;">
        <div class="modal-header" style="background:#0a2540;">
            <h3 id="user-detail-title" style="color:var(--accent);">BENUTZER-AKTE</h3>
            <div style="display:flex; gap:10px;">
                <button class="small" onclick="printUserDetail()" style="background:var(--accent);">üñ®Ô∏è DRUCKEN</button>
                <button class="danger small" onclick="document.getElementById('user-detail-modal').style.display='none'">X</button>
            </div>
        </div>
        <div class="modal-body" id="user-detail-content" style="padding:0;">
            <!-- Content wird dynamisch geladen -->
        </div>
    </div>
</div>

<script>
    // --- GLOBAL ERROR HANDLER ---
    window.onerror = function(msg, url, line) {
        let b = document.getElementById('error-box');
        b.style.display='block';
        b.innerHTML = "<b>CRITICAL ERROR:</b><br>" + msg + "<br>Line: " + line;
        return false;
    };

    console.log("Script loaded");

    // --- VARIABLES ---
    let profiles = [];
    let chats = {}; // Chat conversations
    let meta = { networkName: "MunsterNet", exerciseName: "Unbenannt", version: 1 };
    let detailGroups = [];
    let detailComps = [];
    let currentTab = 'citizen';
    let currentEditId = 0;
    let eventScenarios = [];
    let sortState = { col: 'name', dir: 1 };
    let systemLogs = [];
    let globalData = { clubs: [], comps: [], names: [], posts: [], sprites: [] };

    // --- WIRE USER SYSTEM ---
    const WIRE_MASTER_CODE = 'Munster123';
    let wireUsers = JSON.parse(localStorage.getItem('wireUsers') || '[]');
    let currentWireUser = JSON.parse(localStorage.getItem('currentWireUser') || 'null');

    function switchWireTab(tab) {
        document.querySelectorAll('.wire-login-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.wire-login-form').forEach(f => f.classList.remove('active'));
        document.querySelector(`.wire-login-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
        document.getElementById(tab === 'login' ? 'wire-login-form' : 'wire-register-form').classList.add('active');
        document.getElementById('wire-login-msg').textContent = '';
        document.getElementById('wire-register-msg').textContent = '';
    }

    function wireLogin() {
        const username = document.getElementById('wire-login-user').value.trim();
        const password = document.getElementById('wire-login-pass').value;
        const msgEl = document.getElementById('wire-login-msg');

        if (!username || !password) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Benutzername und Passwort erforderlich.';
            return;
        }

        const user = wireUsers.find(u => u.username === username && u.password === password);
        if (!user) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Ung√ºltige Anmeldedaten.';
            return;
        }

        currentWireUser = user;
        localStorage.setItem('currentWireUser', JSON.stringify(user));
        document.getElementById('wire-login-overlay').style.display = 'none';
        updateWireUserDisplay();
        addLog('SYSTEM', `Wire-Benutzer "${username}" angemeldet.`);
    }

    function wireRegister() {
        const username = document.getElementById('wire-reg-user').value.trim();
        const password = document.getElementById('wire-reg-pass').value;
        const password2 = document.getElementById('wire-reg-pass2').value;
        const code = document.getElementById('wire-reg-code').value;
        const msgEl = document.getElementById('wire-register-msg');

        if (!username || !password || !password2 || !code) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Alle Felder ausf√ºllen.';
            return;
        }

        if (password !== password2) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Passw√∂rter stimmen nicht √ºberein.';
            return;
        }

        if (code !== WIRE_MASTER_CODE) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Ung√ºltiger Registrierungs-Code.';
            return;
        }

        if (wireUsers.find(u => u.username === username)) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Benutzername bereits vergeben.';
            return;
        }

        const newUser = { username, password, createdAt: new Date().toISOString() };
        wireUsers.push(newUser);
        localStorage.setItem('wireUsers', JSON.stringify(wireUsers));

        msgEl.className = 'wire-form-msg success';
        msgEl.textContent = 'Registrierung erfolgreich! Sie k√∂nnen sich jetzt einloggen.';

        // Clear fields
        document.getElementById('wire-reg-user').value = '';
        document.getElementById('wire-reg-pass').value = '';
        document.getElementById('wire-reg-pass2').value = '';
        document.getElementById('wire-reg-code').value = '';

        // Auto-switch to login after 2 seconds
        setTimeout(() => switchWireTab('login'), 2000);
    }

    function wireLogout() {
        const username = currentWireUser ? currentWireUser.username : 'Unbekannt';
        addLog('SYSTEM', `Wire-Benutzer "${username}" abgemeldet.`);
        currentWireUser = null;
        localStorage.removeItem('currentWireUser');
        closeSettings();
        document.getElementById('wire-login-overlay').style.display = 'flex';
        updateWireUserDisplay();
    }

    function checkWireLogin() {
        if (!currentWireUser) {
            document.getElementById('wire-login-overlay').style.display = 'flex';
        } else {
            document.getElementById('wire-login-overlay').style.display = 'none';
            updateWireUserDisplay();
        }
    }

    function updateWireUserDisplay() {
        const el = document.getElementById('wire-user-display');
        if (el && currentWireUser) {
            el.textContent = 'üë§ ' + currentWireUser.username;
        } else if (el) {
            el.textContent = '';
        }
    }

    function openSettings() {
        renderWireUserList();
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
        document.getElementById('settings-old-pass').value = '';
        document.getElementById('settings-new-pass').value = '';
        document.getElementById('settings-new-pass2').value = '';
        document.getElementById('settings-pass-msg').textContent = '';
    }

    function changeWirePassword() {
        const oldPass = document.getElementById('settings-old-pass').value;
        const newPass = document.getElementById('settings-new-pass').value;
        const newPass2 = document.getElementById('settings-new-pass2').value;
        const msgEl = document.getElementById('settings-pass-msg');

        if (!oldPass || !newPass || !newPass2) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Alle Felder ausf√ºllen.';
            return;
        }

        if (oldPass !== currentWireUser.password) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Aktuelles Passwort ist falsch.';
            return;
        }

        if (newPass !== newPass2) {
            msgEl.className = 'wire-form-msg error';
            msgEl.textContent = 'Neue Passw√∂rter stimmen nicht √ºberein.';
            return;
        }

        // Update password
        currentWireUser.password = newPass;
        const idx = wireUsers.findIndex(u => u.username === currentWireUser.username);
        if (idx !== -1) {
            wireUsers[idx].password = newPass;
            localStorage.setItem('wireUsers', JSON.stringify(wireUsers));
            localStorage.setItem('currentWireUser', JSON.stringify(currentWireUser));
        }

        msgEl.className = 'wire-form-msg success';
        msgEl.textContent = 'Passwort erfolgreich ge√§ndert.';
        addLog('SYSTEM', `Wire-Benutzer "${currentWireUser.username}" hat Passwort ge√§ndert.`);

        document.getElementById('settings-old-pass').value = '';
        document.getElementById('settings-new-pass').value = '';
        document.getElementById('settings-new-pass2').value = '';
    }

    function renderWireUserList() {
        const el = document.getElementById('wire-user-list');
        if (!el) return;

        if (wireUsers.length === 0) {
            el.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Keine MunsterNET Benutzer registriert.</div>';
            return;
        }

        el.innerHTML = wireUsers.map(u => {
            const isCurrent = currentWireUser && currentWireUser.username === u.username;
            const created = new Date(u.createdAt).toLocaleDateString('de-DE');
            return `
                <div class="user-list-item ${isCurrent ? 'current' : ''}">
                    <div class="user-info">
                        <span class="user-name">${u.username} ${isCurrent ? '(Du)' : ''}</span>
                        <span class="user-role">Registriert: ${created}</span>
                    </div>
                    ${!isCurrent ? `<button class="danger small" onclick="deleteWireUser('${u.username}')">L√∂schen</button>` : ''}
                </div>
            `;
        }).join('');
    }

    function deleteWireUser(username) {
        if (!confirm(`Benutzer "${username}" wirklich l√∂schen?`)) return;
        wireUsers = wireUsers.filter(u => u.username !== username);
        localStorage.setItem('wireUsers', JSON.stringify(wireUsers));
        renderWireUserList();
        addLog('SYSTEM', `Wire-Benutzer "${username}" von ${currentWireUser.username} gel√∂scht.`);
    }

    function getWireUsername() {
        return currentWireUser ? currentWireUser.username : 'System';
    }
    let gen = {
        age: { y: 30, m: 50, o: 20 },
        ethnics: [
            { name: 'Deutsch', lang: 100, priv: 10 },
            { name: 'Wislanisch', lang: 60, priv: 20 },
            { name: 'Altraverdisch', lang: 40, priv: 40 }
        ],
        cities: [
            { name: "Munster", distrib: [80, 10, 10] },
            { name: "Bergen", distrib: [70, 20, 10] },
            { name: "Celle", distrib: [80, 10, 10] }
        ]
    };
    
    // Config Data
    const colors=['#2d88ff','#00e676','#fbc02d','#f02849','#9c27b0','#00bcd4','#ff5722','#795548','#607d8b'];
    const defaultClubs=["Sch√ºtzenverein, Munster","Freiwillige Feuerwehr, Bergen","TuS Celle, Celle","Angelverein, Munster","Landfrauen, Bergen","Schachclub, Celle","Kleingartenverein, Munster","Reitverein, Bergen","Theatergruppe, Celle","Gesangverein"];
    const defaultComps=["Rheinmetall, Munster, Heinrich-Scheppmann-Str. 2","B√§ckerei Meyer, Munster, Hauptstra√üe 5","Stadtwerke, Bergen, Am Friedensplatz 1","Autohaus Schmidt, Bergen, Celler Stra√üe 10","Celle Tourismus, Celle, Markt 14","Allgemeines Krankenhaus, Celle, Siemensplatz 4","E-Center, Munster, Danziger Stra√üe","Tischlerei M√ºller, Bergen, Bahnhofstra√üe","Schlosspark Cafe, Celle, Schlossplatz","Logistik Nord, Munster, S√ºdring"];
    const mandatoryNames=["Herbert Gr√∂nemayer","McLovlin","Homer Simpson","John Rambo","Arnold Schwarzenegger","Hank H√§berle","Alexander Rosenbaum","Adrian Copilul-Minune","James Bond","G√ºnther Giom"];
    const fallbackDefaults=["Max Mustermann","Erika Musterfrau","Hans M√ºller","Peter Schmidt","Julia Weber","Michael Schneider","Sabine Fischer","Thomas Meyer","Andreas Wagner","Petra Becker"];
    const subjects=["Das Wetter","Mein Essen","Der Verkehr","Mein Chef","Der Hund","Die Katze","Das Wochenende","Der Film","Die Party","Mein Urlaub","Die Arbeit","Der Kaffee","Mein Auto","Die Nachbarn","Das Training"];
    const verbs=["ist heute","war gestern","nervt","ist super","macht mich fertig","ist lecker","k√∂nnte besser sein","ist der Hammer","ist entspannt","ist chaotisch"];
    const endings=["!","..."," :(" ," :)"," xD"," - echt jetzt?",". Kann man nicht √§ndern.",". Traumhaft!",". Endlich!"];
    const jobs=["B√§cker","Verk√§ufer","Handwerker","B√ºrokaufmann","Pflegekraft","Arzt","Lehrer","Arbeitslos","G√§rtner","Kraftfahrer","Koch","Reinigungskraft","Ingenieur","Architekt","Student","Rentner","Elektriker","Dachdecker","Friseur","Kellner","IT-Spezialist","LKW-Fahrer","Mechatroniker","Landwirt","Erzieher","Buchhalter","Journalist","K√ºnstler","Busfahrer","Logistiker","Immobilienmakler","Tierarzt","Apotheker","Fitnesstrainer"];
    
    const bizPostsSelf = ["Wir suchen Verst√§rkung f√ºr unser Team!", "Sonderangebote diese Woche beachten.", "Unser Sommerfest war ein voller Erfolg.", "Neue √ñffnungszeiten ab Montag.", "Qualit√§t ist unser Mark√§neichen.", "Besuchen Sie unsere neue Webseite.", "Wir w√ºnschen allen Kunden ein sch√∂nes Wochenende.", "Innovation treibt uns an.", "Jetzt Termin vereinbaren!", "Frische Ware eingetroffen."];
    const bizPostsUser = ["Super Service, gerne wieder!", "Wann habt ihr ge√∂ffnet?", "Leider entt√§uschend heute.", "Kann ich nur empfehlen.", "Viel zu teuer!", "Wo finde ich euch genau?", "5 Sterne von mir.", "Nie wieder!", "Das war richtig lecker.", "Freundliches Personal."];
    
    let tempPostAuthorId = null;

    // --- INIT --- (moved to DOMContentLoaded at end of file)
    
    function initApp() {
        document.getElementById('loader').style.display = 'none';
        
        if(profiles[0] && profiles[0].meta) {
            meta = profiles[0].meta;
        } else {
            meta = { networkName: "MunsterNet", exerciseName: "Import", version: 1 };
            if(profiles.length > 0 && !profiles[0].meta) profiles[0].meta = meta;
        }

        document.getElementById('stat-info').innerText = `${profiles.length - 1} PROFILES | ${meta.networkName.toUpperCase()} | ${meta.exerciseName}`;
        updateSocialStats();
        if(profiles[0] && profiles[0].systemData) {
            if(profiles[0].systemData.logs) systemLogs = profiles[0].systemData.logs;
            if(profiles[0].systemData.detailGroups) detailGroups = profiles[0].systemData.detailGroups;
            if(profiles[0].systemData.detailComps) detailComps = profiles[0].systemData.detailComps;
            
            renderDetailGroupList();
            renderDetailCompList();
            
            setTimeout(checkPendingRequests, 1000);
        }
        
        loadSocialSettings();
        updateCompanyTargetList();
        updateDBDropdowns(); 
        
        let active = document.querySelector('.main.active');
        if(active) { setView(active.id); } else { setView('dash'); }
    }
    
    function showError(msg) {
        let b = document.getElementById('error-box');
        b.style.display='block';
        b.innerText = msg;
        console.error(msg);
    }
    
    // --- UTILS ---
    function getVal(id,def){let el=document.getElementById(id);return el?el.value:def;}
    function getInt(id,def){let el=document.getElementById(id);return el?(parseInt(el.value)||def):def;}
    function getChecked(id) { let el = document.getElementById(id); return el ? el.checked : false; }
    function getColor(str){let h=0;for(let i=0;i<str.length;i++)h=str.charCodeAt(i)+((h<<5)-h);let c=(h&0x00FFFFFF).toString(16).toUpperCase();return'#'+'00000'.substring(0,6-c.length)+c;}
    function getRandomName(){return fallbackDefaults[Math.floor(Math.random()*fallbackDefaults.length)];}
    function generateNoisePost(){return subjects[Math.floor(Math.random()*subjects.length)]+" "+verbs[Math.floor(Math.random()*verbs.length)]+endings[Math.floor(Math.random()*endings.length)];}
    
    function downloadTemplate(type){
        let c="",f="";
        if(type==='clubs'){c="# VEREINSLISTE\n# Name, Stadt\nSch√ºtzenverein, Munster";f="vereine.txt";}
        else if(type==='comps'){c="# FIRMENLISTE\n# Name, Stadt, Adresse\nRheinmetall, Munster, Str 1";f="firmen.txt";}
        else if(type==='names'){c="# NAMENSLISTE\n# Vorname Nachname\nMax Mustermann";f="namen.txt";}
        else if(type==='posts'){c="# POSTS\n# Ein Post pro Zeile\nHeute Stau!";f="posts.txt";}
        let b=new Blob([c],{type:"text/plain;charset=utf-8"});
        let a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=f;a.click();
    }
    
    function handleFileLoad(input,type){
        if(input.files[0]){
            let r=new FileReader();
            r.onload=e=>{
                let l=e.target.result.split('\n').map(x=>x.trim()).filter(x=>x&&!x.startsWith('#'));
                if(l.length>0){globalData[type]=l;document.getElementById(`stat-${type}`).innerText=`‚úÖ ${l.length} geladen`;document.getElementById(`stat-${type}`).className='file-status status-ok';}
            };r.readAsText(input.files[0]);
        }
    }

    // --- SPRITE SHEET PROCESSOR ---
    function processSpriteSheet(input) {
        if(!input.files[0]) return;
        
        let cols = getInt('spr-cols', 21);
        let rows = getInt('spr-rows', 14);
        let status = document.getElementById('sprite-status');
        
        status.innerText = "Lade Bild...";
        
        let reader = new FileReader();
        reader.onload = function(e) {
            let img = new Image();
            img.onload = function() {
                status.innerText = "Verarbeite...";
                
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');
                
                let tileW = img.width / cols;
                let tileH = img.height / rows;
                
                canvas.width = tileW;
                canvas.height = tileH;
                
                globalData.sprites = [];
                
                // Slicing loop
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        // Clear canvas
                        ctx.clearRect(0, 0, tileW, tileH);
                        // Draw specific tile
                        ctx.drawImage(img, x * tileW, y * tileH, tileW, tileH, 0, 0, tileW, tileH);
                        // Store as JPEG 0.8 to save space
                        globalData.sprites.push(canvas.toDataURL('image/jpeg', 0.8));
                    }
                }
                
                status.innerText = `‚úÖ ${globalData.sprites.length} Gesichter extrahiert`;
                status.className = 'file-status status-ok';
                console.log("Sprites loaded:", globalData.sprites.length);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    // --- UI RENDERERS ---
    function updateAge(k,v){v=parseInt(v);let s=0;for(let x in gen.age)if(x!==k)s+=gen.age[x];if(v+s>100)v=100-s;gen.age[k]=v;document.getElementById(`sl-age-${k}`).value=v;document.getElementById(`v-age-${k}`).innerText=v+'%';}
    function renderAgeSliders(){document.getElementById('age-ctrl').innerHTML=['y','m','o'].map(k=>`<div style="display:flex;gap:5px;align-items:center;margin-bottom:2px;"><span style="width:90px;font-size:10px;">${k==='y'?'16-29':(k==='m'?'30-59':'60+')}</span><input type="range" id="sl-age-${k}" max="100" value="${gen.age[k]}" oninput="updateAge('${k}',this.value)" style="flex:1"><span id="v-age-${k}" style="font-size:10px;width:30px;text-align:right;">${gen.age[k]}%</span></div>`).join('');}
    function renderEthUI(){document.getElementById('eth-def-list').innerHTML=gen.ethnics.map((e,i)=>`<div class="gen-row"><span class="gen-lbl">${e.name}</span><div style="flex:1"><div class="help-text"><span>Sprache</span><span>Deutsch</span></div><input type="range" max="100" value="${e.lang}" oninput="gen.ethnics[${i}].lang=parseInt(this.value)"><div class="slider-desc">Sprachkompetenz in der Landessprache.</div><div class="help-text" style="margin-top:5px"><span>Privat</span></div><input type="range" max="100" value="${e.priv}" oninput="gen.ethnics[${i}].priv=parseInt(this.value)"><div class="slider-desc">Wahrscheinlichkeit f√ºr "Privates Profil".</div></div></div>`).join('');}
    function addEthDef(){let n=getVal('new-eth-n','');if(n){gen.ethnics.push({name:n,lang:50,priv:20});document.getElementById('new-eth-n').value='';renderEthUI();renderCityList();updateSelects();}}
    function updateCityDistrib(ci,ei,v){v=parseInt(v);let c=gen.cities[ci],s=0;for(let i=0;i<c.distrib.length;i++)if(i!==ei)s+=c.distrib[i];if(v+s>100)v=100-s;c.distrib[ei]=v;document.getElementById(`sl-c-${ci}-${ei}`).value=v;document.getElementById(`v-c-${ci}-${ei}`).innerText=v+'%';}
    function renderCityList(){document.getElementById('city-list-container').innerHTML=gen.cities.map((c,i)=>{while(c.distrib.length<gen.ethnics.length)c.distrib.push(0);return`<div class="city-item"><div style="font-weight:bold;margin-bottom:5px">${c.name}</div>`+gen.ethnics.map((e,ei)=>`<div style="display:flex;align-items:center;gap:5px"><span style="font-size:10px;width:80px">${e.name}</span><input type="range" id="sl-c-${i}-${ei}" max="100" value="${c.distrib[ei]}" style="flex:1" oninput="updateCityDistrib(${i},${ei},this.value)"><span id="v-c-${i}-${ei}" style="font-size:10px;width:30px;text-align:right">${c.distrib[ei]}%</span></div>`).join('')+`</div>`;}).join('');}
    function addCity(){let n=getVal('new-city-n','');if(n){gen.cities.push({name:n,distrib:new Array(gen.ethnics.length).fill(0)});document.getElementById('new-city-n').value='';renderCityList();updateSelects();}}
    function updateSelects(){let c=gen.cities.map(x=>`<option>${x.name}</option>`).join('');document.querySelectorAll('.city-dropdown').forEach(s=>s.innerHTML='<option value="">Alle St√§dte</option>'+c);let e=gen.ethnics.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');document.querySelectorAll('.eth-dropdown').forEach(s=>s.innerHTML='<option value="">Alle Ethnien</option>'+e);}

    // --- NEW CITY CREATION ETHNICITY SLIDERS ---
    let newCityDistrib = [];

    function renderNewCityEthSliders() {
        // Initialize distribution array if needed
        newCityDistrib = new Array(gen.ethnics.length).fill(0);
        if(newCityDistrib.length > 0) newCityDistrib[0] = 100; // Default: 100% first ethnicity

        let container = document.getElementById('db-city-eth-sliders');
        if(!container) return;

        container.innerHTML = gen.ethnics.map((e, i) => `
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:3px;">
                <span style="font-size:10px; width:80px; color:#ccc;">${e.name}</span>
                <input type="range" id="sl-new-city-${i}" max="100" value="${newCityDistrib[i]}" style="flex:1" oninput="updateNewCityDistrib(${i}, this.value)">
                <span id="v-new-city-${i}" style="font-size:10px; width:35px; text-align:right; color:var(--accent);">${newCityDistrib[i]}%</span>
            </div>
        `).join('');
    }

    function updateNewCityDistrib(idx, val) {
        val = parseInt(val);
        let sum = 0;
        for(let i = 0; i < newCityDistrib.length; i++) {
            if(i !== idx) sum += newCityDistrib[i];
        }
        if(val + sum > 100) val = 100 - sum;
        newCityDistrib[idx] = val;
        document.getElementById(`sl-new-city-${idx}`).value = val;
        document.getElementById(`v-new-city-${idx}`).innerText = val + '%';
    }

    function updateDBDropdowns() {
        let cities = new Set();
        if(gen.cities) gen.cities.forEach(c => cities.add(c.name));
        if(profiles.length > 1) profiles.forEach(p => { if(p.id!==0 && p.info.city) cities.add(p.info.city); });
        
        let cityOpts = '<option value="">Alle St√§dte</option>' + Array.from(cities).map(c=>`<option>${c}</option>`).join('');
        let cSelect = document.getElementById('db-f-city');
        if(cSelect) { cSelect.innerHTML = cityOpts; cSelect.value = ""; }
        
        let ethnics = new Set();
        if(gen.ethnics) gen.ethnics.forEach(e => ethnics.add(e.name));
        if(profiles.length > 1) profiles.forEach(p => { if(p.id!==0 && p.info.ethnicity) ethnics.add(p.info.ethnicity); });

        let ethOpts = '<option value="">Alle Ethnien</option>' + Array.from(ethnics).map(e=>`<option>${e}</option>`).join('');
        let eSelect = document.getElementById('db-f-eth');
        if(eSelect) { eSelect.innerHTML = ethOpts; eSelect.value = ""; }
        
        let rSelect = document.getElementById('db-f-risk');
        if(rSelect) rSelect.value = "";

        document.querySelectorAll('.city-dropdown').forEach(s => s.innerHTML = cityOpts);
        document.querySelectorAll('.db-city-dd').forEach(s => s.innerHTML = cityOpts);
        document.querySelectorAll('.db-eth-dd').forEach(s => s.innerHTML = ethOpts);
        
        let g = detailGroups.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
        let cmpOpts = detailComps.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');

        document.querySelectorAll('.db-entity-dd').forEach(s => {
            if (s.id === 'evt-detail-group') {
                s.innerHTML = '<option value="">Alle Detail-Gruppen</option>' + g;
            } else if (s.id === 'evt-citizen-comp') {
                s.innerHTML = '<option value="">Alle Detail-Firmen (Arbeitsplatz)</option>' + cmpOpts;
            }
        });

        let onlyCityOpts = Array.from(cities).map(c=>`<option>${c}</option>`).join('');
        if(document.getElementById('new-comp-city')) document.getElementById('new-comp-city').innerHTML = onlyCityOpts;
    }

    // --- LOGS ---
    // Modul-Mapping f√ºr Log-Eintr√§ge
    const LOG_MODULES = {
        'db': { name: 'üë• Datenbank', color: 'var(--accent)' },
        'social': { name: 'üï∏Ô∏è Social Graph', color: '#9c27b0' },
        'posts': { name: 'üì¢ Gruppen Beitr√§ge', color: 'var(--success)' },
        'noise': { name: 'üì¢ Noise Gen', color: '#ff9800' },
        'chat': { name: 'üí¨ Chat', color: '#e91e63' },
        'system': { name: 'üìú System', color: 'var(--warn)' },
        'analysts': { name: 'üéØ MunsterNET Benutzer', color: '#00bcd4' }
    };

    function addLog(t, m, module = null) {
        let now = new Date();
        let ts = now.toLocaleTimeString();
        let dateStr = now.toISOString();
        let user = getWireUsername();
        let logMsg = (t !== 'SYSTEM' && user !== 'System') ? `[${user}] ${m}` : m;

        // Auto-detect module if not specified
        if (!module) {
            if (t === 'SYSTEM') module = 'system';
            else if (t === 'EDIT') module = 'db';
            else if (t === 'POST') module = 'posts';
            else if (t === 'SIM') module = 'chat';
            else if (t === 'RISK') module = 'db';
            else module = 'system';
        }

        systemLogs.unshift({time:ts, date:dateStr, type:t, msg:logMsg, user:user, module:module});
        if(profiles[0]&&profiles[0].systemData)profiles[0].systemData.logs=systemLogs;
        renderLog();
    }
    function resetLog(){if(!confirm("Log l√∂schen?"))return;systemLogs=[];if(profiles[0]&&profiles[0].systemData)profiles[0].systemData.logs=[];renderLog();}

    function resetLogFilters() {
        document.getElementById('log-filter-module').value = '';
        document.getElementById('log-filter-user').value = '';
        document.getElementById('log-filter-from').value = '';
        document.getElementById('log-filter-to').value = '';
        document.getElementById('log-filter-search').value = '';
        renderLog();
    }

    function updateLogUserFilter() {
        let select = document.getElementById('log-filter-user');
        if (!select) return;

        // Sammle alle einzigartigen Benutzer aus den Logs
        let users = new Set();
        systemLogs.forEach(l => {
            if (l.user) users.add(l.user);
            // Auch aus der Nachricht extrahieren [username]
            let match = l.msg.match(/^\[([^\]]+)\]/);
            if (match) users.add(match[1]);
        });

        let currentVal = select.value;
        select.innerHTML = '<option value="">Alle</option>' +
            Array.from(users).sort().map(u => `<option value="${u}">${u}</option>`).join('');
        select.value = currentVal;
    }

    function renderLog() {
        if (!document.getElementById('log').classList.contains('active')) return;

        updateLogUserFilter();

        // Filter-Werte holen
        let filterModule = document.getElementById('log-filter-module')?.value || '';
        let filterUser = document.getElementById('log-filter-user')?.value || '';
        let filterFrom = document.getElementById('log-filter-from')?.value || '';
        let filterTo = document.getElementById('log-filter-to')?.value || '';
        let filterSearch = document.getElementById('log-filter-search')?.value?.toLowerCase() || '';

        // Logs filtern
        let filtered = systemLogs.filter(l => {
            // Modul-Filter
            if (filterModule) {
                // Auto-detect module f√ºr alte Logs ohne module-Feld
                let logModule = l.module;
                if (!logModule) {
                    if (l.type === 'SYSTEM') logModule = 'system';
                    else if (l.type === 'EDIT') logModule = 'db';
                    else if (l.type === 'POST') logModule = 'posts';
                    else if (l.type === 'SIM') logModule = 'chat';
                    else if (l.type === 'RISK') logModule = 'db';
                    else logModule = 'system';
                }
                if (logModule !== filterModule) return false;
            }

            // Benutzer-Filter
            if (filterUser) {
                let userMatch = l.user === filterUser || l.msg.includes(`[${filterUser}]`);
                if (!userMatch) return false;
            }

            // Datum-Filter (basierend auf l.date falls vorhanden, sonst heute)
            if (filterFrom || filterTo) {
                let logDate = l.date ? new Date(l.date) : new Date();
                if (filterFrom && logDate < new Date(filterFrom)) return false;
                if (filterTo) {
                    let toDate = new Date(filterTo);
                    toDate.setHours(23, 59, 59);
                    if (logDate > toDate) return false;
                }
            }

            // Text-Suche
            if (filterSearch && !l.msg.toLowerCase().includes(filterSearch)) return false;

            return true;
        });

        // Stats anzeigen
        let statsEl = document.getElementById('log-stats');
        if (statsEl) {
            statsEl.textContent = `Zeige ${filtered.length} von ${systemLogs.length} Eintr√§gen`;
        }

        // Logs rendern
        let h = filtered.map(l => {
            // Modul ermitteln
            let logModule = l.module;
            if (!logModule) {
                if (l.type === 'SYSTEM') logModule = 'system';
                else if (l.type === 'EDIT') logModule = 'db';
                else if (l.type === 'POST') logModule = 'posts';
                else if (l.type === 'SIM') logModule = 'chat';
                else if (l.type === 'RISK') logModule = 'db';
                else logModule = 'system';
            }

            let moduleInfo = LOG_MODULES[logModule] || { name: logModule, color: '#888' };
            let userBadge = l.user && l.user !== 'System' ? `<span style="color:var(--success); font-size:10px; margin-right:5px;">[${l.user}]</span>` : '';
            let dateBadge = l.date ? `<span style="color:#555; font-size:9px; margin-left:5px;">${new Date(l.date).toLocaleDateString('de-DE')}</span>` : '';

            return `<div class="log-entry">
                <span class="log-time">${l.time}${dateBadge}</span>
                <span class="log-type" style="color:${moduleInfo.color}; min-width:140px;">${moduleInfo.name}</span>
                <span class="log-msg">${userBadge}${l.msg.replace(/^\[[^\]]+\]\s*/, '')}</span>
            </div>`;
        }).join('');

        document.getElementById('log-container').innerHTML = h || '<div style="color:#666;text-align:center;">Keine Eintr√§ge gefunden.</div>';
    }

    function printLog() {
        // Filter-Werte holen
        let filterModule = document.getElementById('log-filter-module')?.value || '';
        let filterUser = document.getElementById('log-filter-user')?.value || '';
        let filterFrom = document.getElementById('log-filter-from')?.value || '';
        let filterTo = document.getElementById('log-filter-to')?.value || '';
        let filterSearch = document.getElementById('log-filter-search')?.value?.toLowerCase() || '';

        // Logs filtern (gleiche Logik wie renderLog)
        let filtered = systemLogs.filter(l => {
            let logModule = l.module;
            if (!logModule) {
                if (l.type === 'SYSTEM') logModule = 'system';
                else if (l.type === 'EDIT') logModule = 'db';
                else if (l.type === 'POST') logModule = 'posts';
                else if (l.type === 'SIM') logModule = 'chat';
                else if (l.type === 'RISK') logModule = 'db';
                else logModule = 'system';
            }
            if (filterModule && logModule !== filterModule) return false;
            if (filterUser) {
                let userMatch = l.user === filterUser || l.msg.includes(`[${filterUser}]`);
                if (!userMatch) return false;
            }
            if (filterFrom || filterTo) {
                let logDate = l.date ? new Date(l.date) : new Date();
                if (filterFrom && logDate < new Date(filterFrom)) return false;
                if (filterTo) {
                    let toDate = new Date(filterTo);
                    toDate.setHours(23, 59, 59);
                    if (logDate > toDate) return false;
                }
            }
            if (filterSearch && !l.msg.toLowerCase().includes(filterSearch)) return false;
            return true;
        });

        // Filter-Beschreibung erstellen
        let filterDesc = [];
        if (filterModule) {
            let moduleName = LOG_MODULES[filterModule]?.name || filterModule;
            filterDesc.push(`Modul: ${moduleName}`);
        }
        if (filterUser) filterDesc.push(`Benutzer: ${filterUser}`);
        if (filterFrom) filterDesc.push(`Von: ${new Date(filterFrom).toLocaleDateString('de-DE')}`);
        if (filterTo) filterDesc.push(`Bis: ${new Date(filterTo).toLocaleDateString('de-DE')}`);
        if (filterSearch) filterDesc.push(`Suche: "${filterSearch}"`);

        // Print-Fenster erstellen
        let printWindow = window.open('', '_blank', 'width=900,height=700');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>System Log - GHOST IN THE WIRE</title>
                <style>
                    @page { margin: 20mm 15mm; }
                    body { font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; background: white; color: black; }
                    .print-header { background: #1a1a2e; color: white; padding: 20px; margin: -20px -20px 20px -20px; }
                    .print-header h1 { margin: 0; font-size: 18px; letter-spacing: 2px; }
                    .print-header .subtitle { color: #888; font-size: 12px; margin-top: 5px; }
                    .print-meta { background: #f5f5f5; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 11px; }
                    .print-meta strong { color: #333; }
                    .filter-info { color: #666; font-style: italic; margin-top: 8px; }
                    table { width: 100%; border-collapse: collapse; font-size: 11px; }
                    th { background: #333; color: white; padding: 10px 8px; text-align: left; }
                    td { padding: 8px; border-bottom: 1px solid #ddd; vertical-align: top; }
                    tr:nth-child(even) { background: #f9f9f9; }
                    .module { font-weight: bold; white-space: nowrap; }
                    .module-db { color: #2d88ff; }
                    .module-social { color: #9c27b0; }
                    .module-posts { color: #00e676; }
                    .module-noise { color: #ff9800; }
                    .module-chat { color: #e91e63; }
                    .module-system { color: #fbc02d; }
                    .module-analysts { color: #00bcd4; }
                    .user { color: #00e676; font-weight: bold; }
                    .time { color: #666; white-space: nowrap; }
                    .msg { word-break: break-word; }
                    .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 10px; color: #888; text-align: center; }
                    @media print {
                        .no-print { display: none; }
                        .print-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>GHOST IN THE WIRE - SYSTEM LOG</h1>
                    <div class="subtitle">${meta.networkName} | ${meta.exerciseName}</div>
                </div>
                <div class="print-meta">
                    <strong>Erstellt:</strong> ${new Date().toLocaleString('de-DE')} |
                    <strong>Eintr√§ge:</strong> ${filtered.length} von ${systemLogs.length}
                    ${filterDesc.length > 0 ? `<div class="filter-info">Filter: ${filterDesc.join(' | ')}</div>` : ''}
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:130px;">Zeit</th>
                            <th style="width:140px;">Modul</th>
                            <th style="width:100px;">Benutzer</th>
                            <th>Nachricht</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(l => {
                            let logModule = l.module || 'system';
                            if (!l.module) {
                                if (l.type === 'SYSTEM') logModule = 'system';
                                else if (l.type === 'EDIT') logModule = 'db';
                                else if (l.type === 'POST') logModule = 'posts';
                                else if (l.type === 'SIM') logModule = 'chat';
                                else if (l.type === 'RISK') logModule = 'db';
                            }
                            let moduleInfo = LOG_MODULES[logModule] || { name: logModule };
                            let dateStr = l.date ? new Date(l.date).toLocaleDateString('de-DE') : '';
                            let msgClean = l.msg.replace(/^\[[^\]]+\]\s*/, '');
                            return `<tr>
                                <td class="time">${l.time}${dateStr ? '<br>' + dateStr : ''}</td>
                                <td class="module module-${logModule}">${moduleInfo.name}</td>
                                <td class="user">${l.user || '-'}</td>
                                <td class="msg">${msgClean}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                <div class="footer">
                    GHOST IN THE WIRE - Protokoll-Ausdruck | Seite <span class="pagenum"></span>
                </div>
                <div class="no-print" style="margin-top:20px; text-align:center;">
                    <button onclick="window.print()" style="padding:10px 30px; font-size:14px; cursor:pointer;">üñ®Ô∏è Drucken</button>
                    <button onclick="window.close()" style="padding:10px 30px; font-size:14px; cursor:pointer; margin-left:10px;">Schlie√üen</button>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    // --- CONFIG HELPERS ---
    function addDetailGroup() {
        let name = getVal('dg-name');
        let count = getInt('dg-count', 10);
        let city = getVal('dg-city', ''); 
        let risk = getVal('dg-risk', 'low');
        let eth = getVal('dg-eth', '');
        let priv = getInt('dg-priv', 0);

        if(!name) return alert("Name fehlt");

        detailGroups.push({ name: name, count: count, cityFilter: city, risk: risk, ethFilter: eth, priv: priv });
        alert(`Gruppe '${name}' vorgemerkt.`);
        renderDetailGroupList();
    }
    
    function addDetailComp() {
         let name = getVal('dc-name');
         let addr = getVal('dc-addr');
         let count = getInt('dc-count', 10);
         let city = getVal('dc-city', '');

         if(!name) return alert("Name fehlt");
         
         detailComps.push({ name: name, addr: addr, count: count, cityFilter: city });
         renderDetailCompList();
    }

    function renderDetailGroupList() {
        let html = detailGroups.map(g => `<div class="detail-item"><div><b>${g.name}</b> (${g.count})<br><span style="font-size:9px;color:#888">${g.cityFilter||'Alle St√§dte'}</span></div></div>`).join('');
        document.getElementById('detail-group-list').innerHTML = html;
    }
    function renderDetailCompList() {
        let html = detailComps.map(g => `<div class="detail-item"><div><b>${g.name}</b> (${g.count})<br><span style="font-size:9px;color:#888">${g.cityFilter||'Alle St√§dte'}</span></div></div>`).join('');
        document.getElementById('detail-comp-list').innerHTML = html;
    }

    // --- LIVE DB FUNCTIONS ---
    function createGroupFromDB() {
        if(profiles.length < 2) return alert("Keine Datenbank geladen.");
        
        let name = getVal('db-dg-name');
        let count = getInt('db-dg-count', 10);
        let city = getVal('db-dg-city', ''); 
        let risk = getVal('db-dg-risk', 'low');
        let eth = getVal('db-dg-eth', '');
        
        if(!name) return alert("Name fehlt");

        let candidates = profiles.filter(p => 
            p.type === 'citizen' && 
            p.id !== 0 &&
            (city === "" || p.info.city === city) &&
            (eth === "" || p.info.ethnicity === eth) &&
            p.info.club === 'Kein Verein'
        );

        if(candidates.length === 0) return alert("Keine passenden B√ºrger gefunden.");

        candidates.sort(() => Math.random() - 0.5);
        let assigned = candidates.slice(0, count);

        assigned.forEach(p => { p.info.club = name; p.info.risk = risk; });

        addLog('EDIT', `Gruppe erstellt: ${name} (${assigned.length} Mitglieder zugewiesen)`);
        alert(`Gruppe "${name}" erstellt.`);
        
        detailGroups.push({name:name, count:count, cityFilter:city, risk:risk, ethFilter:eth, priv:0});
        if(profiles[0].systemData) profiles[0].systemData.detailGroups = detailGroups;
        
        updateDBDropdowns();
        renderDB();
    }
    
    function createFirmFromDB() {
        if(profiles.length < 2) return alert("Keine Datenbank geladen.");
        
        let name = getVal('db-dc-name');
        let count = getInt('db-dc-count', 10);
        let city = getVal('db-dc-city', ''); 
        let addr = getVal('db-dc-addr', '');
        
        if(!name) return alert("Name fehlt");

        let candidates = profiles.filter(p => 
            p.type === 'citizen' && 
            p.id !== 0 &&
            p.info.job !== 'Arbeitslos' &&
            (city === "" || p.info.city === city) &&
            p.info.company === 'Keine'
        );

        if(candidates.length === 0) return alert("Keine passenden Mitarbeiter gefunden.");

        candidates.sort(() => Math.random() - 0.5);
        let assigned = candidates.slice(0, count);

        assigned.forEach(p => { p.info.company = name + (city ? `, ${city}` : '') + (addr ? ` (${addr})` : ''); });

        addLog('EDIT', `Firma erstellt: ${name} (${assigned.length} Mitarbeiter zugewiesen)`);
        alert(`Firma "${name}" erstellt.`);
        
        detailComps.push({name:name, addr:addr, count:count, cityFilter:city});
        if(profiles[0].systemData) profiles[0].systemData.detailComps = detailComps;

        updateDBDropdowns();
        renderDB();
    }

    // --- CITY CREATION WITH OPTIONAL CITIZEN GENERATION ---
    function createCityWithCitizens() {
        let cityName = getVal('db-city-name', '').trim();
        let popCount = getInt('db-city-pop', 0);

        if(!cityName) return alert("Bitte einen Stadtnamen eingeben.");

        // Check if city already exists
        if(gen.cities.some(c => c.name.toLowerCase() === cityName.toLowerCase())) {
            return alert(`Stadt "${cityName}" existiert bereits.`);
        }

        // Add city to gen.cities with the configured ethnic distribution from sliders
        let cityDistrib = [...newCityDistrib]; // Copy the slider values
        gen.cities.push({ name: cityName, distrib: cityDistrib });

        // Update systemData
        if(profiles[0] && profiles[0].systemData) {
            profiles[0].systemData.cities = gen.cities.map(c => c.name);
        }

        addLog('EDIT', `Stadt erstellt: ${cityName}`, 'db');

        // Generate citizens if requested
        if(popCount > 0) {
            if(profiles.length < 2) {
                alert(`Stadt "${cityName}" erstellt. B√ºrger k√∂nnen nur generiert werden, wenn eine Datenbank geladen ist.`);
                updateDBDropdowns();
                renderDB();
                return;
            }

            // Find max ID
            let maxId = profiles.reduce((m, p) => Math.max(m, p.id), 0);
            let currentId = maxId + 1;

            // Collect existing clubs and companies from ALL profiles
            let existingClubs = new Set();
            let existingComps = new Set();
            profiles.forEach(p => {
                if(p.id !== 0 && p.type !== 'company') {
                    if(p.info.club && p.info.club !== 'Kein Verein') existingClubs.add(p.info.club);
                    if(p.info.company && p.info.company !== 'Keine') existingComps.add(p.info.company);
                }
            });
            let clubList = Array.from(existingClubs);
            let compList = Array.from(existingComps);

            for(let i = 0; i < popCount; i++) {
                // Ethnicity based on configured distribution
                let rnd = Math.random() * 100, cur = 0;
                let eth = gen.ethnics[0] || { name: 'Unbekannt', lang: 100, priv: 0 };
                for(let j = 0; j < gen.ethnics.length; j++) {
                    let share = cityDistrib[j] || 0;
                    cur += share;
                    if(rnd <= cur) { eth = gen.ethnics[j]; break; }
                }

                // Name
                let name = fallbackDefaults[Math.floor(Math.random() * fallbackDefaults.length)];

                // Job
                let job = jobs[Math.floor(Math.random() * jobs.length)];

                // Assign to existing company (if available and not unemployed)
                let comp = 'Keine';
                if(job !== 'Arbeitslos' && compList.length > 0 && Math.random() > 0.3) {
                    comp = compList[Math.floor(Math.random() * compList.length)];
                }

                // Assign to existing club (30% chance)
                let club = 'Kein Verein';
                if(clubList.length > 0 && Math.random() < 0.3) {
                    club = clubList[Math.floor(Math.random() * clubList.length)];
                }

                // Age
                let age = 30, ra = Math.random() * 100;
                if(ra < gen.age.y) age = 16 + Math.floor(Math.random() * 14);
                else if(ra < gen.age.y + gen.age.m) age = 30 + Math.floor(Math.random() * 30);
                else age = 60 + Math.floor(Math.random() * 30);
                let dob = Math.floor(Math.random() * 28 + 1) + "." + Math.floor(Math.random() * 12 + 1) + "." + (new Date().getFullYear() - age);

                // Phone (40% chance)
                let phone = '';
                if(Math.random() < 0.4) {
                    let suffix = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                    phone = Math.random() < 0.5 ? '0171 39200 ' + suffix : '0176 040690 ' + suffix;
                }

                // Privacy
                let isPrivate = Math.random() * 100 < eth.priv;

                profiles.push({
                    id: currentId++,
                    name: name,
                    type: 'citizen',
                    settings: { isPrivate: isPrivate },
                    info: {
                        city: cityName,
                        ethnicity: eth.name,
                        job: job,
                        company: comp,
                        risk: 'low',
                        club: club,
                        languages: eth.name,
                        rel: Math.random() > 0.4 ? 'Vergeben' : 'Single',
                        dob: dob,
                        phone: phone
                    },
                    friends: [],
                    posts: [],
                    gallery: []
                });
            }

            // Assign sprites if available
            if(globalData.sprites && globalData.sprites.length > 0) {
                let newCitizens = profiles.filter(p => p.info.city === cityName && p.type === 'citizen');
                newCitizens.forEach((p, idx) => {
                    if(!p.settings.isPrivate) {
                        p.img = globalData.sprites[idx % globalData.sprites.length];
                    }
                });
            }

            addLog('EDIT', `${popCount} B√ºrger f√ºr "${cityName}" generiert (verteilt auf bestehende Firmen/Vereine)`, 'db');
            alert(`Stadt "${cityName}" mit ${popCount} B√ºrgern erstellt.\nB√ºrger wurden auf bestehende Firmen und Vereine verteilt.`);
        } else {
            alert(`Stadt "${cityName}" erfolgreich erstellt.`);
        }

        // Clear inputs and reset sliders
        document.getElementById('db-city-name').value = '';
        document.getElementById('db-city-pop').value = '';
        renderNewCityEthSliders();

        updateDBDropdowns();
        renderCityList();
        renderDB();
        renderDash();
    }

    // --- MAIN GENERATOR ---
    function runGenerator(){
        if(!confirm("Neu generieren?"))return;
        try {
            let pop=getInt('gen-pop',500); if(pop<1) pop=500;
            
            meta.networkName = getVal('gen-netname','MunsterNET');
            meta.exerciseName = getVal('gen-exercise', 'Unbenannt');
            meta.version = 1;

            if(gen.cities.length===0) gen.cities=[{name:"Munster",distrib:[100]}];
            
            if(!detailGroups) detailGroups = [];
            if(!detailComps) detailComps = [];
            
            let rc=globalData.clubs.length?globalData.clubs:defaultClubs;
            let rco=globalData.comps.length?globalData.comps:defaultComps;
            let rna=globalData.names.length?[...globalData.names]:[];
            let rpo=globalData.posts.length?[...globalData.posts]:[];
            
            // ID 0 is Admin
            profiles=[{
                id:0,
                name:"Admin", 
                type:'citizen', 
                info:{},
                posts:[],
                friends:[],
                settings:{isPrivate:false},
                meta: meta,
                systemData:{detailGroups,detailComps,cities:gen.cities.map(c=>c.name),logs:[]}
            }];

            let currentId = 1;

            // Citizens
            for(let i=0;i<pop;i++){
                let city=gen.cities[Math.floor(Math.random()*gen.cities.length)];
                let rnd=Math.random()*100, cur=0, eth=gen.ethnics[0];
                if(city.distrib && city.distrib.length > 0) {
                     for(let j=0;j<gen.ethnics.length;j++){let share = city.distrib[j] || 0; cur+=share;if(rnd<=cur){eth=gen.ethnics[j];break;}}
                }
                if(!eth) eth = {name: "Unbekannt", lang: 100, priv: 0};

                let name=rna.length?rna.shift():getRandomName();
                let job=jobs[Math.floor(Math.random()*jobs.length)], comp="Keine";
                if(job!=="Arbeitslos"&&rco.length&&Math.random()>0.2){let x=rco[Math.floor(Math.random()*rco.length)].split(',');comp=x[0].trim()+(x[1]?`, ${x[1].trim()}`:'')+(x[2]?` (${x[2].trim()})`:'');}
                let age=30,ra=Math.random()*100;
                if(ra<gen.age.y) age=16+Math.floor(Math.random()*14); else if(ra<gen.age.y+gen.age.m) age=30+Math.floor(Math.random()*30); else age=60+Math.floor(Math.random()*30);
                let dob=Math.floor(Math.random()*28+1)+"."+Math.floor(Math.random()*12+1)+"."+(new Date().getFullYear()-age);
                
                let hasPhone = Math.random() < 0.4;
                let phone = "";
                if(hasPhone) {
                    let suffix = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                    phone = Math.random() < 0.5 ? "0171 39200 " + suffix : "0176 040690 " + suffix;
                }

                let up=[]; 
                
                if(getChecked('chk-gen-posts')) {
                    let pc=Math.floor(Math.random()*getInt('gen-max-posts',5))+1, prob=getInt('gen-custom-posts-prob',20)/100;
                    for(let k=0;k<pc;k++){
                        let txt=(Math.random()<prob && rpo.length)?rpo[Math.floor(Math.random()*rpo.length)]:generateNoisePost();
                        let d=new Date(); d.setDate(d.getDate()-Math.floor(Math.random()*365));
                        let ds=d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2)+'-'+('0'+d.getDate()).slice(-2)+' '+('0'+d.getHours()).slice(-2)+':'+('0'+d.getMinutes()).slice(-2);
                        up.push({text:txt,date:ds});
                    }
                    up.sort((a,b)=>new Date(b.date)-new Date(a.date));
                }

                let isPrivate = Math.random()*100 < eth.priv;

                profiles.push({
                    id: currentId++,
                    name: name,
                    type: 'citizen',
                    settings: {isPrivate: isPrivate},
                    info: {city:city.name, ethnicity:eth.name, job:job, company:comp, risk:'low', club:'Kein Verein', languages:eth.name, rel:Math.random()>0.4?'Vergeben':'Single', dob:dob, phone:phone},
                    friends: [], posts: up, gallery: []
                });
            }

            // ASSIGN SPRITE IMAGES IF LOADED
            if(globalData.sprites.length > 0) {
                let citizens = profiles.filter(p => p.type === 'citizen' && p.id !== 0);
                citizens.forEach((p, idx) => {
                    // NEW: ONLY assign sprite if the profile is NOT private
                    if (!p.settings.isPrivate) {
                        p.img = globalData.sprites[idx % globalData.sprites.length];
                    } else {
                        p.img = ""; // Leave blank/SVG for private profiles
                    }
                });
            }

            // Companies
            let allCompanies = [...detailComps];
            rco.forEach(cStr => {
                let parts = cStr.split(',');
                allCompanies.push({name: parts[0].trim(), cityFilter: parts[1] ? parts[1].trim() : ''});
            });

            allCompanies.forEach(c => {
                if(Math.random() < 0.2) { 
                    profiles.push({
                        id: currentId++,
                        name: c.name,
                        type: 'company',
                        settings: {isPrivate: false},
                        info: {
                            city: c.cityFilter || gen.cities[0].name,
                            job: "Unternehmen",
                            company: c.name,
                            risk: 'low',
                            club: 'Kein Verein',
                            ethnicity: 'n/a'
                        },
                        friends: [], posts: [], gallery: []
                    });
                }
            });

            // Assign
            let citizens = profiles.filter(p => p.type === 'citizen');
            detailComps.forEach(d=>{let c=citizens.filter(p=>p.id!==0&&p.info.job!=='Arbeitslos'&&(d.cityFilter===''||p.info.city===d.cityFilter));c.sort(()=>Math.random()-0.5);c.slice(0,d.count).forEach(x=>x.info.company=d.name);});
            
            detailGroups.forEach(d=>{
                let c = citizens.filter(p => 
                    p.id !== 0 && 
                    (d.cityFilter === "" || p.info.city === d.cityFilter) && 
                    (d.ethFilter === "" || p.info.ethnicity === d.ethFilter)
                );
                c.sort(()=>Math.random()-0.5);
                c.slice(0,d.count).forEach(x=>{x.info.club=d.name;x.info.risk=d.risk;});
            });
            
            citizens.forEach(p=>{if(p.id!==0&&p.info.club==='Kein Verein'&&Math.random()<0.3&&rc.length){let x=rc[Math.floor(Math.random()*rc.length)].split(',');if(!x[1]||x[1].trim()===p.info.city)p.info.club=x[0].trim();}});
            
            if(getChecked('chk-gen-social')) {
                runSocialSimulation(true); 
            } else {
                updateSocialStats();
            }
            
            updateDBDropdowns();
            
            alert("Datenbank erfolgreich erstellt!"); 
            setView('db'); 
            initApp(); 
            addLog('SYSTEM','DB Generiert: '+profiles.length+' Entities ('+(profiles.length-citizens.length-1)+' Firmen)');
        } catch(e) {
            console.error(e);
        }
    }
    
    function saveSocialSettings() {
        if (!profiles[0]) return alert("Keine DB geladen.");
        if (!profiles[0].systemData) profiles[0].systemData = {};

        profiles[0].systemData.socialConfig = {
            clubGen: getInt('sg-sl-club-gen', 60),
            clubDet: getInt('sg-sl-club-det', 80),
            compDet: getInt('sg-sl-comp-det', 70),
            city: getInt('sg-sl-city', 30),
            rnd: getInt('sg-inp-rnd', 2)
        };
        alert("Sozial-Einstellungen in der Datenbank vermerkt. Bitte DB abspeichern, um sie persistent zu machen.");
        addLog('EDIT', 'Sozial-Einstellungen gespeichert.');
    }

    function loadSocialSettings() {
        if (profiles[0]?.systemData?.socialConfig) {
            const config = profiles[0].systemData.socialConfig;
            document.getElementById('sg-sl-club-gen').value = config.clubGen;
            document.getElementById('sg-v-club-gen').innerText = config.clubGen + '%';

            document.getElementById('sg-sl-club-det').value = config.clubDet;
            document.getElementById('sg-v-club-det').innerText = config.clubDet + '%';

            document.getElementById('sg-sl-comp-det').value = config.compDet;
            document.getElementById('sg-v-comp-det').innerText = config.compDet + '%';
            
            document.getElementById('sg-sl-city').value = config.city;
            document.getElementById('sg-v-city').innerText = config.city + '%';

            document.getElementById('sg-inp-rnd').value = config.rnd;
        }
    }

    function runSocialSimulation(s){
        if(profiles.length<2)return;
        let cC=getInt('sg-sl-club-gen',60)/100, dC=getInt('sg-sl-club-det',80)/100, fC=getInt('sg-sl-comp-det',70)/100, lC=getInt('sg-sl-city',30)/100, rC=getInt('sg-inp-rnd',2), n=0;
        let citizens = profiles.filter(p => p.type === 'citizen' && (p.id !== 0 || p.name !== 'Admin'));

        citizens.forEach(p=>{
            if(p.info.club!=='Kein Verein'){
                let isDet=detailGroups.some(g=>g.name===p.info.club), ch=isDet?dC:cC;
                citizens.filter(x=>x.id!==p.id&&x.info.club===p.info.club).forEach(m=>{if(Math.random()<ch){addFriend(p,m.id);n++;}});
            }
            if(p.info.company!=='Keine'){
                let isDet=detailComps.some(c=>p.info.company.startsWith(c.name));
                if(isDet) citizens.filter(x=>x.id!==p.id&&x.info.company===p.info.company).forEach(m=>{if(Math.random()<fC){addFriend(p,m.id);n++;}});
            }
            let nb=citizens.filter(x=>x.id!==p.id&&x.info.city===p.info.city);
            for(let k=0;k<5;k++) if(nb.length&&Math.random()<lC){addFriend(p,nb[Math.floor(Math.random()*nb.length)].id);n++;}
            for(let k=0;k<rC;k++){let r=citizens[Math.floor(Math.random()*citizens.length)];if(r&&r.id!==p.id){addFriend(p,r.id);n++;}}
        });
        updateSocialStats(); if(!s){alert(n+" Verbindungen."); addLog('SIM',`Social Graph Update: ${n} Verbindungen`, 'social');}
    }
    function addFriend(p,fid){if(!p.friends.includes(fid))p.friends.push(fid);let f=profiles.find(x=>x.id===fid);if(f&&!f.friends.includes(p.id))f.friends.push(p.id);}
    function updateSocialStats(){if(profiles.length<2)return;let c=0,u=0,o=0;profiles.forEach(p=>{if((p.id!==0 || p.name !== 'Admin') && p.type === 'citizen'){u++;c+=p.friends.length;if(p.friends.length===0)o++;}});document.getElementById('sg-total').innerText=Math.floor(c/2);document.getElementById('sg-avg').innerText=u?(c/u).toFixed(1):0;document.getElementById('sg-orphans').innerText=o;let hc=profiles.filter(p=>p.id!==0&&p.type==='citizen'&&p.friends.length>20).length;document.getElementById('sg-dash-stats').innerHTML=`<div style="font-size:11px;display:flex;justify-content:space-between"><span>Isoliert:</span><span style="color:var(--danger)">${o}</span></div><div style="font-size:11px;display:flex;justify-content:space-between"><span>Stark vernetzt:</span><span style="color:var(--success)">${hc}</span></div>`;}

    // --- RENDER DASHBOARD ---
    function renderDash() {
        try {
            if (!profiles || profiles.length < 2) return;
            // UPDATE: Include ID 0 if name is changed
            let citizens = profiles.filter(p => p.type === 'citizen' && (p.id !== 0 || p.name !== 'Admin'));
            
            document.getElementById('dash-total').innerText = citizens.length;
            document.getElementById('dash-netname').innerText = meta.networkName;
            let totalPosts = profiles.reduce((acc, p) => acc + (p.posts ? p.posts.length : 0), 0);
            document.getElementById('dash-posts').innerText = totalPosts;

            let ethCounts = {}, langCounts = {}, cityCounts = {}, clubCounts = {}, riskList = [];
            let cityEthMap = {}, ageGroups = { '16-29':0, '30-49':0, '50-69':0, '70+':0 };

            citizens.forEach(p => {
                if(p.info.ethnicity) ethCounts[p.info.ethnicity] = (ethCounts[p.info.ethnicity] || 0) + 1;
                if(p.info.languages) { let langs = p.info.languages.split(',').map(s => s.trim()); langs.forEach(l => langCounts[l] = (langCounts[l] || 0) + 1); }
                if(p.info.city) {
                    cityCounts[p.info.city] = (cityCounts[p.info.city] || 0) + 1;
                    if(!cityEthMap[p.info.city]) cityEthMap[p.info.city] = {}; 
                    if(p.info.ethnicity) cityEthMap[p.info.city][p.info.ethnicity] = (cityEthMap[p.info.city][p.info.ethnicity] || 0) + 1;
                }
                if (p.info.club && p.info.club !== 'Kein Verein') clubCounts[p.info.club] = (clubCounts[p.info.club] || 0) + 1;
                
                if(p.info.dob) {
                    let y = parseInt(p.info.dob.split('.').pop()); let age = new Date().getFullYear() - y;
                    if(age < 30) ageGroups['16-29']++; else if(age < 50) ageGroups['30-49']++; else if(age < 70) ageGroups['50-69']++; else ageGroups['70+']++;
                }
            });

            drawPie('pie-eth', ethCounts); drawPie('pie-lang', langCounts); drawCityEthStack('bar-city-eth', cityEthMap);
            
            let ageHtml = ""; let maxAge = Math.max(...Object.values(ageGroups));
            for(let grp in ageGroups) {
                let count = ageGroups[grp]; let pct = maxAge > 0 ? (count/maxAge)*100 : 0;
                ageHtml += `<div class="bar-chart-row"><div class="bar-chart-label">${grp}</div><div class="bar-chart-bar-bg"><div class="bar-chart-bar-fill" style="width:${pct}%"></div></div><div class="bar-chart-val">${count}</div></div>`;
            }
            document.getElementById('dash-age-chart').innerHTML = ageHtml;

            document.getElementById('legend-eth').innerHTML = Object.keys(ethCounts).map(e => `<div style="display:flex;align-items:center;gap:5px"><div class="dot" style="background:${getColor(e)}"></div>${e}</div>`).join('');
            let sortedCities = Object.entries(cityCounts).sort((a,b) => b[1] - a[1]); document.getElementById('list-city').innerHTML = sortedCities.map(x => `<div class="stat-row"><span>${x[0]}</span><span class="stat-val">${x[1]}</span></div>`).join('');
            let sortedClubs = Object.entries(clubCounts).sort((a,b) => b[1] - a[1]).slice(0, 5); document.getElementById('list-club').innerHTML = sortedClubs.map(x => `<div class="stat-row"><span>${x[0]}</span><span class="stat-val">${x[1]}</span></div>`).join('');
            
            let riskGroups = {}; citizens.forEach(p => { if(p.info.risk === 'high' && p.info.club !== 'Kein Verein') riskGroups[p.info.club] = (riskGroups[p.info.club] || 0) + 1; });
            let sortedRisk = Object.entries(riskGroups).sort((a,b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('list-risk').innerHTML = sortedRisk.length ? sortedRisk.map(x => `<div class="stat-row"><span class="stat-risk">‚ö†Ô∏è ${x[0]}</span><span class="stat-val">${x[1]}</span></div>`).join('') : '<div style="color:#666;font-style:italic">Keine Hochrisiko-Gruppen identifiziert</div>';
            
            let dcHtml = detailComps.length > 0 ? detailComps.map(c => `<div class="stat-row"><span>${c.name} <small style="color:#666">(${c.cityFilter||'Alle'})</small></span><span class="stat-val">${c.count}</span></div>`).join('') : '<div style="color:#666;font-style:italic; padding:10px;">Keine Daten vorhanden</div>';
            document.getElementById('list-det-comp').innerHTML = dcHtml;

            let dgHtml = detailGroups.length > 0 ? detailGroups.map(g => {
                let riskIcon = g.risk==='high' ? 'üî¥' : (g.risk==='mid'?'üü°':'üü¢');
                return `<div class="stat-row"><span>${riskIcon} ${g.name} <small style="color:#666">(${g.cityFilter||'Alle'})</small></span><span class="stat-val">${g.count}</span></div>`;
            }).join('') : '<div style="color:#666;font-style:italic; padding:10px;">Keine Daten vorhanden</div>';
            document.getElementById('list-det-group').innerHTML = dgHtml;
            
            if(sortedCities.length === 0) document.getElementById('list-city').innerHTML = '<div style="color:#666;font-style:italic; padding:10px;">Keine Daten vorhanden</div>';
            if(sortedClubs.length === 0) document.getElementById('list-club').innerHTML = '<div style="color:#666;font-style:italic; padding:10px;">Keine Daten vorhanden</div>';
            
            updateSocialStats();
        } catch(e) {
            console.error(e);
        }
    }
    
    // NEW: Batch Noise Generation with Types
    function generateBatchNoise(targetType) {
        if(profiles.length < 2) return alert("Keine Datenbank.");
        
        let countPerUser = 0;
        let usersAffected = 0;
        let totalPosts = 0;
        let targets = [];

        if(!targetType || targetType === 'citizen') {
             // Citizen Noise
             let prob = parseInt(document.getElementById('noise-prob').value) / 100;
             countPerUser = parseInt(document.getElementById('noise-count').value);
             targets = profiles.filter(p => p.type === 'citizen' && p.id !== 0 && Math.random() < prob);
        } else if (targetType === 'company') {
             // Company Buzz
             countPerUser = parseInt(document.getElementById('biz-noise-count').value);
             targets = profiles.filter(p => p.type === 'company');
        }

        if(countPerUser === 0) return alert("0 Posts ausgew√§hlt.");
        if(targets.length === 0) return alert("Keine Ziele gefunden.");

        let rpo = globalData.posts.length ? [...globalData.posts] : [];

        targets.forEach(p => {
             usersAffected++;
             for(let i=0; i<countPerUser; i++) {
                let now = new Date(); now.setMinutes(now.getMinutes() - Math.floor(Math.random() * 1440));
                let dStr = now.toLocaleString();
                let txt = "";
                let authorId = null; // Default: Self-post

                if(targetType === 'company') {
                    // 50% Company Self-Promo, 50% User Review
                    if(Math.random() < 0.5) {
                        txt = bizPostsSelf[Math.floor(Math.random()*bizPostsSelf.length)];
                    } else {
                        txt = bizPostsUser[Math.floor(Math.random()*bizPostsUser.length)];
                        // Find a random citizen to be the author
                        let cit = profiles[Math.floor(Math.random() * profiles.length)];
                        if(cit.type === 'citizen') authorId = cit.id; 
                    }
                } else {
                    // Normal citizen noise
                    txt = (rpo.length && Math.random() < 0.3) ? rpo[Math.floor(Math.random()*rpo.length)] : generateNoisePost();
                }

                p.posts.unshift({ text: txt, date: dStr, authorId: authorId });
                totalPosts++;
             }
        });
        
        addLog('SIM', `${targetType==='company'?'Firmen-Buzz':'Rauschen'} erzeugt: ${totalPosts} Posts.`, 'noise');
        renderEvents();
        renderDash();
        alert(`Erfolg: ${totalPosts} Posts generiert.`);
    }

    function switchDbTab(t,b){currentTab=t;document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));if(b)b.classList.add('active');document.getElementById('db-controls').style.display=(t==='citizen'||t==='company_profiles')?'flex':'none';document.getElementById('db-group-tools').style.display=t==='groups'?'block':'none';document.getElementById('db-firm-tools').style.display=t==='firms'?'block':'none';
    
    // NEW: Show Manual Company Tool
    document.getElementById('db-company-profile-tools').style.display=t==='company_profiles'?'block':'none';

    // Show City Creation Tool
    document.getElementById('db-city-tools').style.display=t==='cities'?'block':'none';
    if(t==='cities') renderNewCityEthSliders();

    renderDB();}
    
    function renderDB(f=''){
        try {
            let b=document.getElementById('db-body'), h=document.getElementById('db-head'), d=[];
            if(!profiles || profiles.length <= 1) { 
                b.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;">Keine Daten generiert. Bitte "Neu Erstellen" w√§hlen.</td></tr>'; 
                h.innerHTML = '';
                return; 
            }

            if(currentTab==='citizen' || currentTab==='company_profiles'){
                let e=getVal('db-f-eth',''), r=getVal('db-f-risk',''), ci=getVal('db-f-city','');
                let targetType = currentTab==='citizen' ? 'citizen' : 'company';
                
                d=profiles.filter(p=>{
                    // FILTER LOGIK: ID 0 (Admin) nur anzeigen, wenn Name ge√§ndert wurde!
                    if(p.id===0 && p.name === 'Admin') return false; 
                    
                    // Type Check
                    let pType = p.type || 'citizen';
                    if(pType !== targetType) return false;

                    if(targetType === 'citizen') {
                        if(e&&p.info.ethnicity!==e)return false;
                        if(r&&p.info.risk!==r)return false;
                    }
                    if(ci&&p.info.city!==ci)return false;
                    if(f&&!p.name.toLowerCase().includes(f.toLowerCase()))return false;
                    return true;
                });
                
                // Apply sorting
                if(sortState.col && d.length > 0) {
                    d.sort((a, b) => {
                        let va, vb;
                        switch(sortState.col) {
                            case 'name': va = a.name || ''; vb = b.name || ''; break;
                            case 'ethnicity': va = a.info.ethnicity || ''; vb = b.info.ethnicity || ''; break;
                            case 'city': va = a.info.city || ''; vb = b.info.city || ''; break;
                            case 'club': va = a.info.club || ''; vb = b.info.club || ''; break;
                            case 'risk':
                                let riskOrder = {high: 3, mid: 2, low: 1};
                                va = riskOrder[a.info.risk] || 0;
                                vb = riskOrder[b.info.risk] || 0;
                                break;
                            case 'job': va = a.info.job || ''; vb = b.info.job || ''; break;
                            case 'posts': va = a.posts ? a.posts.length : 0; vb = b.posts ? b.posts.length : 0; break;
                            default: va = a.name || ''; vb = b.name || '';
                        }
                        if(typeof va === 'string') {
                            return sortState.dir * va.localeCompare(vb, 'de');
                        }
                        return sortState.dir * (va - vb);
                    });
                }

                let sortIcon = (col) => sortState.col === col ? (sortState.dir === 1 ? ' ‚ñ≤' : ' ‚ñº') : '';

                if(targetType === 'citizen') {
                    h.innerHTML=`<tr>
                        <th onclick="sortDB('name')" style="cursor:pointer">Name${sortIcon('name')}</th>
                        <th onclick="sortDB('ethnicity')" style="cursor:pointer">Ethnie${sortIcon('ethnicity')}</th>
                        <th onclick="sortDB('city')" style="cursor:pointer">Stadt${sortIcon('city')}</th>
                        <th onclick="sortDB('club')" style="cursor:pointer">Club${sortIcon('club')}</th>
                        <th onclick="sortDB('risk')" style="cursor:pointer">Risk${sortIcon('risk')}</th>
                    </tr>`;
                    b.innerHTML=d.map(p=>{
                        let style = (p.id === 0) ? 'style="border-left:3px solid var(--accent); background:#1a202c"' : '';
                        return `<tr onclick="openUserAkte(${p.id})" ${style}><td>${p.name} ${p.id===0?'(Admin)':''}</td><td>${p.info.ethnicity}</td><td>${p.info.city}</td><td>${p.info.club}</td><td><div class="risk-dot ${p.info.risk==='high'?'dot-high':(p.info.risk==='mid'?'dot-mid':'dot-low')}"></div></td></tr>`;
                    }).join('');
                } else {
                    h.innerHTML=`<tr>
                        <th onclick="sortDB('name')" style="cursor:pointer">Firmenname${sortIcon('name')}</th>
                        <th onclick="sortDB('job')" style="cursor:pointer">Branche${sortIcon('job')}</th>
                        <th onclick="sortDB('city')" style="cursor:pointer">Stadt${sortIcon('city')}</th>
                        <th onclick="sortDB('posts')" style="cursor:pointer">Posts${sortIcon('posts')}</th>
                    </tr>`;
                    b.innerHTML=d.map(p=>`<tr onclick="openUserAkte(${p.id})"><td>${p.name}</td><td>${p.info.job||'-'}</td><td>${p.info.city}</td><td>${p.posts.length}</td></tr>`).join('');
                }
            } else {
                let map={}; profiles.forEach(p=>{if(p.id!==0 && p.type!=='company'){let k=currentTab==='cities'?p.info.city:(currentTab==='groups'?p.info.club:p.info.company); if(k&&k!=='Keine'&&k!=='Kein Verein') map[k]=(map[k]||0)+1;}});
                d=Object.entries(map).map(([k,v])=>({name:k,count:v})).sort((a,b)=>b.count-a.count);
                h.innerHTML=`<tr><th>Name</th><th>Einwohner/Mitglieder</th><th>Aktion</th></tr>`;
                b.innerHTML=d.map(x=>`<tr><td>${x.name}</td><td>${x.count}</td><td><button class="small" onclick="openEntityEditor('${currentTab==='groups'?'club':(currentTab==='firms'?'company':'city')}','${x.name}')">Edit</button></td></tr>`).join('');
            }
        } catch(e) {
            console.error(e);
        }
    }
    
    // NEW: MANUAL COMPANY CREATION
    function createManualCompany() {
        let name = document.getElementById('new-comp-name').value.trim();
        let job = document.getElementById('new-comp-job').value.trim();
        let city = document.getElementById('new-comp-city').value;
        let addr = document.getElementById('new-comp-addr')?.value.trim() || '';
        let phone = document.getElementById('new-comp-phone')?.value.trim() || '';
        let info = document.getElementById('new-comp-info')?.value.trim() || '';

        if(!name || !job || !city) return alert("Bitte Name, Branche und Stadt ausf√ºllen.");

        // Find max ID
        let maxId = profiles.reduce((m, p) => Math.max(m, p.id), 0);

        profiles.push({
            id: maxId + 1,
            name: name,
            type: 'company',
            settings: {isPrivate: false},
            info: {
                city: city,
                job: job,
                company: name,
                address: addr,
                phone: phone,
                description: info,
                risk: 'low',
                club: 'Kein Verein',
                ethnicity: 'n/a'
            },
            friends: [], posts: [], gallery: []
        });

        addLog('EDIT', `Firmen-Profil erstellt: ${name} (${city})${addr ? ', ' + addr : ''}`);
        alert("Firmen-Profil erstellt: " + name);

        // Clear inputs
        document.getElementById('new-comp-name').value = '';
        document.getElementById('new-comp-job').value = '';
        if(document.getElementById('new-comp-addr')) document.getElementById('new-comp-addr').value = '';
        if(document.getElementById('new-comp-phone')) document.getElementById('new-comp-phone').value = '';
        if(document.getElementById('new-comp-info')) document.getElementById('new-comp-info').value = '';

        renderDB();
        renderDash();
        updateCompanyTargetList();
    }

    // --- GLOBAL VARIABLE FOR AUTHOR SELECTION ---
    function togglePostAuthorMode() {
        let mode = document.getElementById('post-author-mode').value;
        let wrap = document.getElementById('post-author-search-wrapper');
        wrap.style.display = (mode === 'citizen') ? 'block' : 'none';
        if (mode === 'self') tempPostAuthorId = null;
    }

    function searchPostAuthor(val) {
        let res = document.getElementById('post-author-results');
        if(!val) { res.style.display='none'; return; }
        
        // Filter citizens
        let hits = profiles.filter(p => p.type === 'citizen' && p.id !== 0 && p.name.toLowerCase().includes(val.toLowerCase())).slice(0, 5);
        
        if(hits.length === 0) {
            res.innerHTML = '<div style="padding:5px; color:#888;">Keine Treffer</div>';
        } else {
            res.innerHTML = hits.map(p => 
                `<div style="padding:5px; border-bottom:1px solid #333; cursor:pointer; font-size:11px" onclick="selectPostAuthor(${p.id}, '${p.name}')">
                    <b>${p.name}</b> <span style="color:#888">(${p.info.city})</span>
                </div>`
            ).join('');
        }
        res.style.display = 'block';
    }

    function selectPostAuthor(id, name) {
        tempPostAuthorId = id;
        document.getElementById('post-author-results').style.display = 'none';
        document.getElementById('post-author-search').value = '';
        
        let disp = document.getElementById('post-author-display');
        disp.style.display = 'block';
        disp.innerText = "Ausgew√§hlt: " + name;
    }

    function sortDB(c){if(sortState.col===c)sortState.dir*=-1; else{sortState.col=c;sortState.dir=1;} renderDB();}
    
    function openUserAkte(id){
        currentEditId=id; 
        tempPostAuthorId = null; // Reset author selection
        
        let p=profiles.find(x=>x.id===id); 
        p.posts.sort((a,b)=>new Date(b.date)-new Date(a.date));
        
        let isComp = (p.type === 'company');
        document.getElementById('modal-title').innerText = isComp ? "FIRMEN-AKTE" : "B√úRGER-AKTE";
        
        let friends = "";
        if(!isComp) {
            friends = p.friends.map(fid=>{let f=profiles.find(x=>x.id===fid); return f?`<div style="background:#111;border:1px solid #444;padding:2px 5px;font-size:10px;display:flex;gap:5px"><span>${f.name}</span><span style="color:#666">(${f.info.city})</span><span style="color:red;cursor:pointer" onclick="removeFriendAction(${fid})">x</span></div>`:'';}).join('');
        }

        let posts=p.posts.map((pt,i)=>{
            let authorName = "";
            if(pt.authorId) { let a=profiles.find(x=>x.id===pt.authorId); authorName = a ? `Von: ${a.name}` : "Von: Unbekannt"; }
            return `<div class="post-edit-row"><div style="flex:1"><div style="font-size:9px;color:var(--accent)">${authorName}</div><input class="list-edit post-input-field" data-idx="${i}" value="${pt.text}" style="width:100%"></div><span style="font-size:9px;color:#666">${pt.date}</span><button class="danger small" onclick="deletePost(${i})">X</button></div>`;
        }).join('');
        
        let html=`<div style="display:flex;gap:10px;margin-bottom:10px"><div style="width:80px"><img src="${p.img||''}" style="width:80px;height:80px;background:#333;object-fit:cover"><button class="small grey" style="width:100%" onclick="document.getElementById('ak-img-up').click()">Bild</button><input type="file" id="ak-img-up" style="display:none" onchange="handlePhotoUpload(this)"><input type="hidden" id="ak-img-data"></div><div style="flex:1"><input id="ak-name" value="${p.name}" style="font-size:18px;width:100%;background:0 0;border:none"><br>`;
        
        if(!isComp) {
             html += `<select id="ak-risk"><option value="low" ${p.info.risk=='low'?'selected':''}>Gr√ºn</option><option value="mid" ${p.info.risk=='mid'?'selected':''}>Gelb</option><option value="high" ${p.info.risk=='high'?'selected':''}>Rot</option></select>`;
        }
        html += `</div></div>`;
        
        html+=`<div class="akte-grid"><div><label>Stadt</label><input id="ak-city" value="${p.info.city}">`;
        
        if(!isComp) {
            html+=`<label>Ethnie</label><input id="ak-eth" value="${p.info.ethnicity}"></div><div><label>Job</label><input id="ak-job" value="${p.info.job}"><label>Firma</label><input id="ak-comp" value="${p.info.company}"></div></div>`;
            html+=`<div style="grid-column:span 2"><label>Telefon</label><input id="ak-phone" value="${p.info.phone||''}" placeholder="0152..."></div>`;
            html+=`<div><label>Verein</label><input id="ak-club" value="${p.info.club}"></div>`;
            html+=`<div style="margin-top:10px;border-top:1px solid #333;padding-top:5px;grid-column:span 2"><h4>Freunde</h4><div style="display:flex;flex-wrap:wrap;gap:5px">${friends}</div><div style="position:relative;"><input id="friend-search-inp" placeholder="Add Freund..." onkeyup="searchFriendsUI(this.value)" style="margin-top:5px;width:100%"><div id="friend-search-results"></div></div></div>`;
        } else {
            html+=`</div><div><label>Branche/Info</label><input id="ak-job" value="${p.info.job}"></div></div>`;
        }

        // NEW POST SECTION (TARGETED)
        html+=`<div style="margin-top:10px;border-top:1px solid #333;padding-top:5px"><h4>Posts (Pinnwand)</h4>`;
        
        if(isComp) {
            html += `<div style="background:#222; padding:5px; border-radius:4px; margin-bottom:5px; border:1px solid #444;">
                <div style="font-size:10px; color:#888; margin-bottom:3px;">POSTEN ALS:</div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <select id="post-author-mode" onchange="togglePostAuthorMode()" style="flex:1">
                        <option value="self">Firma (${p.name})</option>
                        <option value="citizen">B√ºrger ausw√§hlen...</option>
                    </select>
                </div>
                <div id="post-author-search-wrapper" style="display:none; margin-top:5px; position:relative;">
                    <input id="post-author-search" placeholder="Name suchen..." onkeyup="searchPostAuthor(this.value)" style="width:100%">
                    <div id="post-author-results" style="position:absolute; top:35px; width:100%; background:#111; border:1px solid #555; z-index:10; max-height:100px; overflow-y:auto; display:none;"></div>
                    <div id="post-author-display" style="font-size:11px; color:var(--success); margin-top:2px; display:none;"></div>
                </div>
            </div>`;
        }

        html+=`<div style="display:flex;gap:5px"><input id="new-post-text" style="flex:3;min-width:150px;" placeholder="Neuer Beitrag..."><input type="datetime-local" id="new-post-date" style="width:130px;"><button class="small success" onclick="addPostToUser()">+</button></div><div style="max-height:150px;overflow-y:auto;margin-top:5px">${posts}</div></div>`;
        
        if(!isComp) {
            html+=`<div style="margin-top:10px;padding:5px;border:1px dashed #444"><label><input type="checkbox" id="ak-p-prof" ${p.settings.isPrivate?'checked':''}> Privat</label></div>`;
        }
        
        html+=`<button style="width:100%;margin-top:10px;background:var(--success);color:#000" onclick="saveAkte()">SPEICHERN</button>`;
        document.getElementById('akte-content').innerHTML=html; document.getElementById('akte-modal').style.display='flex';
    }

    function saveAkte(){
        let p=profiles.find(x=>x.id===currentEditId);
        let changes = [];

        // Hilfsfunktion zum Tracken von √Ñnderungen
        function trackChange(fieldName, oldVal, newVal, setter) {
            if (oldVal !== newVal) {
                changes.push(`${fieldName}: "${oldVal || '-'}" ‚Üí "${newVal || '-'}"`);
                setter();
            }
        }

        // Allgemeine Felder
        let nameIn = document.getElementById('ak-name');
        if(nameIn) trackChange('Name', p.name, nameIn.value, () => p.name = nameIn.value);

        let cityIn = document.getElementById('ak-city');
        if(cityIn) trackChange('Stadt', p.info.city, cityIn.value, () => p.info.city = cityIn.value);

        let jobIn = document.getElementById('ak-job');
        if(jobIn) trackChange('Job/Branche', p.info.job, jobIn.value, () => p.info.job = jobIn.value);

        // B√ºrger-spezifische Felder
        if(p.type === 'citizen') {
            let riskIn = document.getElementById('ak-risk');
            if(riskIn) trackChange('Risiko', p.info.risk, riskIn.value, () => p.info.risk = riskIn.value);

            let privIn = document.getElementById('ak-p-prof');
            if(privIn) {
                let oldPriv = p.settings.isPrivate ? 'Ja' : 'Nein';
                let newPriv = privIn.checked ? 'Ja' : 'Nein';
                trackChange('Privat', oldPriv, newPriv, () => p.settings.isPrivate = privIn.checked);
            }

            let ethIn = document.getElementById('ak-eth');
            if(ethIn) trackChange('Ethnizit√§t', p.info.ethnicity, ethIn.value, () => p.info.ethnicity = ethIn.value);

            let compIn = document.getElementById('ak-comp');
            if(compIn) trackChange('Firma', p.info.company, compIn.value, () => p.info.company = compIn.value);

            let clubIn = document.getElementById('ak-club');
            if(clubIn) trackChange('Verein', p.info.club, clubIn.value, () => p.info.club = clubIn.value);

            let phoneIn = document.getElementById('ak-phone');
            if(phoneIn) trackChange('Telefon', p.info.phone, phoneIn.value, () => p.info.phone = phoneIn.value);
        }

        // Profilbild
        let imgData = document.getElementById('ak-img-data').value;
        if(imgData && imgData !== p.img) {
            changes.push('Profilbild ge√§ndert');
            p.img = imgData;
        }

        // Posts bearbeiten
        let postInputs = document.querySelectorAll('.post-input-field');
        postInputs.forEach(inp => {
            let idx = parseInt(inp.getAttribute('data-idx'));
            if(p.posts[idx] && p.posts[idx].text !== inp.value) {
                changes.push(`Post #${idx+1} bearbeitet`);
                p.posts[idx].text = inp.value;
            }
        });

        // Neuer Post
        let newT = document.getElementById('new-post-text').value;
        if(newT) {
           let newD = document.getElementById('new-post-date').value || new Date().toISOString().slice(0,16);
           p.posts.unshift({text: newT, date: newD.replace('T',' '), authorId: null});
           addLog('POST', `Neuer Post f√ºr ${p.name} (ID:${p.id}): "${newT.substring(0,50)}${newT.length > 50 ? '...' : ''}"`);
        }

        // Log alle √Ñnderungen
        if(changes.length > 0) {
            addLog('EDIT', `${p.name} (ID:${p.id}) bearbeitet: ${changes.join(', ')}`);
        }

        document.getElementById('akte-modal').style.display='none'; renderDB(); renderDash();
    }
    
    function deletePost(i){profiles.find(x=>x.id===currentEditId).posts.splice(i,1);openUserAkte(currentEditId);addLog('EDIT','Post gel√∂scht');}
    
    function addPostToUser(){
        let t=document.getElementById('new-post-text').value;
        let d=document.getElementById('new-post-date').value;
        
        if(t){
            let dateVal=d?d.replace('T',' '):new Date().toLocaleString();
            let p=profiles.find(x=>x.id===currentEditId);
            
            let authorId = null;

            // Check Mode for Company
            let modeEl = document.getElementById('post-author-mode');
            if (modeEl && modeEl.value === 'citizen') {
                if (!tempPostAuthorId) {
                    alert("Bitte w√§hlen Sie einen B√ºrger aus der Suche aus!");
                    return;
                }
                authorId = tempPostAuthorId;
            }

            p.posts.unshift({text:t, date:dateVal, authorId: authorId});
            
            let authorName = (authorId) ? "B√ºrger (ID:"+authorId+")" : p.name;
            addLog('POST', `${authorName} postet bei ${p.name}: "${t}"`);
            
            // Refresh view to show new post
            openUserAkte(currentEditId);
        }
    }

    function handlePhotoUpload(input){if(input.files[0]){let r=new FileReader();r.onload=e=>{document.getElementById('ak-img-preview').src=e.target.result;document.getElementById('ak-img-data').value=e.target.result;};r.readAsDataURL(input.files[0]);}}
    function loadDB(el){
        let f=el.files[0];
        if(f){
            let r=new FileReader();
            r.onload=e=>{
                try{
                    let data = JSON.parse(e.target.result);
                    // Support both old format (array) and new format (object with profiles+chats)
                    if (Array.isArray(data)) {
                        profiles = data;
                        chats = {};
                    } else {
                        profiles = data.profiles || [];
                        chats = data.chats || {};
                    }
                    // Sync to server
                    syncDB();
                    initApp();
                }catch(x){alert(x);}
            };
            r.readAsText(f);
        }
    }
            function saveDB(){
                if (!Array.isArray(profiles) || profiles.length === 0) {
                    alert("Keine Daten zum Speichern.");
                    return;
                }
                // Save both profiles and chats
                const db = { profiles: profiles, chats: chats || {} };
                let a=document.createElement('a');
                a.href=URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)],{type:"application/json"}));
        
                let exerciseName = "Unbenannt"; // Default
                if (meta && meta.exerciseName) {
                    exerciseName = meta.exerciseName;
                }
        
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const month = monthNames[now.getMonth()];
                const dateString = `${day}${hours}${minutes}${month}`;
        
                const filename = `${exerciseName}_${dateString}.json`;
        
                a.download = filename;
                a.click();
            }

    // Sync database to server via WebSocket
    function syncDB() {
        if (ws && ws.readyState === 1) {
            const db = { profiles: profiles, chats: chats };
            ws.send(JSON.stringify({ action: 'syncDB', payload: db }));
            console.log('Database synced to server');
        } else {
            console.warn('Cannot sync: WebSocket not connected');
        }
    }

    function setView(v){
        if ((v === 'evt' || v === 'db') && profiles.length <= 1) {
            alert("Bitte zuerst eine Datenbank laden oder erstellen, um die Dropdowns zu f√ºllen.");
        }
        document.querySelectorAll('.main').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        document.getElementById(v).classList.add('active');
        const btn = document.getElementById('btn-'+v);
        if(btn) btn.classList.add('active');
        if(v==='dash')renderDash();
        if(v==='db')renderDB();
        if(v==='evt')renderEvents();
        if(v==='log')renderLog();
        if(v==='analysts')loadAnalysts();
        if(v==='chat')renderChatList();
    }

    // --- Analyst Management ---
    async function loadAnalysts() {
        const container = document.getElementById('analysts-list');
        try {
            const resp = await fetch('/api/analysts');
            if (!resp.ok) throw new Error('Failed to fetch');
            const analysts = await resp.json();

            if (analysts.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Keine MunsterNET Benutzer registriert.</div>';
                return;
            }

            // Z√§hle Online-User
            const onlineCount = analysts.filter(a => connectedClients.has(a.profileId)).length;

            let html = `<div style="margin-bottom:10px; font-size:12px; color:#888;">
                <span class="online-dot online"></span> ${onlineCount} Online &nbsp;&nbsp;
                <span class="online-dot offline"></span> ${analysts.length - onlineCount} Offline
            </div>`;

            html += '<table class="data-table"><thead><tr><th>Status</th><th>Benutzername</th><th>Profil</th><th>Aktionen</th></tr></thead><tbody>';
            for (const a of analysts) {
                const profile = profiles.find(p => p.id === a.profileId);
                const profileName = profile ? profile.name : '(nicht gefunden)';
                const isOnline = connectedClients.has(a.profileId);
                const statusDot = isOnline
                    ? '<span class="online-dot online" title="Online"></span>'
                    : '<span class="online-dot offline" title="Offline"></span>';
                const statusText = isOnline ? '<span style="color:var(--success)">Online</span>' : '<span style="color:#666">Offline</span>';

                html += `<tr>
                    <td>${statusDot} ${statusText}</td>
                    <td>${a.username}</td>
                    <td>${a.profileId} - ${profileName}</td>
                    <td>
                        <button class="small" onclick="openUserDetail('${a.username}', ${a.profileId})" style="margin-right:5px;">üìã Details</button>
                        <button class="small danger" onclick="deleteAnalyst('${a.username}')">L√∂schen</button>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<div style="color:var(--danger); padding:20px;">Fehler beim Laden der MunsterNET Benutzer.</div>';
            console.error('Error loading analysts:', e);
        }
    }

    async function createAnalyst() {
        const username = document.getElementById('new-analyst-name').value.trim();
        const password = document.getElementById('new-analyst-pass').value;

        if (!username || !password) {
            alert('Benutzername und Passwort sind erforderlich.');
            return;
        }

        try {
            const resp = await fetch('/api/analysts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await resp.json();

            if (resp.ok) {
                alert(`Analyst "${username}" erstellt mit Profil-ID ${data.profileId}`);
                document.getElementById('new-analyst-name').value = '';
                document.getElementById('new-analyst-pass').value = '';
                loadAnalysts();
            } else {
                alert('Fehler: ' + data.message);
            }
        } catch (e) {
            alert('Fehler beim Erstellen des MunsterNET Benutzers.');
            console.error('Error creating analyst:', e);
        }
    }

    async function deleteAnalyst(username) {
        if (!confirm(`Analyst "${username}" wirklich l√∂schen? Das Profil in der Datenbank bleibt erhalten.`)) return;

        try {
            const resp = await fetch('/api/analysts/' + encodeURIComponent(username), {
                method: 'DELETE'
            });
            const data = await resp.json();

            if (resp.ok) {
                alert(`Analyst "${username}" gel√∂scht.`);
                loadAnalysts();
            } else {
                alert('Fehler: ' + data.message);
            }
        } catch (e) {
            alert('Fehler beim L√∂schen des MunsterNET Benutzers.');
            console.error('Error deleting analyst:', e);
        }
    }

    // --- BENUTZER-DETAIL-ANSICHT ---
    async function openUserDetail(username, profileId) {
        const modal = document.getElementById('user-detail-modal');
        const content = document.getElementById('user-detail-content');
        const title = document.getElementById('user-detail-title');

        content.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">Lade Benutzer-Daten...</div>';
        modal.style.display = 'flex';

        try {
            // Lade Benutzer-Details (inkl. Passwort)
            let userDetails = { username, password: '(Nicht verf√ºgbar)', profileId };
            try {
                const detailResp = await fetch(`/api/analysts/${encodeURIComponent(username)}/details`);
                if (detailResp.ok) {
                    userDetails = await detailResp.json();
                } else {
                    console.error('Details API Error:', detailResp.status, await detailResp.text());
                }
            } catch (fetchErr) {
                console.error('Details Fetch Error:', fetchErr);
            }

            // Finde Profil in der Datenbank
            const profile = profiles.find(p => p.id === profileId) || {};
            const isOnline = connectedClients.has(profileId);

            // Finde alle Chats dieses Benutzers
            const userChats = [];
            for (let convoId in chats) {
                const ids = convoId.split('--').map(Number);
                if (ids.includes(profileId)) {
                    const otherId = ids.find(id => id !== profileId);
                    const otherProfile = profiles.find(p => p.id === otherId);
                    userChats.push({
                        convoId,
                        otherName: otherProfile ? otherProfile.name : `ID:${otherId}`,
                        otherId,
                        messages: chats[convoId] || []
                    });
                }
            }

            // Aktivit√§ts-Log
            const activityLog = profile.activityLog || [];

            // Generiere HTML
            title.innerHTML = `BENUTZER-AKTE: ${username} ${isOnline ? '<span class="online-dot online"></span>' : '<span class="online-dot offline"></span>'}`;

            const networkName = meta?.networkName || 'MunsterNET';
            const exerciseName = meta?.exerciseName || '√úbung';

            let html = `
                <!-- Print Header (nur beim Drucken sichtbar - fixiert auf jeder Seite) -->
                <div class="print-only-header">
                    <div class="print-header-top">
                        <div class="print-header-left">
                            <div class="print-logo">GHOST IN THE WIRE</div>
                            <div class="print-protocol">PROTOCOL</div>
                        </div>
                        <div class="print-page-number"></div>
                    </div>
                    <div class="print-header-info">
                        <div><strong>NETZWERK:</strong> ${networkName}</div>
                        <div><strong>OPERATION:</strong> ${exerciseName}</div>
                        <div><strong>DOKUMENT:</strong> Benutzer-Akte</div>
                    </div>
                </div>
                <!-- Platzhalter f√ºr festen Header -->
                <div class="print-header-spacer" style="display:none;"></div>

                <!-- Kopfzeile -->
                <div class="user-detail-section" style="background:#0a2540;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:24px; font-weight:bold; color:white;">${profile.name || username}</div>
                            <div style="color:#888; font-size:12px; margin-top:5px;">Login: ${username} | Profil-ID: ${profileId}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; color:${isOnline ? 'var(--success)' : '#666'};">${isOnline ? '‚óè ONLINE' : '‚óã OFFLINE'}</div>
                            <div style="font-size:10px; color:#666; margin-top:5px;">Erstellt: ${new Date().toLocaleDateString('de-DE')}</div>
                        </div>
                    </div>
                </div>

                <!-- Login-Daten -->
                <div class="user-detail-section">
                    <h4>üîê Login-Daten</h4>
                    <div class="user-detail-grid">
                        <div class="user-detail-item">
                            <label>Benutzername (Login)</label>
                            <span>${userDetails.username}</span>
                        </div>
                        <div class="user-detail-item password">
                            <label>Passwort</label>
                            <span>${userDetails.password}</span>
                        </div>
                    </div>
                </div>

                <!-- Profil-Daten -->
                <div class="user-detail-section">
                    <h4>üë§ Profil-Informationen</h4>
                    <div class="user-detail-grid">
                        <div class="user-detail-item">
                            <label>Anzeigename</label>
                            <span>${profile.name || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Stadt</label>
                            <span>${profile.info?.city || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Beruf</label>
                            <span>${profile.info?.job || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Firma</label>
                            <span>${profile.info?.company || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Ethnizit√§t</label>
                            <span>${profile.info?.ethnicity || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Beziehungsstatus</label>
                            <span>${profile.info?.rel || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Verein</label>
                            <span>${profile.info?.club || '-'}</span>
                        </div>
                        <div class="user-detail-item">
                            <label>Risiko-Stufe</label>
                            <span>${profile.info?.risk || 'low'}</span>
                        </div>
                    </div>
                </div>

                <!-- Aktivit√§ts-Log -->
                <div class="user-detail-section">
                    <h4>üìä Aktivit√§ts-Protokoll (${activityLog.length} Eintr√§ge)</h4>
                    ${activityLog.length === 0
                        ? '<div style="color:#666; text-align:center; padding:20px;">Keine Aktivit√§ten aufgezeichnet.</div>'
                        : `<div class="activity-log-list">
                            ${activityLog.slice().reverse().map(a => {
                                let actionLabel = a.action;
                                let detailsHtml = '';

                                if (a.action === 'PROFIL_BESUCH') {
                                    actionLabel = 'üëÅÔ∏è Profil angeschaut';
                                    const vpId = a.details?.viewedProfileId;
                                    detailsHtml = `<span class="clickable-profile" onclick="openUserAkte(${vpId})">${a.details?.viewedProfileName || 'Unbekannt'}</span> (ID: ${vpId})`;
                                } else if (a.action === 'NACHRICHT_GESENDET') {
                                    actionLabel = 'üí¨ Nachricht gesendet';
                                    const toId = a.details?.toId;
                                    detailsHtml = `An <span class="clickable-profile" onclick="openUserAkte(${toId})">${a.details?.toName || 'Unbekannt'}</span>: "${a.details?.messagePreview || ''}"`;
                                } else {
                                    detailsHtml = JSON.stringify(a.details || {});
                                }

                                const ts = new Date(a.timestamp);
                                const timeStr = ts.toLocaleDateString('de-DE') + ' ' + ts.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

                                return `<div class="activity-log-entry">
                                    <span class="activity-log-time">${timeStr}</span>
                                    <span class="activity-log-action">${actionLabel}</span>
                                    <span class="activity-log-details">${detailsHtml}</span>
                                </div>`;
                            }).join('')}
                        </div>`
                    }
                </div>

                <!-- Chat-Verl√§ufe -->
                <div class="user-detail-section">
                    <h4>üí¨ Chat-Verl√§ufe (${userChats.length} Konversationen)</h4>
                    ${userChats.length === 0
                        ? '<div style="color:#666; text-align:center; padding:20px;">Keine Chat-Verl√§ufe vorhanden.</div>'
                        : userChats.map((chat, idx) => {
                            const msgCount = chat.messages.length;
                            const lastMsg = chat.messages[chat.messages.length - 1];
                            const lastTime = lastMsg ? new Date(lastMsg.timestamp).toLocaleString('de-DE') : '-';

                            return `<div class="chat-history-section">
                                <div class="chat-history-header" onclick="toggleChatHistory(${idx})">
                                    <span>
                                        <span class="clickable-profile" onclick="event.stopPropagation(); openUserAkte(${chat.otherId})">${chat.otherName}</span>
                                        (${msgCount} Nachrichten)
                                    </span>
                                    <span style="color:#666; font-size:11px;">Letzte: ${lastTime} ‚ñº</span>
                                </div>
                                <div class="chat-history-body" id="chat-history-${idx}">
                                    ${chat.messages.map(m => {
                                        const isSent = m.fromId === profileId;
                                        const msgTime = new Date(m.timestamp).toLocaleString('de-DE');
                                        const senderId = m.fromId;
                                        const senderName = isSent ? (profile.name || username) : chat.otherName;
                                        return `<div class="chat-msg-row ${isSent ? 'sent' : 'received'}">
                                            <div>${m.text}</div>
                                            <div class="chat-msg-meta">
                                                <span class="clickable-profile" onclick="openUserAkte(${senderId})">${senderName}</span> - ${msgTime}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>`;
                        }).join('')
                    }
                </div>

                <!-- Beitr√§ge -->
                <div class="user-detail-section">
                    <h4>üìù Beitr√§ge (${(profile.posts || []).length})</h4>
                    ${(profile.posts || []).length === 0
                        ? '<div style="color:#666; text-align:center; padding:20px;">Keine Beitr√§ge vorhanden.</div>'
                        : `<div style="max-height:200px; overflow-y:auto;">
                            ${(profile.posts || []).map(post => {
                                const postDate = post.date ? new Date(post.date).toLocaleString('de-DE') : '-';
                                return `<div style="background:#1a1a1a; padding:10px; margin:5px 0; border-radius:4px; border-left:3px solid var(--accent);">
                                    <div style="font-size:12px;">${post.text}</div>
                                    <div style="font-size:10px; color:#666; margin-top:5px;">${postDate}</div>
                                </div>`;
                            }).join('')}
                        </div>`
                    }
                </div>

                <!-- Freunde -->
                <div class="user-detail-section">
                    <h4>üë• Verbindungen (${(profile.friends || []).length})</h4>
                    ${(profile.friends || []).length === 0
                        ? '<div style="color:#666; text-align:center; padding:20px;">Keine Verbindungen vorhanden.</div>'
                        : `<div style="display:flex; flex-wrap:wrap; gap:10px;">
                            ${(profile.friends || []).map(fid => {
                                const friend = profiles.find(p => p.id === fid);
                                return friend ? `<div style="background:#1a1a1a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer; transition:all 0.2s;" onclick="openUserAkte(${fid})" onmouseover="this.style.background='var(--accent)'" onmouseout="this.style.background='#1a1a1a'">${friend.name} (ID:${fid})</div>` : '';
                            }).join('')}
                        </div>`
                    }
                </div>

                <!-- Footer mit Zeitstempel -->
                <div class="user-detail-section" style="background:#0a0a0a; text-align:center; color:#666; font-size:11px;">
                    Bericht generiert am ${new Date().toLocaleString('de-DE')} | MunsterNET Admin System
                </div>
            `;

            content.innerHTML = html;

        } catch (e) {
            content.innerHTML = `<div style="padding:40px; text-align:center; color:var(--danger);">Fehler beim Laden der Daten: ${e.message}</div>`;
            console.error('Error loading user details:', e);
        }
    }

    function toggleChatHistory(idx) {
        const body = document.getElementById(`chat-history-${idx}`);
        if (body) body.classList.toggle('open');
    }

    function printUserDetail() {
        // Hole die aktuellen Daten aus dem Modal
        const content = document.getElementById('user-detail-content');
        const title = document.getElementById('user-detail-title');
        if (!content || !title) return;

        const networkName = meta?.networkName || 'MunsterNET';
        const exerciseName = meta?.exerciseName || '√úbung';
        const dateStr = new Date().toLocaleString('de-DE');

        const printWin = window.open('', '_blank', 'width=900,height=700');
        printWin.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${title.textContent} - GHOST IN THE WIRE</title>
                <style>
                    @page { margin: 20mm 15mm; }
                    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: white; color: black; }

                    .print-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; }
                    .print-header h1 { margin: 0; font-size: 18px; letter-spacing: 2px; }
                    .print-header .subtitle { color: #888; font-size: 12px; margin-top: 5px; }
                    .print-meta { background: #f5f5f5; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 11px; display: flex; gap: 20px; }
                    .print-meta strong { color: #333; }

                    .user-detail-section { background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 4px; page-break-inside: avoid; }
                    .user-detail-section h4 { margin: 0 0 12px 0; color: #007bff; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
                    .user-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                    .user-detail-item { background: white; padding: 10px; border-radius: 4px; border-left: 3px solid #007bff; }
                    .user-detail-item label { font-size: 10px; color: #666; display: block; margin-bottom: 3px; text-transform: uppercase; }
                    .user-detail-item span { font-size: 13px; color: #000; }

                    .activity-log-list { background: white; border: 1px solid #ddd; border-radius: 4px; }
                    .activity-log-entry { padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; gap: 15px; }
                    .activity-log-time { color: #666; min-width: 120px; }
                    .activity-log-action { color: #007bff; font-weight: bold; min-width: 140px; }
                    .activity-log-details { color: #333; }

                    .chat-history-section { background: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
                    .chat-history-header { padding: 10px 15px; background: #f0f0f0; font-weight: bold; }
                    .chat-history-body { padding: 10px; display: block !important; }
                    .chat-msg-row { padding: 8px 12px; margin: 5px 0; border-radius: 8px; font-size: 12px; }
                    .chat-msg-row.sent { background: #e3f2fd; margin-left: 20%; text-align: right; }
                    .chat-msg-row.received { background: #f5f5f5; margin-right: 20%; }
                    .chat-msg-meta { font-size: 10px; color: #666; margin-top: 3px; }

                    .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 10px; color: #888; text-align: center; }
                    .no-print { margin-top: 20px; text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px; }
                    .clickable-profile { color: #000; text-decoration: none; cursor: default; }
                    .online-dot { display: none; }

                    @media print {
                        .no-print { display: none !important; }
                        .print-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .user-detail-section { background: #f9f9f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>GHOST IN THE WIRE - BENUTZER-AKTE</h1>
                    <div class="subtitle">${networkName} | ${exerciseName}</div>
                </div>
                <div class="print-meta">
                    <div><strong>Erstellt:</strong> ${dateStr}</div>
                    <div><strong>Dokument:</strong> ${title.textContent.replace(/<[^>]*>/g, '')}</div>
                </div>

                ${content.innerHTML}

                <div class="footer">
                    GHOST IN THE WIRE - Benutzer-Akte Ausdruck | MunsterNET Admin System
                </div>
                <div class="no-print">
                    <button onclick="window.print()" style="padding:10px 30px; font-size:14px; cursor:pointer; background:#2d88ff; color:white; border:none; border-radius:4px;">üñ®Ô∏è Drucken</button>
                    <button onclick="window.close()" style="padding:10px 30px; font-size:14px; cursor:pointer; margin-left:10px; background:#666; color:white; border:none; border-radius:4px;">Schlie√üen</button>
                </div>
            </body>
            </html>
        `);
        printWin.document.close();
    }

    function getColor(str){let h=0;for(let i=0;i<str.length;i++)h=str.charCodeAt(i)+((h<<5)-h);let c=(h&0x00FFFFFF).toString(16).toUpperCase();return'#'+'00000'.substring(0,6-c.length)+c;}
    function drawPie(id,data){let e=Object.entries(data).sort((a,b)=>b[1]-a[1]),t=e.reduce((a,b)=>a+b[1],0);if(!t)return;let a=0,s=`<svg viewBox="-1 -1 2 2" style="transform:rotate(-90deg);width:150px;height:150px">`;e.forEach(x=>{let v=x[1]/t,x1=Math.cos(2*Math.PI*a),y1=Math.sin(2*Math.PI*a);a+=v;let x2=Math.cos(2*Math.PI*a),y2=Math.sin(2*Math.PI*a);s+=`<path d="M0 0 L${x1} ${y1} A1 1 0 ${v>.5?1:0} 1 ${x2} ${y2} Z" fill="${getColor(x[0])}"></path>`});s+=`</svg>`;let l=`<div class="pie-legend">`+e.slice(0,5).map(x=>`<div class="legend-item"><div class="dot" style="background:${getColor(x[0])}"></div>${x[0]} <b style="margin-left:auto">${Math.round(x[1]/t*100)}%</b></div>`).join('')+`</div>`;document.getElementById(id).innerHTML=`<div class="pie-wrapper">${s}${l}</div>`;}
    function drawCityEthStack(id,data){let h="";for(let c in data){let e=data[c],t=Object.values(e).reduce((a,b)=>a+b,0),b=Object.entries(e).map(x=>`<div class="stack-seg" style="width:${(x[1]/t)*100}%;background:${getColor(x[0])}"></div>`).join('');h+=`<div class="stack-bar-container"><div class="stack-label">${c} (${t})</div><div class="stack-bar">${b}</div></div>`;}document.getElementById(id).innerHTML=h;}
    function removeFriendAction(fid) { 
        if(!confirm("L√∂schen?")) return;
        let p = profiles.find(x=>x.id===currentEditId);
        let f = profiles.find(x=>x.id===fid);
        p.friends = p.friends.filter(id=>id!==fid);
        if(f) f.friends = f.friends.filter(id=>id!==currentEditId);
        openUserAkte(currentEditId); 
        addLog('EDIT', `Freundschaft gel√∂scht: ${p.name} (ID:${p.id}) <-> ${f ? f.name : 'Unknown'} (ID:${fid})`);
    } 
    function openEntityEditor(t,n) { 
        let c=profiles.filter(p=>p.info[t]===n).length;
        let h=`<h3>${t.toUpperCase()}: ${n}</h3><p>${c} Mitglieder</p><label>Umbenennen</label><input id="ent-ren" value="${n}"><button onclick="doRename('${t}','${n}')">Speichern</button>`;
        document.getElementById('akte-content').innerHTML=h; document.getElementById('akte-modal').style.display='flex';
    } 
    function doRename(t,old){let n=document.getElementById('ent-ren').value;profiles.forEach(p=>{if(p.info[t]===old)p.info[t]=n;});alert("Umbenannt!");document.getElementById('akte-modal').style.display='none';renderDB();renderDash();addLog('EDIT', t+' umbenannt: '+old+' -> '+n);}
    function searchFriendsUI(v){
        let d=document.getElementById('friend-search-results');
        if(!v){d.style.display='none';return;}
        let h=profiles.filter(p=>p.id!==0&&p.id!==currentEditId&&p.name.toLowerCase().includes(v.toLowerCase())).slice(0,5);
        d.innerHTML=h.map(p=>`<div style="padding:8px;background:#222;cursor:pointer;border-bottom:1px solid #444;color:#eee;" onclick="addFriendAction(${p.id})">${p.name} <small style='color:#888'>(${p.info.city})</small></div>`).join('');
        d.style.display='block';
    }
    
    function addFriendAction(fid) {
        let p = profiles.find(x=>x.id===currentEditId);
        if(!p.friends.includes(fid)) {
            p.friends.push(fid);
            let f = profiles.find(x=>x.id===fid);
            if(f && !f.friends.includes(currentEditId)) f.friends.push(currentEditId);
            openUserAkte(currentEditId);
            addLog('EDIT', `Freundschaft: ${p.name} (ID:${p.id}) <-> ${f.name} (ID:${f.id})`);
        }
    }
    function toggleEventFilters() {
        const targetType = document.getElementById('evt-target-type').value;
        const citizenFilters = document.getElementById('citizen-filters');
        const companyFilters = document.getElementById('company-filters');

        if (targetType === 'citizen') {
            citizenFilters.style.display = 'block';
            companyFilters.style.display = 'none';
        } else {
            citizenFilters.style.display = 'none';
            companyFilters.style.display = 'block';
        }
    }

    function updateCompanyTargetList() {
        const source = getVal('evt-comp-source', 'all');
        const targetDropdown = document.getElementById('evt-target-comp');
        let cmpOpts = '';

        if (source === 'all') {
            const allCompanyNames = profiles.filter(p => p.type === 'company').map(p => p.name);
            const uniqueCompanyNames = [...new Set(allCompanyNames)];
            cmpOpts = uniqueCompanyNames.map(name => `<option value="${name}">${name}</option>`).join('');
            targetDropdown.innerHTML = '<option value="">Alle Firmen-Profile</option>' + cmpOpts;
        } else { // source === 'detail'
            cmpOpts = detailComps.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
            targetDropdown.innerHTML = '<option value="">Alle Detail-Firmen</option>' + cmpOpts;
        }
    }

    function executeEvent() {
        if(profiles.length < 2) return alert("Keine Datenbank.");
        
        const targetType = getVal('evt-target-type', 'citizen');
        const textRaw = getVal('evt-texts', '');
        if(!textRaw) return alert("Kein Textinhalt definiert.");
        const texts = textRaw.split('\n').filter(t => t.trim() !== '');
        
        let targets = [];
        let count = 0;

        if (targetType === 'citizen') {
            const city = getVal('evt-city', ''), club = getVal('evt-detail-group', ''), comp = getVal('evt-citizen-comp', ''), eth = getVal('evt-eth', ''), ageMin = getInt('evt-age-min', 0), ageMax = getInt('evt-age-max', 999);
            
            targets = profiles.filter(p => {
                if(p.type !== 'citizen' || p.id === 0) return false;
                if(city && p.info.city !== city) return false;
                if(club && p.info.club !== club) return false;
                if(comp && !p.info.company.startsWith(comp)) return false;
                if(eth && p.info.ethnicity !== eth) return false;
                let y = parseInt(p.info.dob.split('.').pop()); let age = new Date().getFullYear() - y;
                if(age < ageMin || age > ageMax) return false;
                return true;
            });
        } else { // targetType === 'company'
            const city = getVal('evt-comp-city', '');
            const compName = getVal('evt-target-comp', '');

            targets = profiles.filter(p => {
                if (p.type !== 'company') return false;
                if (city && p.info.city !== city) return false;
                if (compName && p.name !== compName) return false;
                return true;
            });
        }

        if(targets.length === 0) return alert("Keine Ziel-Profile gefunden mit diesen Filtern.");
        
        targets.forEach(p => {
            let msg = texts[Math.floor(Math.random() * texts.length)];
            let now = new Date(); now.setMinutes(now.getMinutes() - Math.floor(Math.random()*60));
            let dStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
            
            p.posts.unshift({ text: msg, date: dStr, authorId: null }); 
            count++;
        });

        alert(`Kampagne ausgef√ºhrt: ${count} Posts erstellt.`);
        addLog('POST', `Kampagne f√ºr '${targetType}' ausgef√ºhrt. ${count} Posts erstellt.`, 'posts');
        renderEvents(); renderDash();
    }
    
    function saveEventScenario() {
        let name = getVal('evt-name', 'Unbenannt');
        let scenario = { name: name, city: getVal('evt-city', ''), club: getVal('evt-detail-group', ''), comp: getVal('evt-detail-comp', ''), eth: getVal('evt-eth', ''), texts: getVal('evt-texts', '') };
        eventScenarios.push(scenario); renderSavedScenarios();
    }
    function renderSavedScenarios() { document.getElementById('evt-saved-list').innerHTML = eventScenarios.map((s, i) => `<div class="saved-scenario" onclick="loadScenario(${i})"><b>${s.name}</b><br><span style="color:#666">${s.city||'*'}, ${s.club||'*'}</span></div>` ).join(''); }
    function loadScenario(i) { let s = eventScenarios[i]; document.getElementById('evt-name').value = s.name; document.getElementById('evt-city').value = s.city; document.getElementById('evt-detail-group').value = s.club; document.getElementById('evt-detail-comp').value = s.comp; document.getElementById('evt-eth').value = s.eth; document.getElementById('evt-texts').value = s.texts; }
    function renderEvents() {
        let container = document.getElementById('event-list');
        let allPosts = [];
        profiles.forEach(p => { if(p.id !== 0 && p.posts && p.posts.length > 0) { p.posts.forEach(post => { allPosts.push({ uId: p.id, uName: p.name, uCity: p.info.city, uRisk: p.info.risk, text: post.text, date: post.date, ts: new Date(post.date).getTime() }); }); } });
        allPosts.sort((a,b) => b.ts - a.ts);
        let html = allPosts.slice(0, 100).map(post => {
            let riskColor = post.uRisk === 'high' ? 'var(--danger)' : (post.uRisk === 'mid' ? 'var(--warn)' : '#888');
            return `<div style="border-bottom:1px solid #333; padding:8px 0;"><div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span style="font-weight:bold; color:var(--accent); cursor:pointer" onclick="openUserAkte(${post.uId})">${post.uName}</span><span style="color:#666; font-size:10px;">${post.date}</span></div><div style="font-size:10px; color:${riskColor}; margin-bottom:4px;">${post.uCity}</div><div style="color:#ddd;">${post.text}</div></div>`;
        }).join('');
        container.innerHTML = html || '<div style="padding:20px; text-align:center; color:#666">Keine Aktivit√§ten aufgezeichnet.</div>';
    }

    // --- ADMIN CHAT & NOTIFICATIONS ---
    let currentChatConvoId = null;
    let currentReplyId = 0; // The ID we are impersonating
    let unreadChats = new Set();
    let connectedClients = new Map(); // Tracks connected player IDs (received from server) 

    function getConvos() {
        let convos = [];
        if (!Array.isArray(profiles) || profiles.length === 0) return convos;

        for (let cid in chats) {
            let msgs = chats[cid];
            if (!msgs || msgs.length === 0) continue;

            let lastMsg = msgs[msgs.length - 1];
            let ids = cid.split('--').map(Number);

            let p1 = profiles.find(p => p.id === ids[0]);
            let p2 = profiles.find(p => p.id === ids[1]);

            // Skip if a profile for a chat doesn't exist
            if (!p1 || !p2) continue;
            
            let name1 = p1 ? `${p1.name} <small>#${p1.id}</small>` : `ID:${ids[0]}`;
            let name2 = p2 ? `${p2.name} <small>#${p2.id}</small>` : `ID:${ids[1]}`;
            
            convos.push({
                id: cid,
                ids: ids,
                names: [name1, name2],
                lastMsg: lastMsg,
                ts: new Date(lastMsg.timestamp).getTime()
            });
        }
        return convos.sort((a,b) => b.ts - a.ts);
    }

    function renderChatList() {
        let list = getConvos();
        let el = document.getElementById('chat-list-container');

        if (list.length === 0) {
            el.innerHTML = '<div style="padding:20px; text-align:center; color:#666">Keine aktiven Chats.</div>';
            return;
        }

        el.innerHTML = list.map(c => {
            let isUnread = (unreadChats.has(c.id) && currentChatConvoId !== c.id);

            // Simple: Just show the two participants' names
            let icon = "üí¨";
            let label = `${c.names[0]} & ${c.names[1]}`;

            // Show last message sender
            let senderName = c.ids[0] === c.lastMsg.fromId ? c.names[0] : c.names[1];
            let sub = `${senderName.replace(/<[^>]*>/g, '')}: ${c.lastMsg.text}`;

            let activeClass = (c.id === currentChatConvoId) ? 'active' : '';
            let unreadClass = isUnread ? 'unread' : '';

            return `
                <div class="convo-item ${activeClass} ${unreadClass}">
                    <div style="flex:1; cursor:pointer;" onclick="openChat('${c.id}')">
                        <div class="convo-names">${icon} ${label}</div>
                        <div class="convo-sub">${sub}</div>
                    </div>
                    <button onclick="event.stopPropagation(); openChatPopup('${c.id}')" title="In neuem Fenster √∂ffnen" style="background:transparent; border:1px solid #444; color:var(--success); padding:4px 8px; cursor:pointer; border-radius:4px; font-size:12px;">üì∫</button>
                </div>
            `;
        }).join('');
    }

    function openChat(cid) {
        currentChatConvoId = cid;
        unreadChats.delete(cid); 
        updateNotifications(); 
        renderChatList(); 

        let msgs = chats[cid] || [];
        let ids = cid.split('--').map(Number);
        
        let p1 = profiles.find(p => p.id === ids[0]);
        let p2 = profiles.find(p => p.id === ids[1]);
        let name1 = p1 ? p1.name : `ID:${ids[0]}`;
        let name2 = p2 ? p2.name : `ID:${ids[1]}`;

        // --- IDENTITY LOGIC ---
        // Simple: The NPC has the LOWER ID (NPCs are 1-500, Players are 500+)
        // So the admin should respond as the lower ID (the NPC)
        let npcId = Math.min(...ids);
        let playerId = Math.max(...ids);

        // Default: Admin responds as NPC
        currentReplyId = npcId;

        console.log('Chat opened:', cid, '| NPC:', npcId, '| Player:', playerId, '| Responding as:', currentReplyId);

        // Header Update
        document.getElementById('chat-view-head').innerHTML = `
            <div>
                <div style="font-size:14px;">${name1} <span style="color:#666">‚Üî</span> ${name2}</div>
                <div style="font-size:10px; color:#888; font-weight:normal;">ID: ${cid}</div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="small" onclick="openChatPopup('${cid}')" style="padding:4px 10px; background:var(--success); border-color:var(--success);">üì∫ Live</button>
                <button class="small" onclick="printCurrentChat()" style="padding:4px 10px;">üñ®Ô∏è Drucken</button>
            </div>
        `;

        // Input Context Update - Admin responds as NPC (fixed, no choice)
        let replyContext = document.getElementById('chat-reply-context');
        replyContext.style.display = 'flex';

        let npcProfile = profiles.find(x => x.id === npcId);
        let npcName = npcProfile ? npcProfile.name : `ID:${npcId}`;

        replyContext.innerHTML = `
            <span>Antworten als:</span>
            <select id="chat-sender-select" style="background:#111; color:var(--accent); border:1px solid #444; padding:2px 5px; font-weight:bold; font-size:11px;">
                <option value="${npcId}" selected>${npcName}</option>
            </select>
        `;

        let inp = document.getElementById('chat-input');
        inp.disabled = false;
        
        // Render Messages with the determined perspective
        renderChatMessages(msgs, ids, currentReplyId);
        
        // Set initial placeholder (updated by select change if needed)
        updateChatInputPlaceholder();
    }

    function updateChatInputPlaceholder() {
        let sel = document.getElementById('chat-sender-select');
        currentReplyId = parseInt(sel.value);
        let name = sel.options[sel.selectedIndex].text;
        let inp = document.getElementById('chat-input');
        inp.placeholder = `Nachricht als ${name}...`;
        
        // Re-render messages to update alignment based on new perspective
        if(currentChatConvoId) {
            let ids = currentChatConvoId.split('--').map(Number);
            let msgs = chats[currentChatConvoId] || [];
            renderChatMessages(msgs, ids, currentReplyId);
        }
    }

    function renderChatMessages(msgs, ids, perspectiveId) {
        let body = document.getElementById('chat-view-body');

        if (!msgs || msgs.length === 0) {
            body.innerHTML = '<div style="text-align:center; color:#666; padding:30px;">Keine Nachrichten</div>';
            return;
        }

        let html = '';
        let lastDate = null;

        msgs.forEach(m => {
            const msgDate = m.timestamp ? new Date(m.timestamp) : new Date();
            const dateStr = msgDate.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = msgDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            // Datum-Trenner einf√ºgen wenn neuer Tag
            if (dateStr !== lastDate) {
                html += `<div class="chat-date-separator"><span>${dateStr}</span></div>`;
                lastDate = dateStr;
            }

            let sender = profiles.find(p => p.id === m.fromId);
            let sName = sender ? sender.name : 'ID:'+m.fromId;

            let align = 'flex-start';
            let bgClass = 'chat-msg-in';
            let labelAlign = 'left';
            let timeAlign = 'left';

            if (m.fromId === perspectiveId) {
                align = 'flex-end';
                bgClass = 'chat-msg-out';
                labelAlign = 'right';
                timeAlign = 'right';
            } else if (m.fromId === 0 && !ids.includes(0)) {
                // Admin (ID 0) injected a message into a Player-to-Player chat
                align = 'center';
                bgClass = 'admin-msg-from-admin';
                labelAlign = 'center';
                timeAlign = 'center';
            }
            else if (m.fromId === 0 && ids.includes(0) && perspectiveId !== 0) {
                // Message from Admin (ID 0) in a chat that includes admin, but we are impersonating the other side
                align = 'flex-start';
                bgClass = 'chat-msg-in';
                labelAlign = 'left';
                sName = "Admin"; // Ensure correct sender label
            }

            html += `
                <div class="chat-msg-wrapper" style="align-self:${align};">
                    <div class="chat-sender-lbl" style="text-align:${labelAlign}">${sName}</div>
                    <div class="chat-msg ${bgClass}" style="${m.fromId===0 && !ids.includes(0) ? 'background:var(--danger);color:white;' : ''}">${m.text}</div>
                    <div class="chat-msg-time" style="text-align:${timeAlign}">${timeStr}</div>
                </div>
            `;
        });

        body.innerHTML = html;
        body.scrollTop = body.scrollHeight;
    }

    function sendAdminChat() {
        let inp = document.getElementById('chat-input');
        let text = inp.value.trim();
        if (!text || !currentChatConvoId) return;

        let ids = currentChatConvoId.split('--').map(Number);

        // Sender aus dem Select holen
        let sel = document.getElementById('chat-sender-select');
        let fromId = parseInt(sel.value);
        let toId = ids.find(id => id !== fromId);

        const fromProfile = profiles.find(p => p.id === fromId);
        const toProfile = profiles.find(p => p.id === toId);
        const fromName = fromProfile ? fromProfile.name : `ID:${fromId}`;
        const toName = toProfile ? toProfile.name : `ID:${toId}`;

        console.log('Sending message: from', fromId, 'to', toId, ':', text);

        if (ws && ws.readyState === 1) {
            ws.send(JSON.stringify({
                action: 'sendMessage',
                payload: { fromId: fromId, toId: toId, text: text }
            }));

            // Log: Nachricht gesendet
            addLog('SIM', `Nachricht von ${fromName} an ${toName}: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);

            inp.value = '';
        } else {
            showError("Keine Verbindung.");
        }
    }

    // --- NOTIFICATIONS ---
    let toastTimeout = null;

    function showToast(message) {
        let toast = document.getElementById('toast-notification');
        let text = document.getElementById('toast-text');
        if (!toast || !text) return;

        text.innerText = message;
        toast.style.display = 'block';

        // Clear previous timeout
        if (toastTimeout) clearTimeout(toastTimeout);

        // Hide after 3 seconds
        toastTimeout = setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    function updateNotifications(newMessage = null) {
        let reqCount = 0;
        if (profiles[0] && profiles[0].systemData && profiles[0].systemData.requests) {
            reqCount = profiles[0].systemData.requests.filter(r => r.status === 'pending').length;
        }

        let msgCount = unreadChats.size;
        let total = reqCount + msgCount;

        let badge = document.getElementById('bell-badge');
        if (badge) {
            if (total > 0) {
                badge.innerText = total;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show toast if there's a new message
        if (newMessage && Array.isArray(profiles)) {
            let sender = profiles.find(p => p.id === newMessage.fromId);
            let senderName = sender ? sender.name : `ID:${newMessage.fromId}`;
            showToast(`Neue Nachricht von ${senderName}`);
        }
    }

    let notificationHistory = [];

    function toggleNotifications() {
        const dropdown = document.getElementById('notifications-dropdown');
        if (dropdown.style.display === 'none') {
            renderNotificationsList();
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }

    function addNotification(type, message, data = {}) {
        notificationHistory.unshift({
            id: Date.now(),
            type,
            message,
            data,
            time: new Date().toISOString(),
            read: false
        });
        // Max 50 behalten
        if (notificationHistory.length > 50) notificationHistory = notificationHistory.slice(0, 50);
        updateNotificationBadge();
    }

    function renderNotificationsList() {
        const container = document.getElementById('notifications-list');
        const recent = notificationHistory.slice(0, 5);

        if (recent.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Keine neuen Benachrichtigungen</div>';
            return;
        }

        container.innerHTML = recent.map(n => {
            const time = new Date(n.time).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const date = new Date(n.time).toLocaleDateString('de-DE');
            let icon = 'üìå';
            let clickAction = '';

            if (n.type === 'message') {
                icon = 'üí¨';
                clickAction = `onclick="openChatFromNotification('${n.data.convoId}')"`;
            } else if (n.type === 'login') {
                icon = 'üü¢';
            } else if (n.type === 'logout') {
                icon = 'üî¥';
            } else if (n.type === 'edit') {
                icon = '‚úèÔ∏è';
            }

            return `
                <div style="padding:12px 15px; border-bottom:1px solid #222; cursor:pointer; transition:background 0.2s;"
                     ${clickAction}
                     onmouseover="this.style.background='#1a1a1a'"
                     onmouseout="this.style.background='transparent'">
                    <div style="display:flex; gap:10px; align-items:flex-start;">
                        <span style="font-size:16px;">${icon}</span>
                        <div style="flex:1;">
                            <div style="font-size:12px; color:#fff;">${n.message}</div>
                            <div style="font-size:10px; color:#666; margin-top:3px;">${date} ${time}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openChatFromNotification(convoId) {
        document.getElementById('notifications-dropdown').style.display = 'none';
        setView('chat');
        setTimeout(() => openChat(convoId), 100);
    }

    function clearNotifications() {
        notificationHistory = [];
        updateNotificationBadge();
        renderNotificationsList();
    }

    function updateNotificationBadge() {
        const badge = document.getElementById('bell-badge');
        const unreadCount = notificationHistory.filter(n => !n.read).length;
        if (unreadCount > 0) {
            badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    // Klick au√üerhalb schlie√üt Dropdown
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notifications-dropdown');
        const bellBtn = document.getElementById('bell-btn');
        if (dropdown && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    function checkPendingRequests() {
        updateNotifications();
    }

    function processPendingRequestsGUI() {
        let requests = profiles[0].systemData.requests.filter(r => r.status === 'pending');
        requests.forEach(r => {
            let t = profiles.find(p => p.id === r.to);
            let f = profiles.find(p => p.id === r.from);
            if(confirm(`Anfrage: ${f.name} -> ${t.name}\n\nGenehmigen?`)) {
                t.settings.isPrivate = false;
                if(!t.friends.includes(f.id)) t.friends.push(f.id);
                if(!f.friends.includes(t.id)) f.friends.push(t.id);
                r.status = 'approved_notify';
            } else {
                r.status = 'rejected';
            }
        });
        updateNotifications();
        syncDB();
    }

    // --- WEBSOCKET ---
    let ws = null;
    function initWebSocket() {
        if (ws) {
            try { ws.close(); } catch(e) {}
            ws = null;
        }
        ws = new WebSocket('ws://localhost:3004');
        ws.onopen = () => {
            console.log('WS Connected');
            // Make sure WebSocket is really open before sending
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'identify', payload: { profileId: 0 } }));
                loadDBFromServer();
            }
        };
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.action === 'dbPush') {
                    processDBPayload(msg.payload);
                    // Update connected clients list from server
                    if (msg.connectedClients) {
                        connectedClients.clear();
                        msg.connectedClients.forEach(id => connectedClients.set(id, true));
                        console.log('Connected clients updated:', Array.from(connectedClients.keys()));
                        // Aktualisiere Analyst-Liste wenn diese Ansicht aktiv ist
                        if (document.getElementById('analysts').classList.contains('active')) {
                            loadAnalysts();
                        }
                    }
                    // Ensure chat list is always re-rendered on dbPush if chat is active
                    if (document.getElementById('chat').classList.contains('active')) {
                        renderChatList();
                        if (currentChatConvoId) openChat(currentChatConvoId); // Re-render open chat
                    }
                    updateNotifications();
                }
                else if (msg.action === 'newMessage') {
                    const { convoId, message, isSimulation } = msg.payload;

                    if (!chats[convoId]) chats[convoId] = [];
                    chats[convoId].push(message);

                    // Absender und Empf√§nger ermitteln
                    const fromProfile = profiles.find(p => p.id === message.fromId);
                    const toProfile = profiles.find(p => p.id === message.toId);
                    const fromName = fromProfile ? fromProfile.name : `ID:${message.fromId}`;
                    const toName = toProfile ? toProfile.name : `ID:${message.toId}`;

                    // Benachrichtigung hinzuf√ºgen
                    addNotification('message', `${fromName} ‚Üí ${toName}: "${message.text.substring(0, 40)}${message.text.length > 40 ? '...' : ''}"`, { convoId, message });

                    // Log: Eingehende Nachricht (nur wenn von Analyst/Player)
                    if (fromProfile && fromProfile.isAnalyst) {
                        addLog('SIM', `Analyst ${fromName} schrieb an ${toName}: "${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}"`);
                    } else if (isSimulation) {
                        // Antwort auf Simulation
                        addLog('SIM', `Antwort von ${fromName} an ${toName}: "${message.text.substring(0, 50)}${message.text.length > 50 ? '...' : ''}"`);
                    }

                    // Check if user is viewing this chat right now
                    const chatTabActive = document.getElementById('chat')?.classList.contains('active');
                    const viewingThisChat = chatTabActive && currentChatConvoId === convoId;

                    // Show notification if not viewing this exact chat
                    if (!viewingThisChat) {
                        unreadChats.add(convoId);
                        showToast(`Neue Nachricht von ${fromName}`);
                    }

                    // Re-render chat list if on chat tab
                    if (chatTabActive) {
                        renderChatList();
                        if (currentChatConvoId === convoId) {
                            openChat(convoId); // Re-render the open chat
                        }
                    }
                }
            } catch (e) {
                console.error("Fehler bei der Verarbeitung der Server-Aktualisierung:", e);
                showError("Fehler: " + e.message + " (Zeile: " + (e.stack ? e.stack.split('\n')[1] : 'unbekannt') + ")");
            }
        };
        ws.onclose = () => {
            console.log("WS Closed");
            showError("Verbindung zum Server verloren.");
        };
        ws.onerror = (err) => {
            console.error("WS Error:", err);
            showError("Verbindungsfehler zum Server.");
        };
    }

    // Ensure initial DB load happens via REST then WS
    async function loadDBFromServer() {
        const loaderStatus = document.getElementById('loader-status');
        const loaderButtons = document.getElementById('loader-buttons');

        if (loaderStatus) loaderStatus.innerText = 'Verbinde mit Server...';
        if (loaderButtons) loaderButtons.style.display = 'none';

        try {
            const response = await fetch('/api/db');
            if (response.ok) {
                const db = await response.json();
                if (db && db.profiles && db.profiles.length > 0) {
                    if (loaderStatus) loaderStatus.innerText = 'Datenbank geladen!';
                    processDBPayload(db);
                } else {
                    // Leere DB - zeige Optionen
                    if (loaderStatus) loaderStatus.innerText = 'Keine Datenbank gefunden.';
                    if (loaderButtons) loaderButtons.style.display = 'flex';
                }
            } else {
                throw new Error('Server Error');
            }
        } catch (e) {
            console.log("Initial REST DB load failed:", e);
            if (loaderStatus) loaderStatus.innerText = 'Server nicht erreichbar.';
            if (loaderButtons) loaderButtons.style.display = 'flex';
        }
    }

    // --- BACKUP MANAGEMENT ---
    function openBackupModal() {
        document.getElementById('backup-modal').style.display = 'flex';
        loadBackupList();
    }

    async function loadBackupList() {
        const container = document.getElementById('backup-list');
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Lade Backups...</div>';

        try {
            const response = await fetch('/api/backups');
            if (!response.ok) throw new Error('Fehler beim Laden');
            const backups = await response.json();

            if (backups.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Keine Backups vorhanden.</div>';
                return;
            }

            let html = '';
            for (const backup of backups) {
                const date = new Date(backup.created).toLocaleString('de-DE');
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; border-bottom:1px solid #222;">
                        <div style="flex:1;">
                            <div style="font-size:13px; color:#fff;">${backup.filename}</div>
                            <div style="font-size:11px; color:#666; margin-top:3px;">${date} | ${backup.size}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="small success" onclick="loadBackup('${backup.filename}')">Laden</button>
                            <button class="small danger" onclick="deleteBackup('${backup.filename}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--danger);">Fehler beim Laden der Backups.</div>';
            console.error('Error loading backups:', e);
        }
    }

    async function createBackup() {
        const nameInput = document.getElementById('backup-name-input');
        const name = nameInput.value.trim();

        try {
            const response = await fetch('/api/backups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const data = await response.json();

            if (response.ok) {
                alert(`Backup erstellt: ${data.filename}`);
                nameInput.value = '';
                loadBackupList();
            } else {
                alert('Fehler: ' + data.message);
            }
        } catch (e) {
            alert('Fehler beim Erstellen des Backups.');
            console.error('Error creating backup:', e);
        }
    }

    async function loadBackup(filename) {
        if (!confirm(`Backup "${filename}" laden?\n\nDie aktuelle Datenbank wird √ºberschrieben!`)) return;

        try {
            const response = await fetch('/api/backups/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            });
            const data = await response.json();

            if (response.ok) {
                alert(`Backup "${filename}" geladen!`);
                document.getElementById('backup-modal').style.display = 'none';
                // DB wird automatisch √ºber WebSocket aktualisiert
            } else {
                alert('Fehler: ' + data.message);
            }
        } catch (e) {
            alert('Fehler beim Laden des Backups.');
            console.error('Error loading backup:', e);
        }
    }

    async function deleteBackup(filename) {
        if (!confirm(`Backup "${filename}" wirklich l√∂schen?`)) return;

        try {
            const response = await fetch(`/api/backups/${encodeURIComponent(filename)}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadBackupList();
            } else {
                const data = await response.json();
                alert('Fehler: ' + data.message);
            }
        } catch (e) {
            alert('Fehler beim L√∂schen des Backups.');
            console.error('Error deleting backup:', e);
        }
    }

    function importBackupFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const db = JSON.parse(e.target.result);
                if (db && db.profiles) {
                    processDBPayload(db);
                    syncDB();
                    document.getElementById('backup-modal').style.display = 'none';
                    alert('Datei importiert und als aktive Datenbank gesetzt.');
                } else {
                    alert('Ung√ºltiges Dateiformat.');
                }
            } catch (err) {
                alert('Fehler beim Lesen der Datei: ' + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    // --- CHAT POPUP (LIVE WINDOW) ---
    let chatPopups = {}; // Track open popup windows
    let chatPopupOffset = 0; // Offset counter for positioning

    function openChatPopup(convoId) {
        // Check if popup already exists and is still open
        if (chatPopups[convoId] && !chatPopups[convoId].closed) {
            chatPopups[convoId].focus();
            return;
        }

        const ids = convoId.split('--').map(Number);
        const p1 = profiles.find(p => p.id === ids[0]);
        const p2 = profiles.find(p => p.id === ids[1]);
        const name1 = p1?.name || `ID:${ids[0]}`;
        const name2 = p2?.name || `ID:${ids[1]}`;
        const title = `${name1} ‚Üî ${name2}`;

        // Calculate offset position (cascade effect)
        const baseLeft = 100;
        const baseTop = 100;
        const offsetStep = 30;
        const left = baseLeft + (chatPopupOffset * offsetStep);
        const top = baseTop + (chatPopupOffset * offsetStep);
        chatPopupOffset = (chatPopupOffset + 1) % 10; // Reset after 10 windows

        const popup = window.open('', `chat_${convoId}`, `width=450,height=600,left=${left},top=${top},resizable=yes,scrollbars=yes`);
        chatPopups[convoId] = popup;

        const networkName = meta?.networkName || 'MunsterNET';
        const wsUrl = `ws://${window.location.host}`;

        popup.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>üí¨ ${title} - Live Chat</title>
                <style>
                    :root { --bg: #0b0c0e; --card: #15171a; --text: #e4e6eb; --accent: #2d88ff; --success: #00e676; --border: #333; }
                    * { box-sizing: border-box; margin: 0; padding: 0; }
                    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

                    .header { background: var(--card); padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
                    .header-title { font-weight: bold; font-size: 14px; }
                    .header-subtitle { font-size: 10px; color: #888; margin-top: 2px; }
                    .header-status { display: flex; align-items: center; gap: 8px; }
                    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
                    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

                    .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }

                    .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; }
                    .msg-wrapper.left { align-self: flex-start; }
                    .msg-wrapper.right { align-self: flex-end; }

                    .msg-sender { font-size: 10px; color: #888; margin-bottom: 2px; padding: 0 8px; }
                    .msg-wrapper.right .msg-sender { text-align: right; }

                    .msg { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.4; }
                    .msg-wrapper.left .msg { background: #333; border-bottom-left-radius: 4px; }
                    .msg-wrapper.right .msg { background: var(--accent); border-bottom-right-radius: 4px; }

                    .msg-time { font-size: 9px; color: #666; margin-top: 3px; padding: 0 8px; }
                    .msg-wrapper.right .msg-time { text-align: right; }

                    .date-sep { text-align: center; margin: 15px 0; }
                    .date-sep span { background: var(--card); padding: 4px 12px; font-size: 10px; color: #888; border: 1px solid var(--border); border-radius: 10px; }

                    .new-msg { animation: highlight 2s ease-out; }
                    @keyframes highlight { 0% { background: rgba(0,230,118,0.3); } 100% { background: transparent; } }

                    .input-area { background: var(--card); padding: 10px; border-top: 1px solid var(--border); }
                    .reply-info { font-size: 10px; color: #888; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
                    .reply-as { color: var(--accent); font-weight: bold; }
                    .input-row { display: flex; gap: 8px; }
                    .input-row input { flex: 1; background: #222; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 20px; font-size: 13px; outline: none; }
                    .input-row input:focus { border-color: var(--accent); }
                    .input-row button { background: var(--accent); border: none; color: white; padding: 10px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; }
                    .input-row button:hover { background: #4499ff; }
                    .input-row button:disabled { background: #444; cursor: not-allowed; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div>
                        <div class="header-title">üí¨ ${title}</div>
                        <div class="header-subtitle">${networkName} | ID: ${convoId}</div>
                    </div>
                    <div class="header-status">
                        <div class="status-dot"></div>
                        <span style="font-size:11px; color:var(--success);">LIVE</span>
                    </div>
                </div>
                <div class="chat-body" id="chat-body"></div>
                <div class="input-area">
                    <div class="reply-info">
                        <span>Antworten als: <span class="reply-as" id="reply-as-name">...</span></span>
                        <span><span id="msg-count">0</span> Nachrichten</span>
                    </div>
                    <div class="input-row">
                        <input type="text" id="msg-input" placeholder="Nachricht eingeben..." onkeydown="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Senden</button>
                    </div>
                </div>

                <script>
                    const convoId = '${convoId}';
                    const ids = [${ids[0]}, ${ids[1]}];
                    let profiles = ${JSON.stringify(profiles.map(p => ({ id: p.id, name: p.name })))};
                    let messages = ${JSON.stringify(chats[convoId] || [])};
                    let ws;

                    // Admin responds as NPC (lower ID)
                    const replyAsId = Math.min(...ids);
                    const replyToId = Math.max(...ids);

                    function getName(id) {
                        const p = profiles.find(x => x.id === id);
                        return p ? p.name : 'ID:' + id;
                    }

                    function formatTime(ts) {
                        const d = new Date(ts);
                        return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    }

                    function formatDate(ts) {
                        return new Date(ts).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }

                    function renderMessages(highlight = false) {
                        const body = document.getElementById('chat-body');
                        let html = '';
                        let lastDate = '';

                        messages.forEach((m, idx) => {
                            const dateStr = formatDate(m.timestamp);
                            if (dateStr !== lastDate) {
                                html += '<div class="date-sep"><span>' + dateStr + '</span></div>';
                                lastDate = dateStr;
                            }

                            const isFirst = m.fromId === ids[0];
                            const isNew = highlight && idx === messages.length - 1;
                            html += '<div class="msg-wrapper ' + (isFirst ? 'left' : 'right') + (isNew ? ' new-msg' : '') + '">';
                            html += '<div class="msg-sender">' + getName(m.fromId) + '</div>';
                            html += '<div class="msg">' + m.text + '</div>';
                            html += '<div class="msg-time">' + formatTime(m.timestamp) + '</div>';
                            html += '</div>';
                        });

                        body.innerHTML = html;
                        body.scrollTop = body.scrollHeight;
                        document.getElementById('msg-count').textContent = messages.length;
                    }

                    function connectWS() {
                        ws = new WebSocket('${wsUrl}');

                        ws.onopen = () => {
                            console.log('Popup WebSocket connected');
                            ws.send(JSON.stringify({ action: 'identify', payload: { profileId: 0 } }));
                        };

                        ws.onmessage = (event) => {
                            try {
                                const msg = JSON.parse(event.data);
                                if (msg.action === 'newMessage') {
                                    const { convoId: cid, message } = msg.payload;
                                    if (cid === convoId) {
                                        messages.push(message);
                                        renderMessages(true);
                                        // Flash title
                                        document.title = 'üîî Neue Nachricht!';
                                        setTimeout(() => { document.title = 'üí¨ ${title} - Live Chat'; }, 3000);
                                    }
                                } else if (msg.action === 'dbPush') {
                                    // Update profiles
                                    if (msg.payload && msg.payload.profiles) {
                                        profiles = msg.payload.profiles.map(p => ({ id: p.id, name: p.name }));
                                    }
                                    if (msg.payload && msg.payload.chats && msg.payload.chats[convoId]) {
                                        messages = msg.payload.chats[convoId];
                                        renderMessages();
                                    }
                                }
                            } catch (e) { console.error(e); }
                        };

                        ws.onclose = () => {
                            console.log('Popup WebSocket closed, reconnecting...');
                            setTimeout(connectWS, 2000);
                        };
                    }

                    function sendMessage() {
                        const input = document.getElementById('msg-input');
                        const text = input.value.trim();
                        if (!text || !ws || ws.readyState !== 1) return;

                        ws.send(JSON.stringify({
                            action: 'sendMessage',
                            payload: {
                                fromId: replyAsId,
                                toId: replyToId,
                                text: text
                            }
                        }));

                        input.value = '';
                        input.focus();
                    }

                    // Initialize
                    document.getElementById('reply-as-name').textContent = getName(replyAsId);
                    renderMessages();
                    connectWS();
                <\/script>
            </body>
            </html>
        `);
        popup.document.close();
    }

    // --- CHAT PRINT FUNCTIONS ---
    function printCurrentChat() {
        if (!currentChatConvoId) return;

        const msgs = chats[currentChatConvoId] || [];
        const ids = currentChatConvoId.split('--').map(Number);
        const p1 = profiles.find(p => p.id === ids[0]);
        const p2 = profiles.find(p => p.id === ids[1]);
        const title = `Chat: ${p1?.name || ids[0]} ‚Üî ${p2?.name || ids[1]}`;

        openChatPrintWindow(title, [{ convoId: currentChatConvoId, messages: msgs, participants: [p1, p2] }]);
    }

    function printAllChats() {
        const allChats = [];

        for (let convoId in chats) {
            const msgs = chats[convoId];
            if (msgs.length === 0) continue;

            const ids = convoId.split('--').map(Number);
            const p1 = profiles.find(p => p.id === ids[0]);
            const p2 = profiles.find(p => p.id === ids[1]);

            allChats.push({
                convoId,
                messages: msgs,
                participants: [p1, p2],
                lastTime: new Date(msgs[msgs.length - 1].timestamp).getTime()
            });
        }

        // Nach letzter Nachricht sortieren
        allChats.sort((a, b) => b.lastTime - a.lastTime);

        openChatPrintWindow('Alle Chats - MunsterNET', allChats);
    }

    function getPrintHeader() {
        const networkName = meta?.networkName || 'MunsterNET';
        const exerciseName = meta?.exerciseName || '√úbung';
        const dateStr = new Date().toLocaleString('de-DE');

        return `
            <div class="print-header">
                <div class="print-header-top">
                    <div class="print-header-left">
                        <div class="print-logo">GHOST IN THE WIRE</div>
                        <div class="print-protocol">PROTOCOL</div>
                    </div>
                    <div class="print-page-number"></div>
                </div>
                <div class="print-header-info">
                    <div class="print-network"><span>NETZWERK:</span> ${networkName}</div>
                    <div class="print-operation"><span>OPERATION:</span> ${exerciseName}</div>
                    <div class="print-date"><span>ERSTELLT:</span> ${dateStr}</div>
                </div>
            </div>
            <div class="print-header-spacer"></div>
        `;
    }

    function getPrintStyles() {
        return `
            @page {
                margin-top: 100px;
                margin-bottom: 30px;
            }

            body { font-family: Arial, sans-serif; padding: 20px; background: white; color: black; margin: 0; padding-top: 100px; }

            .print-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: white;
                padding: 15px 20px;
                z-index: 99999;
            }
            .print-header-top { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 10px; }
            .print-header-left { display: flex; align-items: baseline; gap: 10px; }
            .print-logo { font-size: 20px; font-weight: bold; letter-spacing: 3px; }
            .print-protocol { font-size: 12px; color: #4da6ff; letter-spacing: 4px; border: 1px solid #4da6ff; padding: 2px 8px; }
            .print-page-number { font-size: 11px; color: #ccc; }
            .print-header-info { display: flex; gap: 20px; font-size: 11px; }
            .print-header-info span { color: #888; margin-right: 5px; }
            .print-network, .print-operation, .print-date { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 3px; }

            .print-header-spacer { height: 80px; }

            h1 { font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 20px; }
            h2 { font-size: 14px; background: #f0f0f0; padding: 10px; margin-top: 30px; border-left: 4px solid #007bff; }
            .chat-section { margin-bottom: 30px; page-break-inside: avoid; }
            .msg { padding: 8px 12px; margin: 5px 0; border-radius: 8px; max-width: 70%; }
            .msg-out { background: #e3f2fd; margin-left: 30%; text-align: right; }
            .msg-in { background: #f5f5f5; margin-right: 30%; }
            .msg-meta { font-size: 10px; color: #666; margin-top: 3px; }
            .msg-text { font-size: 13px; }
            .date-sep { text-align: center; color: #888; font-size: 11px; margin: 15px 0; border-top: 1px solid #ddd; padding-top: 10px; }
            .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #888; border-top: 1px solid #ddd; padding-top: 10px; }

            @media print {
                body { padding: 0; }
                .print-header { margin: 0 0 20px 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .no-print { display: none !important; }
            }
        `;
    }

    function openChatPrintWindow(title, chatData) {
        const printWin = window.open('', '_blank', 'width=800,height=600');

        let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${title}</title>
                <style>${getPrintStyles()}</style>
            </head>
            <body>
                ${getPrintHeader()}
                <h1>üí¨ ${title}</h1>
        `;

        for (const chat of chatData) {
            const p1Name = chat.participants[0]?.name || 'Unbekannt';
            const p2Name = chat.participants[1]?.name || 'Unbekannt';

            html += `<div class="chat-section">`;
            html += `<h2>üí¨ ${p1Name} ‚Üî ${p2Name} (${chat.messages.length} Nachrichten)</h2>`;

            let lastDate = '';
            for (const m of chat.messages) {
                const msgDate = new Date(m.timestamp);
                const dateStr = msgDate.toLocaleDateString('de-DE');
                const timeStr = msgDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

                if (dateStr !== lastDate) {
                    html += `<div class="date-sep">${dateStr}</div>`;
                    lastDate = dateStr;
                }

                const sender = profiles.find(p => p.id === m.fromId);
                const senderName = sender?.name || `ID:${m.fromId}`;
                const isFirst = m.fromId === chat.participants[0]?.id;

                html += `
                    <div class="msg ${isFirst ? 'msg-in' : 'msg-out'}">
                        <div class="msg-text">${m.text}</div>
                        <div class="msg-meta">${senderName} - ${timeStr}</div>
                    </div>
                `;
            }
            html += `</div>`;
        }

        html += `
                <div class="footer">MunsterNET Chat-Export | GHOST IN THE WIRE</div>
                <div class="no-print" style="margin-top:20px; text-align:center; padding:20px; background:#f5f5f5; border-radius:8px;">
                    <button onclick="window.print()" style="padding:10px 30px; font-size:14px; cursor:pointer; background:#2d88ff; color:white; border:none; border-radius:4px;">üñ®Ô∏è Drucken</button>
                    <button onclick="window.close()" style="padding:10px 30px; font-size:14px; cursor:pointer; margin-left:10px; background:#666; color:white; border:none; border-radius:4px;">Schlie√üen</button>
                </div>
            </body>
            </html>
        `;

        printWin.document.write(html);
        printWin.document.close();
    }

    // processDBPayload needs to be accessible globally
    function processDBPayload(db) {
        try {
            if (db && db.profiles && db.profiles.length > 0) {
                profiles = db.profiles;
                chats = db.chats || {};
                meta = (profiles[0] && profiles[0].meta) ? profiles[0].meta : { networkName: "MunsterNet", exerciseName: "Import", version: 1 };
                if (profiles[0]) {
                    systemLogs = (profiles[0].systemData && profiles[0].systemData.logs) ? profiles[0].systemData.logs : [];
                    detailGroups = (profiles[0].systemData && profiles[0].systemData.detailGroups) ? profiles[0].systemData.detailGroups : [];
                    detailComps = (profiles[0].systemData && profiles[0].systemData.detailComps) ? profiles[0].systemData.detailComps : [];
                }
            } else {
                profiles = [];
                chats = {};
            }

            // Loader verstecken und App initialisieren
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                initApp();
            } else {
                // UI aktualisieren wenn App bereits l√§uft
                updateSharedUI();
                const activeView = document.querySelector('.main.active')?.id || 'dash';
                setView(activeView);
            }
        } catch (e) {
            console.error('processDBPayload error:', e);
        }
    }

    function updateSharedUI() {
        try {
            const statInfo = document.getElementById('stat-info');
            if (!profiles || profiles.length === 0) {
                if (statInfo) statInfo.innerText = "NO DATA";
                return;
            }
            // updateBellUI(); // Handled by updateNotifications
            updateDBDropdowns();
            updateSocialStats();
            loadSocialSettings();
            updateCompanyTargetList();
            renderDetailGroupList();
            renderDetailCompList();
            if (statInfo) statInfo.innerText = `${profiles.length - 1} PROFILES | ${meta.networkName.toUpperCase()} | ${meta.exerciseName}`;
        } catch (e) {
            console.error('updateSharedUI error:', e);
        }
    }

    function initGeneratorUI() {
        // Render generator UI components that don't depend on DB data
        renderEthUI();
        renderCityList();
        renderAgeSliders();
        updateSelects();
    }

    // Main initialization on page load
    document.addEventListener('DOMContentLoaded', () => {
        checkWireLogin();
        initGeneratorUI();
        initWebSocket();
        // Automatisch Datenbank vom Server laden
        loadDBFromServer();
    });
</script>
</body>
</html>